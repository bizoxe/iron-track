<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>sqlalchemy.ext.associationproxy - IronTrack Docs</title><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=14737038" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sqlalchemy.ext.associationproxy"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../../index.html">
      <img class="light-logo" src="../../../_static/logo.svg" alt="irontrack" height="28" loading="lazy" />
      <img class="dark-logo" src="../../../_static/logo.svg" alt="irontrack" height="28" loading="lazy" />
      <strong>irontrack</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"><ul><li class="link"><a href="../../../usage/installation.html">Installation</a></li><li class="link"><a href="../../../api/index.html">API Reference</a></li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials">
  <a href="https://github.com/bizoxe/iron-track" aria-label="GitHub">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </a></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/index.html">Usage Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/development.html">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/cli-guide.html">CLI Guide</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/scripts/index.html">Application Scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/scripts/commands.html">User Management CLI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/scripts/seeder.html">Database Seeding Script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/server/index.html">Core Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/server/core.html">Server Core</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/config/index.html">Application Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/config/base.html">Base Settings Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/config/app_settings.html">SQLAlchemy and Dependency Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/config/constants.html">Application Constants</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/db/index.html">ORM Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/db/base.html">Base Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/db/user.html">User Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/db/role.html">Role Model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/lib/index.html">Core Utilities (lib)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/auth.html">JWT Cookie Security Scheme</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/cache_key_builders.html">Cache Key Builders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/coders.html">Cache Serialization Coders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/deps.html">Module Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/exceptions.html">API Exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/handlers.html">Exception Handlers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/invalidate_cache.html">Cache Invalidation Helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/json_response.html">Custom JSON Response</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/jwt_utils.html">JWT Utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/pretty_regex_error_msgs.html">Custom Regex Errors</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utils/index.html">Utilities and Helpers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils/log_utils/index.html">Structured Logging Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils/log_utils/handlers.html">Logging Handlers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils/log_utils/setup.html">Logging Setup and Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils/log_utils/middleware.html">ASGI Logging Middleware</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils/server_cli.html">Server CLI Commands</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/main.html">Entry Point (main.py)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/domain/index.html">Domains Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domain/users/index.html">Users Domain</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/controllers/access.html">Access Controllers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/controllers/users.html">User CRUD Controllers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/controllers/user_role.html">User Role Management Controllers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/services.html">User and Role Services</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/schemas.html">User Domain Schemas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/auth.html">Authentication Utilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/utils.html">User Utilities and Helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/deps.html">User Domain Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/jwt_helpers.html">JWT Token Utilities</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domain/system/index.html">System Domain</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/system/controllers.html">System Controllers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/system/schemas.html">System Domain Schemas</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contribution-guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../index.html"><span itemprop="name">irontrack</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">sqlalchemy.ext.associationproxy</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sqlalchemy.ext.associationproxy</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="c1"># ext/associationproxy.py</span>
</span><span data-line="2"><span class="c1"># Copyright (C) 2005-2025 the SQLAlchemy authors and contributors</span>
</span><span data-line="3"><span class="c1"># &lt;see AUTHORS file&gt;</span>
</span><span data-line="4"><span class="c1">#</span>
</span><span data-line="5"><span class="c1"># This module is part of SQLAlchemy and is released under</span>
</span><span data-line="6"><span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
</span><span data-line="7">
</span><span data-line="8"><span class="sd">&quot;&quot;&quot;Contain the ``AssociationProxy`` class.</span>
</span><span data-line="9">
</span><span data-line="10"><span class="sd">The ``AssociationProxy`` is a Python property object which provides</span>
</span><span data-line="11"><span class="sd">transparent proxied access to the endpoint of an association object.</span>
</span><span data-line="12">
</span><span data-line="13"><span class="sd">See the example ``examples/association/proxied_association.py``.</span>
</span><span data-line="14">
</span><span data-line="15"><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="16"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="17">
</span><span data-line="18"><span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
</span><span data-line="19"><span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>
</span><span data-line="20"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractSet</span>
</span><span data-line="21"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span data-line="22"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
</span><span data-line="23"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span>
</span><span data-line="24"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Collection</span>
</span><span data-line="25"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
</span><span data-line="26"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generic</span>
</span><span data-line="27"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">ItemsView</span>
</span><span data-line="28"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
</span><span data-line="29"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterator</span>
</span><span data-line="30"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">KeysView</span>
</span><span data-line="31"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</span><span data-line="32"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapping</span>
</span><span data-line="33"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MutableMapping</span>
</span><span data-line="34"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MutableSequence</span>
</span><span data-line="35"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MutableSet</span>
</span><span data-line="36"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NoReturn</span>
</span><span data-line="37"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span data-line="38"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">overload</span>
</span><span data-line="39"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Set</span>
</span><span data-line="40"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span>
</span><span data-line="41"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Type</span>
</span><span data-line="42"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeVar</span>
</span><span data-line="43"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span data-line="44"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValuesView</span>
</span><span data-line="45">
</span><span data-line="46"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnElement</span>
</span><span data-line="47"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">exc</span>
</span><span data-line="48"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspect</span>
</span><span data-line="49"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">orm</span>
</span><span data-line="50"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">util</span>
</span><span data-line="51"><span class="kn">from</span><span class="w"> </span><span class="nn">..orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">collections</span>
</span><span data-line="52"><span class="kn">from</span><span class="w"> </span><span class="nn">..orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">InspectionAttrExtensionType</span>
</span><span data-line="53"><span class="kn">from</span><span class="w"> </span><span class="nn">..orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">interfaces</span>
</span><span data-line="54"><span class="kn">from</span><span class="w"> </span><span class="nn">..orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">ORMDescriptor</span>
</span><span data-line="55"><span class="kn">from</span><span class="w"> </span><span class="nn">..orm.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLORMOperations</span>
</span><span data-line="56"><span class="kn">from</span><span class="w"> </span><span class="nn">..orm.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">_AttributeOptions</span>
</span><span data-line="57"><span class="kn">from</span><span class="w"> </span><span class="nn">..orm.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DCAttributeOptions</span>
</span><span data-line="58"><span class="kn">from</span><span class="w"> </span><span class="nn">..orm.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DEFAULT_ATTRIBUTE_OPTIONS</span>
</span><span data-line="59"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">operators</span>
</span><span data-line="60"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">or_</span>
</span><span data-line="61"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">_NoArg</span>
</span><span data-line="62"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
</span><span data-line="63"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Protocol</span>
</span><span data-line="64"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Self</span>
</span><span data-line="65"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">SupportsIndex</span>
</span><span data-line="66"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">SupportsKeysAndGetItem</span>
</span><span data-line="67">
</span><span data-line="68"><span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="69">    <span class="kn">from</span><span class="w"> </span><span class="nn">..orm.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">MapperProperty</span>
</span><span data-line="70">    <span class="kn">from</span><span class="w"> </span><span class="nn">..orm.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">PropComparator</span>
</span><span data-line="71">    <span class="kn">from</span><span class="w"> </span><span class="nn">..orm.mapper</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapper</span>
</span><span data-line="72">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_ColumnExpressionArgument</span>
</span><span data-line="73">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_InfoType</span>
</span><span data-line="74">
</span><span data-line="75">
</span><span data-line="76"><span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="77"><span class="n">_T_co</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T_co&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">,</span> <span class="n">covariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="78"><span class="n">_T_con</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T_con&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">,</span> <span class="n">contravariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="79"><span class="n">_S</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_S&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="80"><span class="n">_KT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_KT&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="81"><span class="n">_VT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_VT&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="82">
</span><span data-line="83">
</span><span data-line="84"><span class="k">def</span><span class="w"> </span><span class="nf">association_proxy</span><span class="p">(</span>
</span><span data-line="85">    <span class="n">target_collection</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="86">    <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="87">    <span class="o">*</span><span class="p">,</span>
</span><span data-line="88">    <span class="n">creator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CreatorProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="89">    <span class="n">getset_factory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_GetSetFactoryProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="90">    <span class="n">proxy_factory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ProxyFactoryProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="91">    <span class="n">proxy_bulk_set</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ProxyBulkSetProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="92">    <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="93">    <span class="n">cascade_scalar_deletes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="94">    <span class="n">create_on_none_assignment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="95">    <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="96">    <span class="nb">repr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span><span data-line="97">    <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="98">    <span class="n">default_factory</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">_T</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="99">    <span class="n">compare</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="100">    <span class="n">kw_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="101">    <span class="nb">hash</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span><span data-line="102">    <span class="n">dataclass_metadata</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="103"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssociationProxy</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="104"><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return a Python property implementing a view of a target</span>
</span><span data-line="105"><span class="sd">    attribute which references an attribute on members of the</span>
</span><span data-line="106"><span class="sd">    target.</span>
</span><span data-line="107">
</span><span data-line="108"><span class="sd">    The returned value is an instance of :class:`.AssociationProxy`.</span>
</span><span data-line="109">
</span><span data-line="110"><span class="sd">    Implements a Python property representing a relationship as a collection</span>
</span><span data-line="111"><span class="sd">    of simpler values, or a scalar value.  The proxied property will mimic</span>
</span><span data-line="112"><span class="sd">    the collection type of the target (list, dict or set), or, in the case of</span>
</span><span data-line="113"><span class="sd">    a one to one relationship, a simple scalar value.</span>
</span><span data-line="114">
</span><span data-line="115"><span class="sd">    :param target_collection: Name of the attribute that is the immediate</span>
</span><span data-line="116"><span class="sd">      target.  This attribute is typically mapped by</span>
</span><span data-line="117"><span class="sd">      :func:`~sqlalchemy.orm.relationship` to link to a target collection, but</span>
</span><span data-line="118"><span class="sd">      can also be a many-to-one or non-scalar relationship.</span>
</span><span data-line="119">
</span><span data-line="120"><span class="sd">    :param attr: Attribute on the associated instance or instances that</span>
</span><span data-line="121"><span class="sd">      are available on instances of the target object.</span>
</span><span data-line="122">
</span><span data-line="123"><span class="sd">    :param creator: optional.</span>
</span><span data-line="124">
</span><span data-line="125"><span class="sd">      Defines custom behavior when new items are added to the proxied</span>
</span><span data-line="126"><span class="sd">      collection.</span>
</span><span data-line="127">
</span><span data-line="128"><span class="sd">      By default, adding new items to the collection will trigger a</span>
</span><span data-line="129"><span class="sd">      construction of an instance of the target object, passing the given</span>
</span><span data-line="130"><span class="sd">      item as a positional argument to the target constructor.  For cases</span>
</span><span data-line="131"><span class="sd">      where this isn&#39;t sufficient, :paramref:`.association_proxy.creator`</span>
</span><span data-line="132"><span class="sd">      can supply a callable that will construct the object in the</span>
</span><span data-line="133"><span class="sd">      appropriate way, given the item that was passed.</span>
</span><span data-line="134">
</span><span data-line="135"><span class="sd">      For list- and set- oriented collections, a single argument is</span>
</span><span data-line="136"><span class="sd">      passed to the callable. For dictionary oriented collections, two</span>
</span><span data-line="137"><span class="sd">      arguments are passed, corresponding to the key and value.</span>
</span><span data-line="138">
</span><span data-line="139"><span class="sd">      The :paramref:`.association_proxy.creator` callable is also invoked</span>
</span><span data-line="140"><span class="sd">      for scalar (i.e. many-to-one, one-to-one) relationships. If the</span>
</span><span data-line="141"><span class="sd">      current value of the target relationship attribute is ``None``, the</span>
</span><span data-line="142"><span class="sd">      callable is used to construct a new object.  If an object value already</span>
</span><span data-line="143"><span class="sd">      exists, the given attribute value is populated onto that object.</span>
</span><span data-line="144">
</span><span data-line="145"><span class="sd">      .. seealso::</span>
</span><span data-line="146">
</span><span data-line="147"><span class="sd">        :ref:`associationproxy_creator`</span>
</span><span data-line="148">
</span><span data-line="149"><span class="sd">    :param cascade_scalar_deletes: when True, indicates that setting</span>
</span><span data-line="150"><span class="sd">        the proxied value to ``None``, or deleting it via ``del``, should</span>
</span><span data-line="151"><span class="sd">        also remove the source object.  Only applies to scalar attributes.</span>
</span><span data-line="152"><span class="sd">        Normally, removing the proxied target will not remove the proxy</span>
</span><span data-line="153"><span class="sd">        source, as this object may have other state that is still to be</span>
</span><span data-line="154"><span class="sd">        kept.</span>
</span><span data-line="155">
</span><span data-line="156"><span class="sd">        .. versionadded:: 1.3</span>
</span><span data-line="157">
</span><span data-line="158"><span class="sd">        .. seealso::</span>
</span><span data-line="159">
</span><span data-line="160"><span class="sd">            :ref:`cascade_scalar_deletes` - complete usage example</span>
</span><span data-line="161">
</span><span data-line="162"><span class="sd">    :param create_on_none_assignment: when True, indicates that setting</span>
</span><span data-line="163"><span class="sd">      the proxied value to ``None`` should **create** the source object</span>
</span><span data-line="164"><span class="sd">      if it does not exist, using the creator.  Only applies to scalar</span>
</span><span data-line="165"><span class="sd">      attributes.  This is mutually exclusive</span>
</span><span data-line="166"><span class="sd">      vs. the :paramref:`.assocation_proxy.cascade_scalar_deletes`.</span>
</span><span data-line="167">
</span><span data-line="168"><span class="sd">      .. versionadded:: 2.0.18</span>
</span><span data-line="169">
</span><span data-line="170"><span class="sd">    :param init: Specific to :ref:`orm_declarative_native_dataclasses`,</span>
</span><span data-line="171"><span class="sd">     specifies if the mapped attribute should be part of the ``__init__()``</span>
</span><span data-line="172"><span class="sd">     method as generated by the dataclass process.</span>
</span><span data-line="173">
</span><span data-line="174"><span class="sd">     .. versionadded:: 2.0.0b4</span>
</span><span data-line="175">
</span><span data-line="176"><span class="sd">    :param repr: Specific to :ref:`orm_declarative_native_dataclasses`,</span>
</span><span data-line="177"><span class="sd">     specifies if the attribute established by this :class:`.AssociationProxy`</span>
</span><span data-line="178"><span class="sd">     should be part of the ``__repr__()`` method as generated by the dataclass</span>
</span><span data-line="179"><span class="sd">     process.</span>
</span><span data-line="180">
</span><span data-line="181"><span class="sd">     .. versionadded:: 2.0.0b4</span>
</span><span data-line="182">
</span><span data-line="183"><span class="sd">    :param default_factory: Specific to</span>
</span><span data-line="184"><span class="sd">     :ref:`orm_declarative_native_dataclasses`, specifies a default-value</span>
</span><span data-line="185"><span class="sd">     generation function that will take place as part of the ``__init__()``</span>
</span><span data-line="186"><span class="sd">     method as generated by the dataclass process.</span>
</span><span data-line="187">
</span><span data-line="188"><span class="sd">     .. versionadded:: 2.0.0b4</span>
</span><span data-line="189">
</span><span data-line="190"><span class="sd">    :param compare: Specific to</span>
</span><span data-line="191"><span class="sd">     :ref:`orm_declarative_native_dataclasses`, indicates if this field</span>
</span><span data-line="192"><span class="sd">     should be included in comparison operations when generating the</span>
</span><span data-line="193"><span class="sd">     ``__eq__()`` and ``__ne__()`` methods for the mapped class.</span>
</span><span data-line="194">
</span><span data-line="195"><span class="sd">     .. versionadded:: 2.0.0b4</span>
</span><span data-line="196">
</span><span data-line="197"><span class="sd">    :param kw_only: Specific to :ref:`orm_declarative_native_dataclasses`,</span>
</span><span data-line="198"><span class="sd">     indicates if this field should be marked as keyword-only when generating</span>
</span><span data-line="199"><span class="sd">     the ``__init__()`` method as generated by the dataclass process.</span>
</span><span data-line="200">
</span><span data-line="201"><span class="sd">     .. versionadded:: 2.0.0b4</span>
</span><span data-line="202">
</span><span data-line="203"><span class="sd">    :param hash: Specific to</span>
</span><span data-line="204"><span class="sd">     :ref:`orm_declarative_native_dataclasses`, controls if this field</span>
</span><span data-line="205"><span class="sd">     is included when generating the ``__hash__()`` method for the mapped</span>
</span><span data-line="206"><span class="sd">     class.</span>
</span><span data-line="207">
</span><span data-line="208"><span class="sd">     .. versionadded:: 2.0.36</span>
</span><span data-line="209">
</span><span data-line="210"><span class="sd">    :param dataclass_metadata: Specific to</span>
</span><span data-line="211"><span class="sd">     :ref:`orm_declarative_native_dataclasses`, supplies metadata</span>
</span><span data-line="212"><span class="sd">     to be attached to the generated dataclass field.</span>
</span><span data-line="213">
</span><span data-line="214"><span class="sd">     .. versionadded:: 2.0.42</span>
</span><span data-line="215">
</span><span data-line="216"><span class="sd">    :param info: optional, will be assigned to</span>
</span><span data-line="217"><span class="sd">     :attr:`.AssociationProxy.info` if present.</span>
</span><span data-line="218">
</span><span data-line="219">
</span><span data-line="220"><span class="sd">    The following additional parameters involve injection of custom behaviors</span>
</span><span data-line="221"><span class="sd">    within the :class:`.AssociationProxy` object and are for advanced use</span>
</span><span data-line="222"><span class="sd">    only:</span>
</span><span data-line="223">
</span><span data-line="224"><span class="sd">    :param getset_factory: Optional.  Proxied attribute access is</span>
</span><span data-line="225"><span class="sd">        automatically handled by routines that get and set values based on</span>
</span><span data-line="226"><span class="sd">        the `attr` argument for this proxy.</span>
</span><span data-line="227">
</span><span data-line="228"><span class="sd">        If you would like to customize this behavior, you may supply a</span>
</span><span data-line="229"><span class="sd">        `getset_factory` callable that produces a tuple of `getter` and</span>
</span><span data-line="230"><span class="sd">        `setter` functions.  The factory is called with two arguments, the</span>
</span><span data-line="231"><span class="sd">        abstract type of the underlying collection and this proxy instance.</span>
</span><span data-line="232">
</span><span data-line="233"><span class="sd">    :param proxy_factory: Optional.  The type of collection to emulate is</span>
</span><span data-line="234"><span class="sd">        determined by sniffing the target collection.  If your collection</span>
</span><span data-line="235"><span class="sd">        type can&#39;t be determined by duck typing or you&#39;d like to use a</span>
</span><span data-line="236"><span class="sd">        different collection implementation, you may supply a factory</span>
</span><span data-line="237"><span class="sd">        function to produce those collections.  Only applicable to</span>
</span><span data-line="238"><span class="sd">        non-scalar relationships.</span>
</span><span data-line="239">
</span><span data-line="240"><span class="sd">    :param proxy_bulk_set: Optional, use with proxy_factory.</span>
</span><span data-line="241">
</span><span data-line="242">
</span><span data-line="243"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="244">    <span class="k">return</span> <span class="n">AssociationProxy</span><span class="p">(</span>
</span><span data-line="245">        <span class="n">target_collection</span><span class="p">,</span>
</span><span data-line="246">        <span class="n">attr</span><span class="p">,</span>
</span><span data-line="247">        <span class="n">creator</span><span class="o">=</span><span class="n">creator</span><span class="p">,</span>
</span><span data-line="248">        <span class="n">getset_factory</span><span class="o">=</span><span class="n">getset_factory</span><span class="p">,</span>
</span><span data-line="249">        <span class="n">proxy_factory</span><span class="o">=</span><span class="n">proxy_factory</span><span class="p">,</span>
</span><span data-line="250">        <span class="n">proxy_bulk_set</span><span class="o">=</span><span class="n">proxy_bulk_set</span><span class="p">,</span>
</span><span data-line="251">        <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
</span><span data-line="252">        <span class="n">cascade_scalar_deletes</span><span class="o">=</span><span class="n">cascade_scalar_deletes</span><span class="p">,</span>
</span><span data-line="253">        <span class="n">create_on_none_assignment</span><span class="o">=</span><span class="n">create_on_none_assignment</span><span class="p">,</span>
</span><span data-line="254">        <span class="n">attribute_options</span><span class="o">=</span><span class="n">_AttributeOptions</span><span class="p">(</span>
</span><span data-line="255">            <span class="n">init</span><span class="p">,</span>
</span><span data-line="256">            <span class="nb">repr</span><span class="p">,</span>
</span><span data-line="257">            <span class="n">default</span><span class="p">,</span>
</span><span data-line="258">            <span class="n">default_factory</span><span class="p">,</span>
</span><span data-line="259">            <span class="n">compare</span><span class="p">,</span>
</span><span data-line="260">            <span class="n">kw_only</span><span class="p">,</span>
</span><span data-line="261">            <span class="nb">hash</span><span class="p">,</span>
</span><span data-line="262">            <span class="n">dataclass_metadata</span><span class="p">,</span>
</span><span data-line="263">        <span class="p">),</span>
</span><span data-line="264">    <span class="p">)</span>
</span><span data-line="265">
</span><span data-line="266">
</span><span data-line="267"><span class="k">class</span><span class="w"> </span><span class="nc">AssociationProxyExtensionType</span><span class="p">(</span><span class="n">InspectionAttrExtensionType</span><span class="p">):</span>
</span><span data-line="268">    <span class="n">ASSOCIATION_PROXY</span> <span class="o">=</span> <span class="s2">&quot;ASSOCIATION_PROXY&quot;</span>
</span><span data-line="269"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Symbol indicating an :class:`.InspectionAttr` that&#39;s</span>
</span><span data-line="270"><span class="sd">    of type :class:`.AssociationProxy`.</span>
</span><span data-line="271">
</span><span data-line="272"><span class="sd">    Is assigned to the :attr:`.InspectionAttr.extension_type`</span>
</span><span data-line="273"><span class="sd">    attribute.</span>
</span><span data-line="274">
</span><span data-line="275"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="276">
</span><span data-line="277">
</span><span data-line="278"><span class="k">class</span><span class="w"> </span><span class="nc">_GetterProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]):</span>
</span><span data-line="279">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T_co</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="280">
</span><span data-line="281">
</span><span data-line="282"><span class="c1"># mypy 0.990 we are no longer allowed to make this Protocol[_T_con]</span>
</span><span data-line="283"><span class="k">class</span><span class="w"> </span><span class="nc">_SetterProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span> <span class="o">...</span>
</span><span data-line="284">
</span><span data-line="285">
</span><span data-line="286"><span class="k">class</span><span class="w"> </span><span class="nc">_PlainSetterProtocol</span><span class="p">(</span><span class="n">_SetterProtocol</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">[</span><span class="n">_T_con</span><span class="p">]):</span>
</span><span data-line="287">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T_con</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="288">
</span><span data-line="289">
</span><span data-line="290"><span class="k">class</span><span class="w"> </span><span class="nc">_DictSetterProtocol</span><span class="p">(</span><span class="n">_SetterProtocol</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">[</span><span class="n">_T_con</span><span class="p">]):</span>
</span><span data-line="291">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T_con</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="292">
</span><span data-line="293">
</span><span data-line="294"><span class="c1"># mypy 0.990 we are no longer allowed to make this Protocol[_T_con]</span>
</span><span data-line="295"><span class="k">class</span><span class="w"> </span><span class="nc">_CreatorProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span> <span class="o">...</span>
</span><span data-line="296">
</span><span data-line="297">
</span><span data-line="298"><span class="k">class</span><span class="w"> </span><span class="nc">_PlainCreatorProtocol</span><span class="p">(</span><span class="n">_CreatorProtocol</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">[</span><span class="n">_T_con</span><span class="p">]):</span>
</span><span data-line="299">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T_con</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="300">
</span><span data-line="301">
</span><span data-line="302"><span class="k">class</span><span class="w"> </span><span class="nc">_KeyCreatorProtocol</span><span class="p">(</span><span class="n">_CreatorProtocol</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">[</span><span class="n">_T_con</span><span class="p">]):</span>
</span><span data-line="303">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_T_con</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="304">
</span><span data-line="305">
</span><span data-line="306"><span class="k">class</span><span class="w"> </span><span class="nc">_LazyCollectionProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="307">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
</span><span data-line="308">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="309">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="310">        <span class="n">MutableSet</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">_T</span><span class="p">],</span> <span class="n">MutableSequence</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span>
</span><span data-line="311">    <span class="p">]:</span> <span class="o">...</span>
</span><span data-line="312">
</span><span data-line="313">
</span><span data-line="314"><span class="k">class</span><span class="w"> </span><span class="nc">_GetSetFactoryProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
</span><span data-line="315">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
</span><span data-line="316">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="317">        <span class="n">collection_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="318">        <span class="n">assoc_instance</span><span class="p">:</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="319">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">_GetterProtocol</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">_SetterProtocol</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="320">
</span><span data-line="321">
</span><span data-line="322"><span class="k">class</span><span class="w"> </span><span class="nc">_ProxyFactoryProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
</span><span data-line="323">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
</span><span data-line="324">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="325">        <span class="n">lazy_collection</span><span class="p">:</span> <span class="n">_LazyCollectionProtocol</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="326">        <span class="n">creator</span><span class="p">:</span> <span class="n">_CreatorProtocol</span><span class="p">,</span>
</span><span data-line="327">        <span class="n">value_attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="328">        <span class="n">parent</span><span class="p">:</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="329">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="330">
</span><span data-line="331">
</span><span data-line="332"><span class="k">class</span><span class="w"> </span><span class="nc">_ProxyBulkSetProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
</span><span data-line="333">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
</span><span data-line="334">        <span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">:</span> <span class="n">_AssociationCollection</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">collection</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="335">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="336">
</span><span data-line="337">
</span><span data-line="338"><span class="k">class</span><span class="w"> </span><span class="nc">_AssociationProxyProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="339"><span class="w">    </span><span class="sd">&quot;&quot;&quot;describes the interface of :class:`.AssociationProxy`</span>
</span><span data-line="340"><span class="sd">    without including descriptor methods in the interface.&quot;&quot;&quot;</span>
</span><span data-line="341">
</span><span data-line="342">    <span class="n">creator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CreatorProtocol</span><span class="p">]</span>
</span><span data-line="343">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="344">    <span class="n">target_collection</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="345">    <span class="n">value_attr</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="346">    <span class="n">cascade_scalar_deletes</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="347">    <span class="n">create_on_none_assignment</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="348">    <span class="n">getset_factory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_GetSetFactoryProtocol</span><span class="p">]</span>
</span><span data-line="349">    <span class="n">proxy_factory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ProxyFactoryProtocol</span><span class="p">]</span>
</span><span data-line="350">    <span class="n">proxy_bulk_set</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ProxyBulkSetProtocol</span><span class="p">]</span>
</span><span data-line="351">
</span><span data-line="352">    <span class="nd">@util</span><span class="o">.</span><span class="n">ro_memoized_property</span>
</span><span data-line="353">    <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_InfoType</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="354">
</span><span data-line="355">    <span class="k">def</span><span class="w"> </span><span class="nf">for_class</span><span class="p">(</span>
</span><span data-line="356">        <span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="357">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="358">
</span><span data-line="359">    <span class="k">def</span><span class="w"> </span><span class="nf">_default_getset</span><span class="p">(</span>
</span><span data-line="360">        <span class="bp">self</span><span class="p">,</span> <span class="n">collection_class</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="361">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">_GetterProtocol</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">_SetterProtocol</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="362">
</span><span data-line="363">
</span><span data-line="364"><span class="k">class</span><span class="w"> </span><span class="nc">AssociationProxy</span><span class="p">(</span>
</span><span data-line="365">    <span class="n">interfaces</span><span class="o">.</span><span class="n">InspectionAttrInfo</span><span class="p">,</span>
</span><span data-line="366">    <span class="n">ORMDescriptor</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="367">    <span class="n">_DCAttributeOptions</span><span class="p">,</span>
</span><span data-line="368">    <span class="n">_AssociationProxyProtocol</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="369"><span class="p">):</span>
</span><span data-line="370"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A descriptor that presents a read/write view of an object attribute.&quot;&quot;&quot;</span>
</span><span data-line="371">
</span><span data-line="372">    <span class="n">is_attribute</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="373">    <span class="n">extension_type</span> <span class="o">=</span> <span class="n">AssociationProxyExtensionType</span><span class="o">.</span><span class="n">ASSOCIATION_PROXY</span>
</span><span data-line="374">
</span><span data-line="375">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="376">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="377">        <span class="n">target_collection</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="378">        <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="379">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="380">        <span class="n">creator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CreatorProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="381">        <span class="n">getset_factory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_GetSetFactoryProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="382">        <span class="n">proxy_factory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ProxyFactoryProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="383">        <span class="n">proxy_bulk_set</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ProxyBulkSetProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="384">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="385">        <span class="n">cascade_scalar_deletes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="386">        <span class="n">create_on_none_assignment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="387">        <span class="n">attribute_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AttributeOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="388">    <span class="p">):</span>
</span><span data-line="389"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a new :class:`.AssociationProxy`.</span>
</span><span data-line="390">
</span><span data-line="391"><span class="sd">        The :class:`.AssociationProxy` object is typically constructed using</span>
</span><span data-line="392"><span class="sd">        the :func:`.association_proxy` constructor function. See the</span>
</span><span data-line="393"><span class="sd">        description of :func:`.association_proxy` for a description of all</span>
</span><span data-line="394"><span class="sd">        parameters.</span>
</span><span data-line="395">
</span><span data-line="396">
</span><span data-line="397"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="398">        <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span> <span class="o">=</span> <span class="n">target_collection</span>
</span><span data-line="399">        <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span> <span class="o">=</span> <span class="n">attr</span>
</span><span data-line="400">        <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">creator</span>
</span><span data-line="401">        <span class="bp">self</span><span class="o">.</span><span class="n">getset_factory</span> <span class="o">=</span> <span class="n">getset_factory</span>
</span><span data-line="402">        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_factory</span> <span class="o">=</span> <span class="n">proxy_factory</span>
</span><span data-line="403">        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_bulk_set</span> <span class="o">=</span> <span class="n">proxy_bulk_set</span>
</span><span data-line="404">
</span><span data-line="405">        <span class="k">if</span> <span class="n">cascade_scalar_deletes</span> <span class="ow">and</span> <span class="n">create_on_none_assignment</span><span class="p">:</span>
</span><span data-line="406">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="407">                <span class="s2">&quot;The cascade_scalar_deletes and create_on_none_assignment &quot;</span>
</span><span data-line="408">                <span class="s2">&quot;parameters are mutually exclusive.&quot;</span>
</span><span data-line="409">            <span class="p">)</span>
</span><span data-line="410">        <span class="bp">self</span><span class="o">.</span><span class="n">cascade_scalar_deletes</span> <span class="o">=</span> <span class="n">cascade_scalar_deletes</span>
</span><span data-line="411">        <span class="bp">self</span><span class="o">.</span><span class="n">create_on_none_assignment</span> <span class="o">=</span> <span class="n">create_on_none_assignment</span>
</span><span data-line="412">
</span><span data-line="413">        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span data-line="414">            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="415">            <span class="n">target_collection</span><span class="p">,</span>
</span><span data-line="416">            <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
</span><span data-line="417">        <span class="p">)</span>
</span><span data-line="418">        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
</span><span data-line="419">            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>  <span class="c1"># type: ignore</span>
</span><span data-line="420">
</span><span data-line="421">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="422">            <span class="n">attribute_options</span>
</span><span data-line="423">            <span class="ow">and</span> <span class="n">attribute_options</span> <span class="o">!=</span> <span class="n">_DEFAULT_ATTRIBUTE_OPTIONS</span>
</span><span data-line="424">        <span class="p">):</span>
</span><span data-line="425">            <span class="bp">self</span><span class="o">.</span><span class="n">_has_dataclass_arguments</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="426">            <span class="bp">self</span><span class="o">.</span><span class="n">_attribute_options</span> <span class="o">=</span> <span class="n">attribute_options</span>
</span><span data-line="427">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="428">            <span class="bp">self</span><span class="o">.</span><span class="n">_has_dataclass_arguments</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="429">            <span class="bp">self</span><span class="o">.</span><span class="n">_attribute_options</span> <span class="o">=</span> <span class="n">_DEFAULT_ATTRIBUTE_OPTIONS</span>
</span><span data-line="430">
</span><span data-line="431">    <span class="nd">@overload</span>
</span><span data-line="432">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span>
</span><span data-line="433">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
</span><span data-line="434">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="435">
</span><span data-line="436">    <span class="nd">@overload</span>
</span><span data-line="437">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span>
</span><span data-line="438">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="439">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="440">
</span><span data-line="441">    <span class="nd">@overload</span>
</span><span data-line="442">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="443">
</span><span data-line="444">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span>
</span><span data-line="445">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="446">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">_T</span><span class="p">,</span> <span class="n">AssociationProxy</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span data-line="447">        <span class="k">if</span> <span class="n">owner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="448">            <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="449">        <span class="n">inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_instance</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span data-line="450">        <span class="k">if</span> <span class="n">inst</span><span class="p">:</span>
</span><span data-line="451">            <span class="k">return</span> <span class="n">inst</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="452">
</span><span data-line="453">        <span class="k">assert</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="454">
</span><span data-line="455">        <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="456">
</span><span data-line="457">    <span class="k">def</span><span class="w"> </span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="458">        <span class="n">class_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="459">        <span class="bp">self</span><span class="o">.</span><span class="n">_as_instance</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</span><span data-line="460">
</span><span data-line="461">    <span class="k">def</span><span class="w"> </span><span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="462">        <span class="n">class_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="463">        <span class="bp">self</span><span class="o">.</span><span class="n">_as_instance</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="464">
</span><span data-line="465">    <span class="k">def</span><span class="w"> </span><span class="nf">for_class</span><span class="p">(</span>
</span><span data-line="466">        <span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="467">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="468"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the internal state local to a specific mapped class.</span>
</span><span data-line="469">
</span><span data-line="470"><span class="sd">        E.g., given a class ``User``::</span>
</span><span data-line="471">
</span><span data-line="472"><span class="sd">            class User(Base):</span>
</span><span data-line="473"><span class="sd">                # ...</span>
</span><span data-line="474">
</span><span data-line="475"><span class="sd">                keywords = association_proxy(&quot;kws&quot;, &quot;keyword&quot;)</span>
</span><span data-line="476">
</span><span data-line="477"><span class="sd">        If we access this :class:`.AssociationProxy` from</span>
</span><span data-line="478"><span class="sd">        :attr:`_orm.Mapper.all_orm_descriptors`, and we want to view the</span>
</span><span data-line="479"><span class="sd">        target class for this proxy as mapped by ``User``::</span>
</span><span data-line="480">
</span><span data-line="481"><span class="sd">            inspect(User).all_orm_descriptors[&quot;keywords&quot;].for_class(User).target_class</span>
</span><span data-line="482">
</span><span data-line="483"><span class="sd">        This returns an instance of :class:`.AssociationProxyInstance` that</span>
</span><span data-line="484"><span class="sd">        is specific to the ``User`` class.   The :class:`.AssociationProxy`</span>
</span><span data-line="485"><span class="sd">        object remains agnostic of its parent class.</span>
</span><span data-line="486">
</span><span data-line="487"><span class="sd">        :param class\_: the class that we are returning state for.</span>
</span><span data-line="488">
</span><span data-line="489"><span class="sd">        :param obj: optional, an instance of the class that is required</span>
</span><span data-line="490"><span class="sd">         if the attribute refers to a polymorphic target, e.g. where we have</span>
</span><span data-line="491"><span class="sd">         to look at the type of the actual destination object to get the</span>
</span><span data-line="492"><span class="sd">         complete path.</span>
</span><span data-line="493">
</span><span data-line="494"><span class="sd">        .. versionadded:: 1.3 - :class:`.AssociationProxy` no longer stores</span>
</span><span data-line="495"><span class="sd">           any state specific to a particular parent class; the state is now</span>
</span><span data-line="496"><span class="sd">           stored in per-class :class:`.AssociationProxyInstance` objects.</span>
</span><span data-line="497">
</span><span data-line="498">
</span><span data-line="499"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="500">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_instance</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="501">
</span><span data-line="502">    <span class="k">def</span><span class="w"> </span><span class="nf">_as_instance</span><span class="p">(</span>
</span><span data-line="503">        <span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="504">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="505">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="506">            <span class="n">inst</span> <span class="o">=</span> <span class="n">class_</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_inst&quot;</span><span class="p">]</span>
</span><span data-line="507">        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span data-line="508">            <span class="n">inst</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="509">
</span><span data-line="510">        <span class="c1"># avoid exception context</span>
</span><span data-line="511">        <span class="k">if</span> <span class="n">inst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="512">            <span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_owner</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
</span><span data-line="513">            <span class="k">if</span> <span class="n">owner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="514">                <span class="n">inst</span> <span class="o">=</span> <span class="n">AssociationProxyInstance</span><span class="o">.</span><span class="n">for_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="515">                <span class="nb">setattr</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_inst&quot;</span><span class="p">,</span> <span class="n">inst</span><span class="p">)</span>
</span><span data-line="516">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="517">                <span class="n">inst</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="518">
</span><span data-line="519">        <span class="k">if</span> <span class="n">inst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inst</span><span class="o">.</span><span class="n">_is_canonical</span><span class="p">:</span>
</span><span data-line="520">            <span class="c1"># the AssociationProxyInstance can&#39;t be generalized</span>
</span><span data-line="521">            <span class="c1"># since the proxied attribute is not on the targeted</span>
</span><span data-line="522">            <span class="c1"># class, only on subclasses of it, which might be</span>
</span><span data-line="523">            <span class="c1"># different.  only return for the specific</span>
</span><span data-line="524">            <span class="c1"># object&#39;s current value</span>
</span><span data-line="525">            <span class="k">return</span> <span class="n">inst</span><span class="o">.</span><span class="n">_non_canonical_get_for_object</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span data-line="526">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="527">            <span class="k">return</span> <span class="n">inst</span>  <span class="c1"># type: ignore  # TODO</span>
</span><span data-line="528">
</span><span data-line="529">    <span class="k">def</span><span class="w"> </span><span class="nf">_calc_owner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_cls</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="530">        <span class="c1"># we might be getting invoked for a subclass</span>
</span><span data-line="531">        <span class="c1"># that is not mapped yet, in some declarative situations.</span>
</span><span data-line="532">        <span class="c1"># save until we are mapped</span>
</span><span data-line="533">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="534">            <span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">target_cls</span><span class="p">)</span>
</span><span data-line="535">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NoInspectionAvailable</span><span class="p">:</span>
</span><span data-line="536">            <span class="c1"># can&#39;t find a mapper, don&#39;t set owner. if we are a not-yet-mapped</span>
</span><span data-line="537">            <span class="c1"># subclass, we can also scan through __mro__ to find a mapped</span>
</span><span data-line="538">            <span class="c1"># class, but instead just wait for us to be called again against a</span>
</span><span data-line="539">            <span class="c1"># mapped class normally.</span>
</span><span data-line="540">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="541">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="542">            <span class="k">return</span> <span class="n">insp</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_manager</span><span class="o">.</span><span class="n">class_</span>
</span><span data-line="543">
</span><span data-line="544">    <span class="k">def</span><span class="w"> </span><span class="nf">_default_getset</span><span class="p">(</span>
</span><span data-line="545">        <span class="bp">self</span><span class="p">,</span> <span class="n">collection_class</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="546">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">_GetterProtocol</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">_SetterProtocol</span><span class="p">]:</span>
</span><span data-line="547">        <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span>
</span><span data-line="548">        <span class="n">_getter</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
</span><span data-line="549">
</span><span data-line="550">        <span class="k">def</span><span class="w"> </span><span class="nf">getter</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="551">            <span class="k">return</span> <span class="n">_getter</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span data-line="552">
</span><span data-line="553">        <span class="k">if</span> <span class="n">collection_class</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span><span data-line="554">
</span><span data-line="555">            <span class="k">def</span><span class="w"> </span><span class="nf">dict_setter</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="556">                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="557">
</span><span data-line="558">            <span class="k">return</span> <span class="n">getter</span><span class="p">,</span> <span class="n">dict_setter</span>
</span><span data-line="559">
</span><span data-line="560">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="561">
</span><span data-line="562">            <span class="k">def</span><span class="w"> </span><span class="nf">plain_setter</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="563">                <span class="nb">setattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span data-line="564">
</span><span data-line="565">            <span class="k">return</span> <span class="n">getter</span><span class="p">,</span> <span class="n">plain_setter</span>
</span><span data-line="566">
</span><span data-line="567">    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="568">        <span class="k">return</span> <span class="s2">&quot;AssociationProxy(</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span data-line="569">            <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">,</span>
</span><span data-line="570">            <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">,</span>
</span><span data-line="571">        <span class="p">)</span>
</span><span data-line="572">
</span><span data-line="573">
</span><span data-line="574"><span class="c1"># the pep-673 Self type does not work in Mypy for a &quot;hybrid&quot;</span>
</span><span data-line="575"><span class="c1"># style method that returns type or Self, so for one specific case</span>
</span><span data-line="576"><span class="c1"># we still need to use the pre-pep-673 workaround.</span>
</span><span data-line="577"><span class="n">_Self</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_Self&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;AssociationProxyInstance[Any]&quot;</span><span class="p">)</span>
</span><span data-line="578">
</span><span data-line="579">
</span><span data-line="580"><span class="k">class</span><span class="w"> </span><span class="nc">AssociationProxyInstance</span><span class="p">(</span><span class="n">SQLORMOperations</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="581"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A per-class object that serves class- and object-specific results.</span>
</span><span data-line="582">
</span><span data-line="583"><span class="sd">    This is used by :class:`.AssociationProxy` when it is invoked</span>
</span><span data-line="584"><span class="sd">    in terms of a specific class or instance of a class, i.e. when it is</span>
</span><span data-line="585"><span class="sd">    used as a regular Python descriptor.</span>
</span><span data-line="586">
</span><span data-line="587"><span class="sd">    When referring to the :class:`.AssociationProxy` as a normal Python</span>
</span><span data-line="588"><span class="sd">    descriptor, the :class:`.AssociationProxyInstance` is the object that</span>
</span><span data-line="589"><span class="sd">    actually serves the information.   Under normal circumstances, its presence</span>
</span><span data-line="590"><span class="sd">    is transparent::</span>
</span><span data-line="591">
</span><span data-line="592"><span class="sd">        &gt;&gt;&gt; User.keywords.scalar</span>
</span><span data-line="593"><span class="sd">        False</span>
</span><span data-line="594">
</span><span data-line="595"><span class="sd">    In the special case that the :class:`.AssociationProxy` object is being</span>
</span><span data-line="596"><span class="sd">    accessed directly, in order to get an explicit handle to the</span>
</span><span data-line="597"><span class="sd">    :class:`.AssociationProxyInstance`, use the</span>
</span><span data-line="598"><span class="sd">    :meth:`.AssociationProxy.for_class` method::</span>
</span><span data-line="599">
</span><span data-line="600"><span class="sd">        proxy_state = inspect(User).all_orm_descriptors[&quot;keywords&quot;].for_class(User)</span>
</span><span data-line="601">
</span><span data-line="602"><span class="sd">        # view if proxy object is scalar or not</span>
</span><span data-line="603"><span class="sd">        &gt;&gt;&gt; proxy_state.scalar</span>
</span><span data-line="604"><span class="sd">        False</span>
</span><span data-line="605">
</span><span data-line="606"><span class="sd">    .. versionadded:: 1.3</span>
</span><span data-line="607">
</span><span data-line="608"><span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
</span><span data-line="609">
</span><span data-line="610">    <span class="n">collection_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="611">    <span class="n">parent</span><span class="p">:</span> <span class="n">_AssociationProxyProtocol</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span>
</span><span data-line="612">
</span><span data-line="613">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="614">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="615">        <span class="n">parent</span><span class="p">:</span> <span class="n">_AssociationProxyProtocol</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="616">        <span class="n">owning_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="617">        <span class="n">target_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="618">        <span class="n">value_attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="619">    <span class="p">):</span>
</span><span data-line="620">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span data-line="621">        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="622">        <span class="bp">self</span><span class="o">.</span><span class="n">owning_class</span> <span class="o">=</span> <span class="n">owning_class</span>
</span><span data-line="623">        <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">target_collection</span>
</span><span data-line="624">        <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="625">        <span class="bp">self</span><span class="o">.</span><span class="n">target_class</span> <span class="o">=</span> <span class="n">target_class</span>
</span><span data-line="626">        <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span> <span class="o">=</span> <span class="n">value_attr</span>
</span><span data-line="627">
</span><span data-line="628">    <span class="n">target_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="629"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The intermediary class handled by this</span>
</span><span data-line="630"><span class="sd">    :class:`.AssociationProxyInstance`.</span>
</span><span data-line="631">
</span><span data-line="632"><span class="sd">    Intercepted append/set/assignment events will result</span>
</span><span data-line="633"><span class="sd">    in the generation of new instances of this class.</span>
</span><span data-line="634">
</span><span data-line="635"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="636">
</span><span data-line="637">    <span class="nd">@classmethod</span>
</span><span data-line="638">    <span class="k">def</span><span class="w"> </span><span class="nf">for_proxy</span><span class="p">(</span>
</span><span data-line="639">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="640">        <span class="n">parent</span><span class="p">:</span> <span class="n">AssociationProxy</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="641">        <span class="n">owning_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="642">        <span class="n">parent_instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="643">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="644">        <span class="n">target_collection</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">target_collection</span>
</span><span data-line="645">        <span class="n">value_attr</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">value_attr</span>
</span><span data-line="646">        <span class="n">prop</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="647">            <span class="s2">&quot;orm.RelationshipProperty[_T]&quot;</span><span class="p">,</span>
</span><span data-line="648">            <span class="n">orm</span><span class="o">.</span><span class="n">class_mapper</span><span class="p">(</span><span class="n">owning_class</span><span class="p">)</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">target_collection</span><span class="p">),</span>
</span><span data-line="649">        <span class="p">)</span>
</span><span data-line="650">
</span><span data-line="651">        <span class="c1"># this was never asserted before but this should be made clear.</span>
</span><span data-line="652">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">RelationshipProperty</span><span class="p">):</span>
</span><span data-line="653">            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span data-line="654">                <span class="s2">&quot;association proxy to a non-relationship &quot;</span>
</span><span data-line="655">                <span class="s2">&quot;intermediary is not supported&quot;</span>
</span><span data-line="656">            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>
</span><span data-line="657">
</span><span data-line="658">        <span class="n">target_class</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span>
</span><span data-line="659">
</span><span data-line="660">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="661">            <span class="n">target_assoc</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="662">                <span class="s2">&quot;AssociationProxyInstance[_T]&quot;</span><span class="p">,</span>
</span><span data-line="663">                <span class="bp">cls</span><span class="o">.</span><span class="n">_cls_unwrap_target_assoc_proxy</span><span class="p">(</span><span class="n">target_class</span><span class="p">,</span> <span class="n">value_attr</span><span class="p">),</span>
</span><span data-line="664">            <span class="p">)</span>
</span><span data-line="665">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span data-line="666">            <span class="c1"># the proxied attribute doesn&#39;t exist on the target class;</span>
</span><span data-line="667">            <span class="c1"># return an &quot;ambiguous&quot; instance that will work on a per-object</span>
</span><span data-line="668">            <span class="c1"># basis</span>
</span><span data-line="669">            <span class="k">return</span> <span class="n">AmbiguousAssociationProxyInstance</span><span class="p">(</span>
</span><span data-line="670">                <span class="n">parent</span><span class="p">,</span> <span class="n">owning_class</span><span class="p">,</span> <span class="n">target_class</span><span class="p">,</span> <span class="n">value_attr</span>
</span><span data-line="671">            <span class="p">)</span>
</span><span data-line="672">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="673">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="674">                <span class="sa">f</span><span class="s2">&quot;Association proxy received an unexpected error when &quot;</span>
</span><span data-line="675">                <span class="sa">f</span><span class="s2">&quot;trying to retreive attribute &quot;</span>
</span><span data-line="676">                <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">target_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">parent</span><span class="o">.</span><span class="n">value_attr</span><span class="si">}</span><span class="s1">&quot; from &#39;</span>
</span><span data-line="677">                <span class="sa">f</span><span class="s1">&#39;class &quot;</span><span class="si">{</span><span class="n">target_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&quot;: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span data-line="678">            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
</span><span data-line="679">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="680">            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_construct_for_assoc</span><span class="p">(</span>
</span><span data-line="681">                <span class="n">target_assoc</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">owning_class</span><span class="p">,</span> <span class="n">target_class</span><span class="p">,</span> <span class="n">value_attr</span>
</span><span data-line="682">            <span class="p">)</span>
</span><span data-line="683">
</span><span data-line="684">    <span class="nd">@classmethod</span>
</span><span data-line="685">    <span class="k">def</span><span class="w"> </span><span class="nf">_construct_for_assoc</span><span class="p">(</span>
</span><span data-line="686">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="687">        <span class="n">target_assoc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
</span><span data-line="688">        <span class="n">parent</span><span class="p">:</span> <span class="n">_AssociationProxyProtocol</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="689">        <span class="n">owning_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="690">        <span class="n">target_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="691">        <span class="n">value_attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="692">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="693">        <span class="k">if</span> <span class="n">target_assoc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="694">            <span class="k">return</span> <span class="n">ObjectAssociationProxyInstance</span><span class="p">(</span>
</span><span data-line="695">                <span class="n">parent</span><span class="p">,</span> <span class="n">owning_class</span><span class="p">,</span> <span class="n">target_class</span><span class="p">,</span> <span class="n">value_attr</span>
</span><span data-line="696">            <span class="p">)</span>
</span><span data-line="697">
</span><span data-line="698">        <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_class</span><span class="p">,</span> <span class="n">value_attr</span><span class="p">)</span>
</span><span data-line="699">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s2">&quot;_is_internal_proxy&quot;</span><span class="p">):</span>
</span><span data-line="700">            <span class="k">return</span> <span class="n">AmbiguousAssociationProxyInstance</span><span class="p">(</span>
</span><span data-line="701">                <span class="n">parent</span><span class="p">,</span> <span class="n">owning_class</span><span class="p">,</span> <span class="n">target_class</span><span class="p">,</span> <span class="n">value_attr</span>
</span><span data-line="702">            <span class="p">)</span>
</span><span data-line="703">        <span class="n">is_object</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">_impl_uses_objects</span>
</span><span data-line="704">        <span class="k">if</span> <span class="n">is_object</span><span class="p">:</span>
</span><span data-line="705">            <span class="k">return</span> <span class="n">ObjectAssociationProxyInstance</span><span class="p">(</span>
</span><span data-line="706">                <span class="n">parent</span><span class="p">,</span> <span class="n">owning_class</span><span class="p">,</span> <span class="n">target_class</span><span class="p">,</span> <span class="n">value_attr</span>
</span><span data-line="707">            <span class="p">)</span>
</span><span data-line="708">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="709">            <span class="k">return</span> <span class="n">ColumnAssociationProxyInstance</span><span class="p">(</span>
</span><span data-line="710">                <span class="n">parent</span><span class="p">,</span> <span class="n">owning_class</span><span class="p">,</span> <span class="n">target_class</span><span class="p">,</span> <span class="n">value_attr</span>
</span><span data-line="711">            <span class="p">)</span>
</span><span data-line="712">
</span><span data-line="713">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_property</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MapperProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="714">        <span class="k">return</span> <span class="n">orm</span><span class="o">.</span><span class="n">class_mapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owning_class</span><span class="p">)</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span>
</span><span data-line="715">            <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span>
</span><span data-line="716">        <span class="p">)</span>
</span><span data-line="717">
</span><span data-line="718">    <span class="nd">@property</span>
</span><span data-line="719">    <span class="k">def</span><span class="w"> </span><span class="nf">_comparator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PropComparator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="720">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
</span><span data-line="721">            <span class="bp">self</span><span class="o">.</span><span class="n">owning_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span>
</span><span data-line="722">        <span class="p">)</span><span class="o">.</span><span class="n">comparator</span>
</span><span data-line="723">
</span><span data-line="724">    <span class="k">def</span><span class="w"> </span><span class="nf">__clause_element__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="725">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span data-line="726">            <span class="s2">&quot;The association proxy can&#39;t be used as a plain column &quot;</span>
</span><span data-line="727">            <span class="s2">&quot;expression; it only works inside of a comparison expression&quot;</span>
</span><span data-line="728">        <span class="p">)</span>
</span><span data-line="729">
</span><span data-line="730">    <span class="nd">@classmethod</span>
</span><span data-line="731">    <span class="k">def</span><span class="w"> </span><span class="nf">_cls_unwrap_target_assoc_proxy</span><span class="p">(</span>
</span><span data-line="732">        <span class="bp">cls</span><span class="p">,</span> <span class="n">target_class</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value_attr</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="733">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span data-line="734">        <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_class</span><span class="p">,</span> <span class="n">value_attr</span><span class="p">)</span>
</span><span data-line="735">        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">AssociationProxy</span><span class="p">)</span>
</span><span data-line="736">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">AssociationProxyInstance</span><span class="p">):</span>
</span><span data-line="737">            <span class="k">return</span> <span class="n">attr</span>
</span><span data-line="738">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="739">
</span><span data-line="740">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="741">    <span class="k">def</span><span class="w"> </span><span class="nf">_unwrap_target_assoc_proxy</span><span class="p">(</span>
</span><span data-line="742">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="743">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span data-line="744">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_unwrap_target_assoc_proxy</span><span class="p">(</span>
</span><span data-line="745">            <span class="bp">self</span><span class="o">.</span><span class="n">target_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span>
</span><span data-line="746">        <span class="p">)</span>
</span><span data-line="747">
</span><span data-line="748">    <span class="nd">@property</span>
</span><span data-line="749">    <span class="k">def</span><span class="w"> </span><span class="nf">remote_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SQLORMOperations</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="750"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The &#39;remote&#39; class attribute referenced by this</span>
</span><span data-line="751"><span class="sd">        :class:`.AssociationProxyInstance`.</span>
</span><span data-line="752">
</span><span data-line="753"><span class="sd">        .. seealso::</span>
</span><span data-line="754">
</span><span data-line="755"><span class="sd">            :attr:`.AssociationProxyInstance.attr`</span>
</span><span data-line="756">
</span><span data-line="757"><span class="sd">            :attr:`.AssociationProxyInstance.local_attr`</span>
</span><span data-line="758">
</span><span data-line="759"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="760">        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="761">            <span class="s2">&quot;SQLORMOperations[_T]&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">)</span>
</span><span data-line="762">        <span class="p">)</span>
</span><span data-line="763">
</span><span data-line="764">    <span class="nd">@property</span>
</span><span data-line="765">    <span class="k">def</span><span class="w"> </span><span class="nf">local_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SQLORMOperations</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="766"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The &#39;local&#39; class attribute referenced by this</span>
</span><span data-line="767"><span class="sd">        :class:`.AssociationProxyInstance`.</span>
</span><span data-line="768">
</span><span data-line="769"><span class="sd">        .. seealso::</span>
</span><span data-line="770">
</span><span data-line="771"><span class="sd">            :attr:`.AssociationProxyInstance.attr`</span>
</span><span data-line="772">
</span><span data-line="773"><span class="sd">            :attr:`.AssociationProxyInstance.remote_attr`</span>
</span><span data-line="774">
</span><span data-line="775"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="776">        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="777">            <span class="s2">&quot;SQLORMOperations[Any]&quot;</span><span class="p">,</span>
</span><span data-line="778">            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owning_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">),</span>
</span><span data-line="779">        <span class="p">)</span>
</span><span data-line="780">
</span><span data-line="781">    <span class="nd">@property</span>
</span><span data-line="782">    <span class="k">def</span><span class="w"> </span><span class="nf">attr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SQLORMOperations</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">SQLORMOperations</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span data-line="783"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a tuple of ``(local_attr, remote_attr)``.</span>
</span><span data-line="784">
</span><span data-line="785"><span class="sd">        This attribute was originally intended to facilitate using the</span>
</span><span data-line="786"><span class="sd">        :meth:`_query.Query.join` method to join across the two relationships</span>
</span><span data-line="787"><span class="sd">        at once, however this makes use of a deprecated calling style.</span>
</span><span data-line="788">
</span><span data-line="789"><span class="sd">        To use :meth:`_sql.select.join` or :meth:`_orm.Query.join` with</span>
</span><span data-line="790"><span class="sd">        an association proxy, the current method is to make use of the</span>
</span><span data-line="791"><span class="sd">        :attr:`.AssociationProxyInstance.local_attr` and</span>
</span><span data-line="792"><span class="sd">        :attr:`.AssociationProxyInstance.remote_attr` attributes separately::</span>
</span><span data-line="793">
</span><span data-line="794"><span class="sd">            stmt = (</span>
</span><span data-line="795"><span class="sd">                select(Parent)</span>
</span><span data-line="796"><span class="sd">                .join(Parent.proxied.local_attr)</span>
</span><span data-line="797"><span class="sd">                .join(Parent.proxied.remote_attr)</span>
</span><span data-line="798"><span class="sd">            )</span>
</span><span data-line="799">
</span><span data-line="800"><span class="sd">        A future release may seek to provide a more succinct join pattern</span>
</span><span data-line="801"><span class="sd">        for association proxy attributes.</span>
</span><span data-line="802">
</span><span data-line="803"><span class="sd">        .. seealso::</span>
</span><span data-line="804">
</span><span data-line="805"><span class="sd">            :attr:`.AssociationProxyInstance.local_attr`</span>
</span><span data-line="806">
</span><span data-line="807"><span class="sd">            :attr:`.AssociationProxyInstance.remote_attr`</span>
</span><span data-line="808">
</span><span data-line="809"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="810">        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_attr</span><span class="p">)</span>
</span><span data-line="811">
</span><span data-line="812">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="813">    <span class="k">def</span><span class="w"> </span><span class="nf">scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="814"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return ``True`` if this :class:`.AssociationProxyInstance`</span>
</span><span data-line="815"><span class="sd">        proxies a scalar relationship on the local side.&quot;&quot;&quot;</span>
</span><span data-line="816">
</span><span data-line="817">        <span class="n">scalar</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_property</span><span class="p">()</span><span class="o">.</span><span class="n">uselist</span>
</span><span data-line="818">        <span class="k">if</span> <span class="n">scalar</span><span class="p">:</span>
</span><span data-line="819">            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_scalar_accessors</span><span class="p">()</span>
</span><span data-line="820">        <span class="k">return</span> <span class="n">scalar</span>
</span><span data-line="821">
</span><span data-line="822">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="823">    <span class="k">def</span><span class="w"> </span><span class="nf">_value_is_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="824">        <span class="k">return</span> <span class="p">(</span>
</span><span data-line="825">            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_property</span><span class="p">()</span>
</span><span data-line="826">            <span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">)</span>
</span><span data-line="827">            <span class="o">.</span><span class="n">uselist</span>
</span><span data-line="828">        <span class="p">)</span>
</span><span data-line="829">
</span><span data-line="830">    <span class="nd">@property</span>
</span><span data-line="831">    <span class="k">def</span><span class="w"> </span><span class="nf">_target_is_object</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="832">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="833">
</span><span data-line="834">    <span class="n">_scalar_get</span><span class="p">:</span> <span class="n">_GetterProtocol</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span>
</span><span data-line="835">    <span class="n">_scalar_set</span><span class="p">:</span> <span class="n">_PlainSetterProtocol</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span>
</span><span data-line="836">
</span><span data-line="837">    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_scalar_accessors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="838">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">getset_factory</span><span class="p">:</span>
</span><span data-line="839">            <span class="n">get</span><span class="p">,</span> <span class="n">set_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">getset_factory</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span data-line="840">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="841">            <span class="n">get</span><span class="p">,</span> <span class="n">set_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_default_getset</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span data-line="842">        <span class="bp">self</span><span class="o">.</span><span class="n">_scalar_get</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar_set</span> <span class="o">=</span> <span class="n">get</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="843">            <span class="s2">&quot;_PlainSetterProtocol[_T]&quot;</span><span class="p">,</span> <span class="n">set_</span>
</span><span data-line="844">        <span class="p">)</span>
</span><span data-line="845">
</span><span data-line="846">    <span class="k">def</span><span class="w"> </span><span class="nf">_default_getset</span><span class="p">(</span>
</span><span data-line="847">        <span class="bp">self</span><span class="p">,</span> <span class="n">collection_class</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="848">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">_GetterProtocol</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">_SetterProtocol</span><span class="p">]:</span>
</span><span data-line="849">        <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span>
</span><span data-line="850">        <span class="n">_getter</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
</span><span data-line="851">
</span><span data-line="852">        <span class="k">def</span><span class="w"> </span><span class="nf">getter</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="853">            <span class="k">return</span> <span class="n">_getter</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span data-line="854">
</span><span data-line="855">        <span class="k">if</span> <span class="n">collection_class</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span><span data-line="856">
</span><span data-line="857">            <span class="k">def</span><span class="w"> </span><span class="nf">dict_setter</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="858">                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="859">
</span><span data-line="860">            <span class="k">return</span> <span class="n">getter</span><span class="p">,</span> <span class="n">dict_setter</span>
</span><span data-line="861">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="862">
</span><span data-line="863">            <span class="k">def</span><span class="w"> </span><span class="nf">plain_setter</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="864">                <span class="nb">setattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span data-line="865">
</span><span data-line="866">            <span class="k">return</span> <span class="n">getter</span><span class="p">,</span> <span class="n">plain_setter</span>
</span><span data-line="867">
</span><span data-line="868">    <span class="nd">@util</span><span class="o">.</span><span class="n">ro_non_memoized_property</span>
</span><span data-line="869">    <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_InfoType</span><span class="p">:</span>
</span><span data-line="870">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">info</span>
</span><span data-line="871">
</span><span data-line="872">    <span class="nd">@overload</span>
</span><span data-line="873">    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">_Self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">_Self</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="874">
</span><span data-line="875">    <span class="nd">@overload</span>
</span><span data-line="876">    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="877">
</span><span data-line="878">    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
</span><span data-line="879">        <span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="880">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span data-line="881">        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="882">            <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="883">
</span><span data-line="884">        <span class="n">proxy</span><span class="p">:</span> <span class="n">_T</span>
</span><span data-line="885">
</span><span data-line="886">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span><span class="p">:</span>
</span><span data-line="887">            <span class="n">target</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">)</span>
</span><span data-line="888">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar_get</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span data-line="889">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="890">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="891">                <span class="c1"># If the owning instance is reborn (orm session resurrect,</span>
</span><span data-line="892">                <span class="c1"># etc.), refresh the proxy cache.</span>
</span><span data-line="893">                <span class="n">creator_id</span><span class="p">,</span> <span class="n">self_id</span><span class="p">,</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="894">                    <span class="s2">&quot;Tuple[int, int, _T]&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="895">                <span class="p">)</span>
</span><span data-line="896">            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span data-line="897">                <span class="k">pass</span>
</span><span data-line="898">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="899">                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">creator_id</span> <span class="ow">and</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">self_id</span><span class="p">:</span>
</span><span data-line="900">                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="901">                    <span class="k">return</span> <span class="n">proxy</span>
</span><span data-line="902">
</span><span data-line="903">            <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span><span class="p">,</span> <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span>
</span><span data-line="904">                <span class="n">_lazy_collection</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">)</span>
</span><span data-line="905">            <span class="p">)</span>
</span><span data-line="906">            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">proxy</span><span class="p">))</span>
</span><span data-line="907">            <span class="k">return</span> <span class="n">proxy</span>
</span><span data-line="908">
</span><span data-line="909">    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="910">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span><span class="p">:</span>
</span><span data-line="911">            <span class="n">creator</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="912">                <span class="s2">&quot;_PlainCreatorProtocol[_T]&quot;</span><span class="p">,</span>
</span><span data-line="913">                <span class="p">(</span>
</span><span data-line="914">                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">creator</span>
</span><span data-line="915">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">creator</span>
</span><span data-line="916">                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_class</span>
</span><span data-line="917">                <span class="p">),</span>
</span><span data-line="918">            <span class="p">)</span>
</span><span data-line="919">            <span class="n">target</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">)</span>
</span><span data-line="920">            <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="921">                <span class="k">if</span> <span class="p">(</span>
</span><span data-line="922">                    <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="923">                    <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">create_on_none_assignment</span>
</span><span data-line="924">                <span class="p">):</span>
</span><span data-line="925">                    <span class="k">return</span>
</span><span data-line="926">                <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">,</span> <span class="n">creator</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
</span><span data-line="927">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="928">                <span class="bp">self</span><span class="o">.</span><span class="n">_scalar_set</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</span><span data-line="929">                <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cascade_scalar_deletes</span><span class="p">:</span>
</span><span data-line="930">                    <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="931">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="932">            <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span data-line="933">            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="934">            <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
</span><span data-line="935">                <span class="n">proxy</span><span class="o">.</span><span class="n">_bulk_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</span><span data-line="936">
</span><span data-line="937">    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="938">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">owning_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="939">            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_owner</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="940">
</span><span data-line="941">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span><span class="p">:</span>
</span><span data-line="942">            <span class="n">target</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">)</span>
</span><span data-line="943">            <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="944">                <span class="nb">delattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">)</span>
</span><span data-line="945">        <span class="nb">delattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">)</span>
</span><span data-line="946">
</span><span data-line="947">    <span class="k">def</span><span class="w"> </span><span class="nf">_new</span><span class="p">(</span>
</span><span data-line="948">        <span class="bp">self</span><span class="p">,</span> <span class="n">lazy_collection</span><span class="p">:</span> <span class="n">_LazyCollectionProtocol</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span>
</span><span data-line="949">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">_T</span><span class="p">]:</span>
</span><span data-line="950">        <span class="n">creator</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="951">            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">creator</span>
</span><span data-line="952">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">creator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="953">            <span class="k">else</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;_CreatorProtocol&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_class</span><span class="p">)</span>
</span><span data-line="954">        <span class="p">)</span>
</span><span data-line="955">        <span class="n">collection_class</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">duck_type_collection</span><span class="p">(</span><span class="n">lazy_collection</span><span class="p">())</span>
</span><span data-line="956">
</span><span data-line="957">        <span class="k">if</span> <span class="n">collection_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="958">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="959">                <span class="sa">f</span><span class="s2">&quot;lazy collection factory did not return a &quot;</span>
</span><span data-line="960">                <span class="sa">f</span><span class="s2">&quot;valid collection type, got </span><span class="si">{</span><span class="n">collection_class</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="961">            <span class="p">)</span>
</span><span data-line="962">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">proxy_factory</span><span class="p">:</span>
</span><span data-line="963">            <span class="k">return</span> <span class="p">(</span>
</span><span data-line="964">                <span class="n">collection_class</span><span class="p">,</span>
</span><span data-line="965">                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">proxy_factory</span><span class="p">(</span>
</span><span data-line="966">                    <span class="n">lazy_collection</span><span class="p">,</span> <span class="n">creator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">,</span> <span class="bp">self</span>
</span><span data-line="967">                <span class="p">),</span>
</span><span data-line="968">            <span class="p">)</span>
</span><span data-line="969">
</span><span data-line="970">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">getset_factory</span><span class="p">:</span>
</span><span data-line="971">            <span class="n">getter</span><span class="p">,</span> <span class="n">setter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">getset_factory</span><span class="p">(</span><span class="n">collection_class</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span data-line="972">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="973">            <span class="n">getter</span><span class="p">,</span> <span class="n">setter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_default_getset</span><span class="p">(</span><span class="n">collection_class</span><span class="p">)</span>
</span><span data-line="974">
</span><span data-line="975">        <span class="k">if</span> <span class="n">collection_class</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
</span><span data-line="976">            <span class="k">return</span> <span class="p">(</span>
</span><span data-line="977">                <span class="n">collection_class</span><span class="p">,</span>
</span><span data-line="978">                <span class="n">cast</span><span class="p">(</span>
</span><span data-line="979">                    <span class="n">_T</span><span class="p">,</span>
</span><span data-line="980">                    <span class="n">_AssociationList</span><span class="p">(</span>
</span><span data-line="981">                        <span class="n">lazy_collection</span><span class="p">,</span> <span class="n">creator</span><span class="p">,</span> <span class="n">getter</span><span class="p">,</span> <span class="n">setter</span><span class="p">,</span> <span class="bp">self</span>
</span><span data-line="982">                    <span class="p">),</span>
</span><span data-line="983">                <span class="p">),</span>
</span><span data-line="984">            <span class="p">)</span>
</span><span data-line="985">        <span class="k">elif</span> <span class="n">collection_class</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span><span data-line="986">            <span class="k">return</span> <span class="p">(</span>
</span><span data-line="987">                <span class="n">collection_class</span><span class="p">,</span>
</span><span data-line="988">                <span class="n">cast</span><span class="p">(</span>
</span><span data-line="989">                    <span class="n">_T</span><span class="p">,</span>
</span><span data-line="990">                    <span class="n">_AssociationDict</span><span class="p">(</span>
</span><span data-line="991">                        <span class="n">lazy_collection</span><span class="p">,</span> <span class="n">creator</span><span class="p">,</span> <span class="n">getter</span><span class="p">,</span> <span class="n">setter</span><span class="p">,</span> <span class="bp">self</span>
</span><span data-line="992">                    <span class="p">),</span>
</span><span data-line="993">                <span class="p">),</span>
</span><span data-line="994">            <span class="p">)</span>
</span><span data-line="995">        <span class="k">elif</span> <span class="n">collection_class</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">:</span>
</span><span data-line="996">            <span class="k">return</span> <span class="p">(</span>
</span><span data-line="997">                <span class="n">collection_class</span><span class="p">,</span>
</span><span data-line="998">                <span class="n">cast</span><span class="p">(</span>
</span><span data-line="999">                    <span class="n">_T</span><span class="p">,</span>
</span><span data-line="1000">                    <span class="n">_AssociationSet</span><span class="p">(</span>
</span><span data-line="1001">                        <span class="n">lazy_collection</span><span class="p">,</span> <span class="n">creator</span><span class="p">,</span> <span class="n">getter</span><span class="p">,</span> <span class="n">setter</span><span class="p">,</span> <span class="bp">self</span>
</span><span data-line="1002">                    <span class="p">),</span>
</span><span data-line="1003">                <span class="p">),</span>
</span><span data-line="1004">            <span class="p">)</span>
</span><span data-line="1005">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1006">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1007">                <span class="s2">&quot;could not guess which interface to use for &quot;</span>
</span><span data-line="1008">                <span class="s1">&#39;collection_class &quot;</span><span class="si">%s</span><span class="s1">&quot; backing &quot;</span><span class="si">%s</span><span class="s1">&quot;; specify a &#39;</span>
</span><span data-line="1009">                <span class="s2">&quot;proxy_factory and proxy_bulk_set manually&quot;</span>
</span><span data-line="1010">                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">)</span>
</span><span data-line="1011">            <span class="p">)</span>
</span><span data-line="1012">
</span><span data-line="1013">    <span class="k">def</span><span class="w"> </span><span class="nf">_set</span><span class="p">(</span>
</span><span data-line="1014">        <span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">:</span> <span class="n">_AssociationCollection</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="1015">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1016">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">proxy_bulk_set</span><span class="p">:</span>
</span><span data-line="1017">            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">proxy_bulk_set</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</span><span data-line="1018">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
</span><span data-line="1019">            <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;_AssociationList[Any]&quot;</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span data-line="1020">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span><span data-line="1021">            <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;_AssociationDict[Any, Any]&quot;</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span data-line="1022">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">:</span>
</span><span data-line="1023">            <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;_AssociationSet[Any]&quot;</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span data-line="1024">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1025">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1026">                <span class="s2">&quot;no proxy_bulk_set supplied for custom &quot;</span>
</span><span data-line="1027">                <span class="s2">&quot;collection_class implementation&quot;</span>
</span><span data-line="1028">            <span class="p">)</span>
</span><span data-line="1029">
</span><span data-line="1030">    <span class="k">def</span><span class="w"> </span><span class="nf">_inflate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">:</span> <span class="n">_AssociationCollection</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1031">        <span class="n">creator</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1032">            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">creator</span>
</span><span data-line="1033">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">creator</span>
</span><span data-line="1034">            <span class="ow">or</span> <span class="n">cast</span><span class="p">(</span><span class="n">_CreatorProtocol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_class</span><span class="p">)</span>
</span><span data-line="1035">        <span class="p">)</span>
</span><span data-line="1036">
</span><span data-line="1037">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">getset_factory</span><span class="p">:</span>
</span><span data-line="1038">            <span class="n">getter</span><span class="p">,</span> <span class="n">setter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">getset_factory</span><span class="p">(</span>
</span><span data-line="1039">                <span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span><span class="p">,</span> <span class="bp">self</span>
</span><span data-line="1040">            <span class="p">)</span>
</span><span data-line="1041">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1042">            <span class="n">getter</span><span class="p">,</span> <span class="n">setter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_default_getset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_class</span><span class="p">)</span>
</span><span data-line="1043">
</span><span data-line="1044">        <span class="n">proxy</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">creator</span>
</span><span data-line="1045">        <span class="n">proxy</span><span class="o">.</span><span class="n">getter</span> <span class="o">=</span> <span class="n">getter</span>
</span><span data-line="1046">        <span class="n">proxy</span><span class="o">.</span><span class="n">setter</span> <span class="o">=</span> <span class="n">setter</span>
</span><span data-line="1047">
</span><span data-line="1048">    <span class="k">def</span><span class="w"> </span><span class="nf">_criterion_exists</span><span class="p">(</span>
</span><span data-line="1049">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1050">        <span class="n">criterion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1051">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1052">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="1053">        <span class="n">is_has</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;is_has&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="1054">
</span><span data-line="1055">        <span class="n">target_assoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwrap_target_assoc_proxy</span>
</span><span data-line="1056">        <span class="k">if</span> <span class="n">target_assoc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1057">            <span class="n">inner</span> <span class="o">=</span> <span class="n">target_assoc</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span>
</span><span data-line="1058">                <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="1059">            <span class="p">)</span>
</span><span data-line="1060">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
</span><span data-line="1061">
</span><span data-line="1062">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_is_object</span><span class="p">:</span>
</span><span data-line="1063">            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">)</span>
</span><span data-line="1064">            <span class="n">value_expr</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span><span class="n">criterion</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="1065">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1066">            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span data-line="1067">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1068">                    <span class="s2">&quot;Can&#39;t apply keyword arguments to column-targeted &quot;</span>
</span><span data-line="1069">                    <span class="s2">&quot;association proxy; use ==&quot;</span>
</span><span data-line="1070">                <span class="p">)</span>
</span><span data-line="1071">            <span class="k">elif</span> <span class="n">is_has</span> <span class="ow">and</span> <span class="n">criterion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1072">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1073">                    <span class="s2">&quot;Non-empty has() not allowed for &quot;</span>
</span><span data-line="1074">                    <span class="s2">&quot;column-targeted association proxy; use ==&quot;</span>
</span><span data-line="1075">                <span class="p">)</span>
</span><span data-line="1076">
</span><span data-line="1077">            <span class="n">value_expr</span> <span class="o">=</span> <span class="n">criterion</span>
</span><span data-line="1078">
</span><span data-line="1079">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span><span class="n">value_expr</span><span class="p">)</span>
</span><span data-line="1080">
</span><span data-line="1081">    <span class="k">def</span><span class="w"> </span><span class="nf">any</span><span class="p">(</span>
</span><span data-line="1082">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1083">        <span class="n">criterion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1084">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1085">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="1086"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a proxied &#39;any&#39; expression using EXISTS.</span>
</span><span data-line="1087">
</span><span data-line="1088"><span class="sd">        This expression will be a composed product</span>
</span><span data-line="1089"><span class="sd">        using the :meth:`.Relationship.Comparator.any`</span>
</span><span data-line="1090"><span class="sd">        and/or :meth:`.Relationship.Comparator.has`</span>
</span><span data-line="1091"><span class="sd">        operators of the underlying proxied attributes.</span>
</span><span data-line="1092">
</span><span data-line="1093"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1094">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwrap_target_assoc_proxy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="1095">            <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span>
</span><span data-line="1096">            <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_is_object</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_is_scalar</span><span class="p">)</span>
</span><span data-line="1097">        <span class="p">):</span>
</span><span data-line="1098">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1099">                <span class="s2">&quot;&#39;any()&#39; not implemented for scalar attributes. Use has().&quot;</span>
</span><span data-line="1100">            <span class="p">)</span>
</span><span data-line="1101">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span>
</span><span data-line="1102">            <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span> <span class="n">is_has</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="1103">        <span class="p">)</span>
</span><span data-line="1104">
</span><span data-line="1105">    <span class="k">def</span><span class="w"> </span><span class="nf">has</span><span class="p">(</span>
</span><span data-line="1106">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1107">        <span class="n">criterion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1108">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1109">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="1110"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a proxied &#39;has&#39; expression using EXISTS.</span>
</span><span data-line="1111">
</span><span data-line="1112"><span class="sd">        This expression will be a composed product</span>
</span><span data-line="1113"><span class="sd">        using the :meth:`.Relationship.Comparator.any`</span>
</span><span data-line="1114"><span class="sd">        and/or :meth:`.Relationship.Comparator.has`</span>
</span><span data-line="1115"><span class="sd">        operators of the underlying proxied attributes.</span>
</span><span data-line="1116">
</span><span data-line="1117"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1118">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwrap_target_assoc_proxy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="1119">            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span>
</span><span data-line="1120">            <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_is_object</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_is_scalar</span><span class="p">)</span>
</span><span data-line="1121">        <span class="p">):</span>
</span><span data-line="1122">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1123">                <span class="s2">&quot;&#39;has()&#39; not implemented for collections. Use any().&quot;</span>
</span><span data-line="1124">            <span class="p">)</span>
</span><span data-line="1125">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span>
</span><span data-line="1126">            <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span> <span class="n">is_has</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="1127">        <span class="p">)</span>
</span><span data-line="1128">
</span><span data-line="1129">    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="1130">        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
</span><span data-line="1131">
</span><span data-line="1132">
</span><span data-line="1133"><span class="k">class</span><span class="w"> </span><span class="nc">AmbiguousAssociationProxyInstance</span><span class="p">(</span><span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="1134"><span class="w">    </span><span class="sd">&quot;&quot;&quot;an :class:`.AssociationProxyInstance` where we cannot determine</span>
</span><span data-line="1135"><span class="sd">    the type of target object.</span>
</span><span data-line="1136"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1137">
</span><span data-line="1138">    <span class="n">_is_canonical</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1139">
</span><span data-line="1140">    <span class="k">def</span><span class="w"> </span><span class="nf">_ambiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="1141">        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
</span><span data-line="1142">            <span class="s2">&quot;Association proxy </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> refers to an attribute &#39;</span><span class="si">%s</span><span class="s2">&#39; that is not &quot;</span>
</span><span data-line="1143">            <span class="s2">&quot;directly mapped on class </span><span class="si">%s</span><span class="s2">; therefore this operation cannot &quot;</span>
</span><span data-line="1144">            <span class="s2">&quot;proceed since we don&#39;t know what type of object is referred &quot;</span>
</span><span data-line="1145">            <span class="s2">&quot;towards&quot;</span>
</span><span data-line="1146">            <span class="o">%</span> <span class="p">(</span>
</span><span data-line="1147">                <span class="bp">self</span><span class="o">.</span><span class="n">owning_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="1148">                <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">,</span>
</span><span data-line="1149">                <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">,</span>
</span><span data-line="1150">                <span class="bp">self</span><span class="o">.</span><span class="n">target_class</span><span class="p">,</span>
</span><span data-line="1151">            <span class="p">)</span>
</span><span data-line="1152">        <span class="p">)</span>
</span><span data-line="1153">
</span><span data-line="1154">    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="1155">        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1156">            <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="1157">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1158">            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span data-line="1159">
</span><span data-line="1160">    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="1161">        <span class="bp">self</span><span class="o">.</span><span class="n">_ambiguous</span><span class="p">()</span>
</span><span data-line="1162">
</span><span data-line="1163">    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="1164">        <span class="bp">self</span><span class="o">.</span><span class="n">_ambiguous</span><span class="p">()</span>
</span><span data-line="1165">
</span><span data-line="1166">    <span class="k">def</span><span class="w"> </span><span class="nf">any</span><span class="p">(</span>
</span><span data-line="1167">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1168">        <span class="n">criterion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1169">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1170">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="1171">        <span class="bp">self</span><span class="o">.</span><span class="n">_ambiguous</span><span class="p">()</span>
</span><span data-line="1172">
</span><span data-line="1173">    <span class="k">def</span><span class="w"> </span><span class="nf">has</span><span class="p">(</span>
</span><span data-line="1174">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1175">        <span class="n">criterion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1176">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1177">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="1178">        <span class="bp">self</span><span class="o">.</span><span class="n">_ambiguous</span><span class="p">()</span>
</span><span data-line="1179">
</span><span data-line="1180">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="1181">    <span class="k">def</span><span class="w"> </span><span class="nf">_lookup_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span data-line="1182">        <span class="c1"># mapping of &lt;subclass&gt;-&gt;AssociationProxyInstance.</span>
</span><span data-line="1183">        <span class="c1"># e.g. proxy is A-&gt; A.b -&gt; B -&gt; B.b_attr, but B.b_attr doesn&#39;t exist;</span>
</span><span data-line="1184">        <span class="c1"># only B1(B) and B2(B) have &quot;b_attr&quot;, keys in here would be B1, B2</span>
</span><span data-line="1185">        <span class="k">return</span> <span class="p">{}</span>
</span><span data-line="1186">
</span><span data-line="1187">    <span class="k">def</span><span class="w"> </span><span class="nf">_non_canonical_get_for_object</span><span class="p">(</span>
</span><span data-line="1188">        <span class="bp">self</span><span class="p">,</span> <span class="n">parent_instance</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="1189">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1190">        <span class="k">if</span> <span class="n">parent_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1191">            <span class="n">actual_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span><span class="p">)</span>
</span><span data-line="1192">            <span class="k">if</span> <span class="n">actual_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1193">                <span class="k">try</span><span class="p">:</span>
</span><span data-line="1194">                    <span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">actual_obj</span><span class="p">)</span>
</span><span data-line="1195">                <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NoInspectionAvailable</span><span class="p">:</span>
</span><span data-line="1196">                    <span class="k">pass</span>
</span><span data-line="1197">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1198">                    <span class="n">mapper</span> <span class="o">=</span> <span class="n">insp</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="1199">                    <span class="n">instance_class</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">class_</span>
</span><span data-line="1200">                    <span class="k">if</span> <span class="n">instance_class</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_cache</span><span class="p">:</span>
</span><span data-line="1201">                        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_cache</span><span class="p">(</span><span class="n">instance_class</span><span class="p">,</span> <span class="n">mapper</span><span class="p">)</span>
</span><span data-line="1202">
</span><span data-line="1203">                    <span class="k">try</span><span class="p">:</span>
</span><span data-line="1204">                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_cache</span><span class="p">[</span><span class="n">instance_class</span><span class="p">]</span>
</span><span data-line="1205">                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span data-line="1206">                        <span class="k">pass</span>
</span><span data-line="1207">
</span><span data-line="1208">        <span class="c1"># no object or ambiguous object given, so return &quot;self&quot;, which</span>
</span><span data-line="1209">        <span class="c1"># is a proxy with generally only instance-level functionality</span>
</span><span data-line="1210">        <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="1211">
</span><span data-line="1212">    <span class="k">def</span><span class="w"> </span><span class="nf">_populate_cache</span><span class="p">(</span>
</span><span data-line="1213">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance_class</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="1214">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1215">        <span class="n">prop</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">class_mapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owning_class</span><span class="p">)</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span>
</span><span data-line="1216">            <span class="bp">self</span><span class="o">.</span><span class="n">target_collection</span>
</span><span data-line="1217">        <span class="p">)</span>
</span><span data-line="1218">
</span><span data-line="1219">        <span class="k">if</span> <span class="n">mapper</span><span class="o">.</span><span class="n">isa</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">mapper</span><span class="p">):</span>
</span><span data-line="1220">            <span class="n">target_class</span> <span class="o">=</span> <span class="n">instance_class</span>
</span><span data-line="1221">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="1222">                <span class="n">target_assoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_unwrap_target_assoc_proxy</span><span class="p">(</span>
</span><span data-line="1223">                    <span class="n">target_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span>
</span><span data-line="1224">                <span class="p">)</span>
</span><span data-line="1225">            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span data-line="1226">                <span class="k">pass</span>
</span><span data-line="1227">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1228">                <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_cache</span><span class="p">[</span><span class="n">instance_class</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_for_assoc</span><span class="p">(</span>
</span><span data-line="1229">                    <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;AssociationProxyInstance[_T]&quot;</span><span class="p">,</span> <span class="n">target_assoc</span><span class="p">),</span>
</span><span data-line="1230">                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
</span><span data-line="1231">                    <span class="bp">self</span><span class="o">.</span><span class="n">owning_class</span><span class="p">,</span>
</span><span data-line="1232">                    <span class="n">target_class</span><span class="p">,</span>
</span><span data-line="1233">                    <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">,</span>
</span><span data-line="1234">                <span class="p">)</span>
</span><span data-line="1235">
</span><span data-line="1236">
</span><span data-line="1237"><span class="k">class</span><span class="w"> </span><span class="nc">ObjectAssociationProxyInstance</span><span class="p">(</span><span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="1238"><span class="w">    </span><span class="sd">&quot;&quot;&quot;an :class:`.AssociationProxyInstance` that has an object as a target.&quot;&quot;&quot;</span>
</span><span data-line="1239">
</span><span data-line="1240">    <span class="n">_target_is_object</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1241">    <span class="n">_is_canonical</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1242">
</span><span data-line="1243">    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="1244"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a proxied &#39;contains&#39; expression using EXISTS.</span>
</span><span data-line="1245">
</span><span data-line="1246"><span class="sd">        This expression will be a composed product</span>
</span><span data-line="1247"><span class="sd">        using the :meth:`.Relationship.Comparator.any`,</span>
</span><span data-line="1248"><span class="sd">        :meth:`.Relationship.Comparator.has`,</span>
</span><span data-line="1249"><span class="sd">        and/or :meth:`.Relationship.Comparator.contains`</span>
</span><span data-line="1250"><span class="sd">        operators of the underlying proxied attributes.</span>
</span><span data-line="1251"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1252">
</span><span data-line="1253">        <span class="n">target_assoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwrap_target_assoc_proxy</span>
</span><span data-line="1254">        <span class="k">if</span> <span class="n">target_assoc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1255">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span>
</span><span data-line="1256">                <span class="n">target_assoc</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span data-line="1257">                <span class="k">if</span> <span class="ow">not</span> <span class="n">target_assoc</span><span class="o">.</span><span class="n">scalar</span>
</span><span data-line="1258">                <span class="k">else</span> <span class="n">target_assoc</span> <span class="o">==</span> <span class="n">other</span>
</span><span data-line="1259">            <span class="p">)</span>
</span><span data-line="1260">        <span class="k">elif</span> <span class="p">(</span>
</span><span data-line="1261">            <span class="bp">self</span><span class="o">.</span><span class="n">_target_is_object</span>
</span><span data-line="1262">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span>
</span><span data-line="1263">            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_is_scalar</span>
</span><span data-line="1264">        <span class="p">):</span>
</span><span data-line="1265">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">has</span><span class="p">(</span>
</span><span data-line="1266">                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">)</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span data-line="1267">            <span class="p">)</span>
</span><span data-line="1268">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_is_object</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_is_scalar</span><span class="p">:</span>
</span><span data-line="1269">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1270">                <span class="s2">&quot;contains() doesn&#39;t apply to a scalar object endpoint; use ==&quot;</span>
</span><span data-line="1271">            <span class="p">)</span>
</span><span data-line="1272">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1273">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span>
</span><span data-line="1274">                <span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">:</span> <span class="n">other</span><span class="p">}</span>
</span><span data-line="1275">            <span class="p">)</span>
</span><span data-line="1276">
</span><span data-line="1277">    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>  <span class="c1"># type: ignore[override]  # noqa: E501</span>
</span><span data-line="1278">        <span class="c1"># note the has() here will fail for collections; eq_()</span>
</span><span data-line="1279">        <span class="c1"># is only allowed with a scalar.</span>
</span><span data-line="1280">        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1281">            <span class="k">return</span> <span class="n">or_</span><span class="p">(</span>
</span><span data-line="1282">                <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">:</span> <span class="n">obj</span><span class="p">}),</span>
</span><span data-line="1283">                <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span> <span class="o">==</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1284">            <span class="p">)</span>
</span><span data-line="1285">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1286">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">:</span> <span class="n">obj</span><span class="p">})</span>
</span><span data-line="1287">
</span><span data-line="1288">    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>  <span class="c1"># type: ignore[override]  # noqa: E501</span>
</span><span data-line="1289">        <span class="c1"># note the has() here will fail for collections; eq_()</span>
</span><span data-line="1290">        <span class="c1"># is only allowed with a scalar.</span>
</span><span data-line="1291">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">has</span><span class="p">(</span>
</span><span data-line="1292">            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_attr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">obj</span>
</span><span data-line="1293">        <span class="p">)</span>
</span><span data-line="1294">
</span><span data-line="1295">
</span><span data-line="1296"><span class="k">class</span><span class="w"> </span><span class="nc">ColumnAssociationProxyInstance</span><span class="p">(</span><span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="1297"><span class="w">    </span><span class="sd">&quot;&quot;&quot;an :class:`.AssociationProxyInstance` that has a database column as a</span>
</span><span data-line="1298"><span class="sd">    target.</span>
</span><span data-line="1299"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1300">
</span><span data-line="1301">    <span class="n">_target_is_object</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1302">    <span class="n">_is_canonical</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1303">
</span><span data-line="1304">    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>  <span class="c1"># type: ignore[override]  # noqa: E501</span>
</span><span data-line="1305">        <span class="c1"># special case &quot;is None&quot; to check for no related row as well</span>
</span><span data-line="1306">        <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span>
</span><span data-line="1307">            <span class="bp">self</span><span class="o">.</span><span class="n">remote_attr</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">operators</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
</span><span data-line="1308">        <span class="p">)</span>
</span><span data-line="1309">        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1310">            <span class="k">return</span> <span class="n">or_</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="1311">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1312">            <span class="k">return</span> <span class="n">expr</span>
</span><span data-line="1313">
</span><span data-line="1314">    <span class="k">def</span><span class="w"> </span><span class="nf">operate</span><span class="p">(</span>
</span><span data-line="1315">        <span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">operators</span><span class="o">.</span><span class="n">OperatorType</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="1316">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="1317">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion_exists</span><span class="p">(</span>
</span><span data-line="1318">            <span class="bp">self</span><span class="o">.</span><span class="n">remote_attr</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="1319">        <span class="p">)</span>
</span><span data-line="1320">
</span><span data-line="1321">
</span><span data-line="1322"><span class="k">class</span><span class="w"> </span><span class="nc">_lazy_collection</span><span class="p">(</span><span class="n">_LazyCollectionProtocol</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="1323">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="1324">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">obj</span>
</span><span data-line="1325">        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
</span><span data-line="1326">
</span><span data-line="1327">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
</span><span data-line="1328">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1329">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">MutableSet</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">_T</span><span class="p">],</span> <span class="n">MutableSequence</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span data-line="1330">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>  <span class="c1"># type: ignore[no-any-return]</span>
</span><span data-line="1331">
</span><span data-line="1332">    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="1333">        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">}</span>
</span><span data-line="1334">
</span><span data-line="1335">    <span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1336">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span>
</span><span data-line="1337">        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span data-line="1338">
</span><span data-line="1339">
</span><span data-line="1340"><span class="n">_IT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_IT&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;Any&quot;</span><span class="p">)</span>
</span><span data-line="1341"><span class="sd">&quot;&quot;&quot;instance type - this is the type of object inside a collection.</span>
</span><span data-line="1342">
</span><span data-line="1343"><span class="sd">this is not the same as the _T of AssociationProxy and</span>
</span><span data-line="1344"><span class="sd">AssociationProxyInstance itself, which will often refer to the</span>
</span><span data-line="1345"><span class="sd">collection[_IT] type.</span>
</span><span data-line="1346">
</span><span data-line="1347"><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1348">
</span><span data-line="1349">
</span><span data-line="1350"><span class="k">class</span><span class="w"> </span><span class="nc">_AssociationCollection</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">_IT</span><span class="p">]):</span>
</span><span data-line="1351">    <span class="n">getter</span><span class="p">:</span> <span class="n">_GetterProtocol</span><span class="p">[</span><span class="n">_IT</span><span class="p">]</span>
</span><span data-line="1352"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A function.  Given an associated object, return the &#39;value&#39;.&quot;&quot;&quot;</span>
</span><span data-line="1353">
</span><span data-line="1354">    <span class="n">creator</span><span class="p">:</span> <span class="n">_CreatorProtocol</span>
</span><span data-line="1355"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1356"><span class="sd">    A function that creates new target entities.  Given one parameter:</span>
</span><span data-line="1357"><span class="sd">    value.  This assertion is assumed::</span>
</span><span data-line="1358">
</span><span data-line="1359"><span class="sd">    obj = creator(somevalue)</span>
</span><span data-line="1360"><span class="sd">    assert getter(obj) == somevalue</span>
</span><span data-line="1361"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1362">
</span><span data-line="1363">    <span class="n">parent</span><span class="p">:</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_IT</span><span class="p">]</span>
</span><span data-line="1364">    <span class="n">setter</span><span class="p">:</span> <span class="n">_SetterProtocol</span>
</span><span data-line="1365"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A function.  Given an associated object and a value, store that</span>
</span><span data-line="1366"><span class="sd">        value on the object.</span>
</span><span data-line="1367"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1368">
</span><span data-line="1369">    <span class="n">lazy_collection</span><span class="p">:</span> <span class="n">_LazyCollectionProtocol</span><span class="p">[</span><span class="n">_IT</span><span class="p">]</span>
</span><span data-line="1370"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A callable returning a list-based collection of entities (usually an</span>
</span><span data-line="1371"><span class="sd">          object attribute managed by a SQLAlchemy relationship())&quot;&quot;&quot;</span>
</span><span data-line="1372">
</span><span data-line="1373">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="1374">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1375">        <span class="n">lazy_collection</span><span class="p">:</span> <span class="n">_LazyCollectionProtocol</span><span class="p">[</span><span class="n">_IT</span><span class="p">],</span>
</span><span data-line="1376">        <span class="n">creator</span><span class="p">:</span> <span class="n">_CreatorProtocol</span><span class="p">,</span>
</span><span data-line="1377">        <span class="n">getter</span><span class="p">:</span> <span class="n">_GetterProtocol</span><span class="p">[</span><span class="n">_IT</span><span class="p">],</span>
</span><span data-line="1378">        <span class="n">setter</span><span class="p">:</span> <span class="n">_SetterProtocol</span><span class="p">,</span>
</span><span data-line="1379">        <span class="n">parent</span><span class="p">:</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">_IT</span><span class="p">],</span>
</span><span data-line="1380">    <span class="p">):</span>
</span><span data-line="1381"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs an _AssociationCollection.</span>
</span><span data-line="1382">
</span><span data-line="1383"><span class="sd">        This will always be a subclass of either _AssociationList,</span>
</span><span data-line="1384"><span class="sd">        _AssociationSet, or _AssociationDict.</span>
</span><span data-line="1385">
</span><span data-line="1386"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1387">        <span class="bp">self</span><span class="o">.</span><span class="n">lazy_collection</span> <span class="o">=</span> <span class="n">lazy_collection</span>
</span><span data-line="1388">        <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">creator</span>
</span><span data-line="1389">        <span class="bp">self</span><span class="o">.</span><span class="n">getter</span> <span class="o">=</span> <span class="n">getter</span>
</span><span data-line="1390">        <span class="bp">self</span><span class="o">.</span><span class="n">setter</span> <span class="o">=</span> <span class="n">setter</span>
</span><span data-line="1391">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span data-line="1392">
</span><span data-line="1393">    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="1394">        <span class="n">col</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">_IT</span><span class="p">]</span>
</span><span data-line="1395">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="1396">        <span class="n">col</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_collection</span><span class="p">())</span>
</span><span data-line="1397">
</span><span data-line="1398">    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span data-line="1399">        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
</span><span data-line="1400">
</span><span data-line="1401">    <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1402">        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
</span><span data-line="1403">
</span><span data-line="1404">    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="1405">        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;lazy_collection&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_collection</span><span class="p">}</span>
</span><span data-line="1406">
</span><span data-line="1407">    <span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1408">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span>
</span><span data-line="1409">        <span class="bp">self</span><span class="o">.</span><span class="n">lazy_collection</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;lazy_collection&quot;</span><span class="p">]</span>
</span><span data-line="1410">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_inflate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1411">
</span><span data-line="1412">    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1413">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1414">
</span><span data-line="1415">
</span><span data-line="1416"><span class="k">class</span><span class="w"> </span><span class="nc">_AssociationSingleItem</span><span class="p">(</span><span class="n">_AssociationCollection</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="1417">    <span class="n">setter</span><span class="p">:</span> <span class="n">_PlainSetterProtocol</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span>
</span><span data-line="1418">    <span class="n">creator</span><span class="p">:</span> <span class="n">_PlainCreatorProtocol</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span>
</span><span data-line="1419">
</span><span data-line="1420">    <span class="k">def</span><span class="w"> </span><span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="1421">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1422">
</span><span data-line="1423">    <span class="k">def</span><span class="w"> </span><span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span data-line="1424">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getter</span><span class="p">(</span><span class="n">object_</span><span class="p">)</span>
</span><span data-line="1425">
</span><span data-line="1426">    <span class="k">def</span><span class="w"> </span><span class="nf">_bulk_replace</span><span class="p">(</span>
</span><span data-line="1427">        <span class="bp">self</span><span class="p">,</span> <span class="n">assoc_proxy</span><span class="p">:</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_IT</span><span class="p">]</span>
</span><span data-line="1428">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1429">        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span data-line="1430">        <span class="n">assoc_proxy</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</span><span data-line="1431">
</span><span data-line="1432">
</span><span data-line="1433"><span class="k">class</span><span class="w"> </span><span class="nc">_AssociationList</span><span class="p">(</span><span class="n">_AssociationSingleItem</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">MutableSequence</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="1434"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic, converting, list-to-list proxy.&quot;&quot;&quot;</span>
</span><span data-line="1435">
</span><span data-line="1436">    <span class="n">col</span><span class="p">:</span> <span class="n">MutableSequence</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span>
</span><span data-line="1437">
</span><span data-line="1438">    <span class="k">def</span><span class="w"> </span><span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1439">        <span class="bp">self</span><span class="o">.</span><span class="n">setter</span><span class="p">(</span><span class="n">object_</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="1440">
</span><span data-line="1441">    <span class="nd">@overload</span>
</span><span data-line="1442">    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1443">
</span><span data-line="1444">    <span class="nd">@overload</span>
</span><span data-line="1445">    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MutableSequence</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="1446">
</span><span data-line="1447">    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span>
</span><span data-line="1448">        <span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]</span>
</span><span data-line="1449">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span data-line="1450">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span data-line="1451">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span data-line="1452">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1453">            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">member</span><span class="p">)</span> <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
</span><span data-line="1454">
</span><span data-line="1455">    <span class="nd">@overload</span>
</span><span data-line="1456">    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1457">
</span><span data-line="1458">    <span class="nd">@overload</span>
</span><span data-line="1459">    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">slice</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1460">
</span><span data-line="1461">    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span>
</span><span data-line="1462">        <span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_T</span><span class="p">]]</span>
</span><span data-line="1463">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1464">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span data-line="1465">            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</span><span data-line="1466">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1467">            <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1468">                <span class="n">stop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1469">            <span class="k">elif</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1470">                <span class="n">stop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span>
</span><span data-line="1471">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1472">                <span class="n">stop</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span>
</span><span data-line="1473">            <span class="n">step</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">step</span> <span class="ow">or</span> <span class="mi">1</span>
</span><span data-line="1474">
</span><span data-line="1475">            <span class="n">start</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span>
</span><span data-line="1476">            <span class="n">rng</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>
</span><span data-line="1477">
</span><span data-line="1478">            <span class="n">sized_value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1479">
</span><span data-line="1480">            <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="1481">                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rng</span><span class="p">:</span>
</span><span data-line="1482">                    <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">start</span><span class="p">]</span>
</span><span data-line="1483">                <span class="n">i</span> <span class="o">=</span> <span class="n">start</span>
</span><span data-line="1484">                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sized_value</span><span class="p">:</span>
</span><span data-line="1485">                    <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span><span data-line="1486">                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="1487">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1488">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sized_value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">):</span>
</span><span data-line="1489">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span data-line="1490">                        <span class="s2">&quot;attempt to assign sequence of size </span><span class="si">%s</span><span class="s2"> to &quot;</span>
</span><span data-line="1491">                        <span class="s2">&quot;extended slice of size </span><span class="si">%s</span><span class="s2">&quot;</span>
</span><span data-line="1492">                        <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sized_value</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">))</span>
</span><span data-line="1493">                    <span class="p">)</span>
</span><span data-line="1494">                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span data-line="1495">                    <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">item</span><span class="p">)</span>
</span><span data-line="1496">
</span><span data-line="1497">    <span class="nd">@overload</span>
</span><span data-line="1498">    <span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1499">
</span><span data-line="1500">    <span class="nd">@overload</span>
</span><span data-line="1501">    <span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1502">
</span><span data-line="1503">    <span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1504">        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span data-line="1505">
</span><span data-line="1506">    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1507">        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
</span><span data-line="1508">            <span class="c1"># testlib.pragma exempt:__eq__</span>
</span><span data-line="1509">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">member</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
</span><span data-line="1510">                <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="1511">        <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="1512">
</span><span data-line="1513">    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1514"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over proxied values.</span>
</span><span data-line="1515">
</span><span data-line="1516"><span class="sd">        For the actual domain objects, iterate over .col instead or</span>
</span><span data-line="1517"><span class="sd">        just use the underlying collection directly from its property</span>
</span><span data-line="1518"><span class="sd">        on the parent.</span>
</span><span data-line="1519"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1520">
</span><span data-line="1521">        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
</span><span data-line="1522">            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span data-line="1523">        <span class="k">return</span>
</span><span data-line="1524">
</span><span data-line="1525">    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1526">        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span>
</span><span data-line="1527">        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1528">        <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span data-line="1529">
</span><span data-line="1530">    <span class="k">def</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span data-line="1531">        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1532">        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
</span><span data-line="1533">            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
</span><span data-line="1534">                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="1535">        <span class="k">return</span> <span class="n">count</span>
</span><span data-line="1536">
</span><span data-line="1537">    <span class="k">def</span><span class="w"> </span><span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1538">        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
</span><span data-line="1539">            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span data-line="1540">
</span><span data-line="1541">    <span class="k">def</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1542">        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
</span><span data-line="1543">
</span><span data-line="1544">    <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span data-line="1545">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span><span data-line="1546">
</span><span data-line="1547">    <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1548">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1549">            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
</span><span data-line="1550">                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="1551">                <span class="k">return</span>
</span><span data-line="1552">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;value not in list&quot;</span><span class="p">)</span>
</span><span data-line="1553">
</span><span data-line="1554">    <span class="k">def</span><span class="w"> </span><span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="1555"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Not supported, use reversed(mylist)&quot;&quot;&quot;</span>
</span><span data-line="1556">
</span><span data-line="1557">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1558">
</span><span data-line="1559">    <span class="k">def</span><span class="w"> </span><span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="1560"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Not supported, use sorted(mylist)&quot;&quot;&quot;</span>
</span><span data-line="1561">
</span><span data-line="1562">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1563">
</span><span data-line="1564">    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1565">        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)]</span>
</span><span data-line="1566">
</span><span data-line="1567">    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1568">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">other</span>
</span><span data-line="1569">
</span><span data-line="1570">    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1571">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="n">other</span>
</span><span data-line="1572">
</span><span data-line="1573">    <span class="k">def</span><span class="w"> </span><span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1574">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">other</span>
</span><span data-line="1575">
</span><span data-line="1576">    <span class="k">def</span><span class="w"> </span><span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1577">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">other</span>
</span><span data-line="1578">
</span><span data-line="1579">    <span class="k">def</span><span class="w"> </span><span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1580">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">other</span>
</span><span data-line="1581">
</span><span data-line="1582">    <span class="k">def</span><span class="w"> </span><span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1583">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">other</span>
</span><span data-line="1584">
</span><span data-line="1585">    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1586">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1587">            <span class="n">other</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span data-line="1588">        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span data-line="1589">            <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span data-line="1590">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">other</span>
</span><span data-line="1591">
</span><span data-line="1592">    <span class="k">def</span><span class="w"> </span><span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1593">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1594">            <span class="n">other</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span data-line="1595">        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span data-line="1596">            <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span data-line="1597">        <span class="k">return</span> <span class="n">other</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1598">
</span><span data-line="1599">    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">SupportsIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1600">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="1601">            <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span data-line="1602">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span>
</span><span data-line="1603">
</span><span data-line="1604">    <span class="k">def</span><span class="w"> </span><span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">SupportsIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1605">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="1606">            <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span data-line="1607">        <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1608">
</span><span data-line="1609">    <span class="k">def</span><span class="w"> </span><span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span data-line="1610">        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span><span data-line="1611">        <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="1612">
</span><span data-line="1613">    <span class="k">def</span><span class="w"> </span><span class="fm">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">SupportsIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span data-line="1614">        <span class="c1"># unlike a regular list *=, proxied __imul__ will generate unique</span>
</span><span data-line="1615">        <span class="c1"># backing objects for each copy.  *= on proxied lists is a bit of</span>
</span><span data-line="1616">        <span class="c1"># a stretch anyhow, and this interpretation of the __imul__ contract</span>
</span><span data-line="1617">        <span class="c1"># is more plausibly useful than copying the backing objects.</span>
</span><span data-line="1618">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="1619">            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1620">        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1621">            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span data-line="1622">        <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="1623">            <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span data-line="1624">        <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="1625">
</span><span data-line="1626">    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="1627">        <span class="c1"># TODO: no idea how to do this without separate &quot;stub&quot;</span>
</span><span data-line="1628">        <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span>
</span><span data-line="1629">            <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">...</span>
</span><span data-line="1630">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1631">
</span><span data-line="1632">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="1633">
</span><span data-line="1634">        <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span data-line="1635">            <span class="n">ls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1636">            <span class="k">return</span> <span class="n">ls</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span><span data-line="1637">
</span><span data-line="1638">    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1639">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1640">
</span><span data-line="1641">    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="1642">        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</span><span data-line="1643">
</span><span data-line="1644">    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="1645">        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> objects are unhashable&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span data-line="1646">
</span><span data-line="1647">    <span class="k">if</span> <span class="ow">not</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="1648">        <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span data-line="1649">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1650">                <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span data-line="1651">                <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">func_name</span>
</span><span data-line="1652">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span data-line="1653">                <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
</span><span data-line="1654">            <span class="p">):</span>
</span><span data-line="1655">                <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span data-line="1656">        <span class="k">del</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func</span>
</span><span data-line="1657">
</span><span data-line="1658">
</span><span data-line="1659"><span class="k">class</span><span class="w"> </span><span class="nc">_AssociationDict</span><span class="p">(</span><span class="n">_AssociationCollection</span><span class="p">[</span><span class="n">_VT</span><span class="p">],</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">_KT</span><span class="p">,</span> <span class="n">_VT</span><span class="p">]):</span>
</span><span data-line="1660"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic, converting, dict-to-dict proxy.&quot;&quot;&quot;</span>
</span><span data-line="1661">
</span><span data-line="1662">    <span class="n">setter</span><span class="p">:</span> <span class="n">_DictSetterProtocol</span><span class="p">[</span><span class="n">_VT</span><span class="p">]</span>
</span><span data-line="1663">    <span class="n">creator</span><span class="p">:</span> <span class="n">_KeyCreatorProtocol</span><span class="p">[</span><span class="n">_VT</span><span class="p">]</span>
</span><span data-line="1664">    <span class="n">col</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">_KT</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_VT</span><span class="p">]]</span>
</span><span data-line="1665">
</span><span data-line="1666">    <span class="k">def</span><span class="w"> </span><span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_VT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="1667">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="1668">
</span><span data-line="1669">    <span class="k">def</span><span class="w"> </span><span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_VT</span><span class="p">:</span>
</span><span data-line="1670">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getter</span><span class="p">(</span><span class="n">object_</span><span class="p">)</span>
</span><span data-line="1671">
</span><span data-line="1672">    <span class="k">def</span><span class="w"> </span><span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_VT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1673">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">setter</span><span class="p">(</span><span class="n">object_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="1674">
</span><span data-line="1675">    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_VT</span><span class="p">:</span>
</span><span data-line="1676">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span data-line="1677">
</span><span data-line="1678">    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_VT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1679">        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
</span><span data-line="1680">            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="1681">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1682">            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="1683">
</span><span data-line="1684">    <span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1685">        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1686">
</span><span data-line="1687">    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1688">        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span>
</span><span data-line="1689">
</span><span data-line="1690">    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_KT</span><span class="p">]:</span>
</span><span data-line="1691">        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span data-line="1692">
</span><span data-line="1693">    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1694">        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span data-line="1695">
</span><span data-line="1696">    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1697">        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">other</span>
</span><span data-line="1698">
</span><span data-line="1699">    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1700">        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="n">other</span>
</span><span data-line="1701">
</span><span data-line="1702">    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="1703">        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</span><span data-line="1704">
</span><span data-line="1705">    <span class="nd">@overload</span>
</span><span data-line="1706">    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_VT</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="1707">
</span><span data-line="1708">    <span class="nd">@overload</span>
</span><span data-line="1709">    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_VT</span><span class="p">,</span> <span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">_VT</span><span class="p">,</span> <span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="1710">
</span><span data-line="1711">    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
</span><span data-line="1712">        <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">_VT</span><span class="p">,</span> <span class="n">_T</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1713">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">_VT</span><span class="p">,</span> <span class="n">_T</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span data-line="1714">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1715">            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1716">        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span data-line="1717">            <span class="k">return</span> <span class="n">default</span>
</span><span data-line="1718">
</span><span data-line="1719">    <span class="k">def</span><span class="w"> </span><span class="nf">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_VT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_VT</span><span class="p">:</span>
</span><span data-line="1720">        <span class="c1"># TODO: again, no idea how to create an actual MutableMapping.</span>
</span><span data-line="1721">        <span class="c1"># default must allow None, return type can&#39;t include None,</span>
</span><span data-line="1722">        <span class="c1"># the stub explicitly allows for default of None with a cryptic message</span>
</span><span data-line="1723">        <span class="c1"># &quot;This overload should be allowed only if the value type is</span>
</span><span data-line="1724">        <span class="c1"># compatible with None.&quot;.</span>
</span><span data-line="1725">        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
</span><span data-line="1726">            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
</span><span data-line="1727">            <span class="k">return</span> <span class="n">default</span>  <span class="c1"># type: ignore</span>
</span><span data-line="1728">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1729">            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1730">
</span><span data-line="1731">    <span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KeysView</span><span class="p">[</span><span class="n">_KT</span><span class="p">]:</span>
</span><span data-line="1732">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span data-line="1733">
</span><span data-line="1734">    <span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemsView</span><span class="p">[</span><span class="n">_KT</span><span class="p">,</span> <span class="n">_VT</span><span class="p">]:</span>
</span><span data-line="1735">        <span class="k">return</span> <span class="n">ItemsView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1736">
</span><span data-line="1737">    <span class="k">def</span><span class="w"> </span><span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValuesView</span><span class="p">[</span><span class="n">_VT</span><span class="p">]:</span>
</span><span data-line="1738">        <span class="k">return</span> <span class="n">ValuesView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1739">
</span><span data-line="1740">    <span class="nd">@overload</span>
</span><span data-line="1741">    <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_VT</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1742">
</span><span data-line="1743">    <span class="nd">@overload</span>
</span><span data-line="1744">    <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span>
</span><span data-line="1745">        <span class="bp">self</span><span class="p">,</span> <span class="n">__key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_VT</span><span class="p">,</span> <span class="n">_T</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
</span><span data-line="1746">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">_VT</span><span class="p">,</span> <span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="1747">
</span><span data-line="1748">    <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__key</span><span class="p">:</span> <span class="n">_KT</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">_VT</span><span class="p">,</span> <span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1749">        <span class="n">member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">__key</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="1750">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span data-line="1751">
</span><span data-line="1752">    <span class="k">def</span><span class="w"> </span><span class="nf">popitem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">_KT</span><span class="p">,</span> <span class="n">_VT</span><span class="p">]:</span>
</span><span data-line="1753">        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
</span><span data-line="1754">        <span class="k">return</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span data-line="1755">
</span><span data-line="1756">    <span class="nd">@overload</span>
</span><span data-line="1757">    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span>
</span><span data-line="1758">        <span class="bp">self</span><span class="p">,</span> <span class="n">__m</span><span class="p">:</span> <span class="n">SupportsKeysAndGetItem</span><span class="p">[</span><span class="n">_KT</span><span class="p">,</span> <span class="n">_VT</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">_VT</span>
</span><span data-line="1759">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1760">
</span><span data-line="1761">    <span class="nd">@overload</span>
</span><span data-line="1762">    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span>
</span><span data-line="1763">        <span class="bp">self</span><span class="p">,</span> <span class="n">__m</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_KT</span><span class="p">,</span> <span class="n">_VT</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">_VT</span>
</span><span data-line="1764">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1765">
</span><span data-line="1766">    <span class="nd">@overload</span>
</span><span data-line="1767">    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">_VT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1768">
</span><span data-line="1769">    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1770">        <span class="n">up</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">_KT</span><span class="p">,</span> <span class="n">_VT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1771">        <span class="n">up</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="1772">
</span><span data-line="1773">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">up</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="1774">            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="1775">
</span><span data-line="1776">    <span class="k">def</span><span class="w"> </span><span class="nf">_bulk_replace</span><span class="p">(</span>
</span><span data-line="1777">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1778">        <span class="n">assoc_proxy</span><span class="p">:</span> <span class="n">AssociationProxyInstance</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1779">        <span class="n">values</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">_KT</span><span class="p">,</span> <span class="n">_VT</span><span class="p">],</span>
</span><span data-line="1780">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1781">        <span class="n">existing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1782">        <span class="n">constants</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">values</span> <span class="ow">or</span> <span class="p">())</span>
</span><span data-line="1783">        <span class="n">additions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">values</span> <span class="ow">or</span> <span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">constants</span><span class="p">)</span>
</span><span data-line="1784">        <span class="n">removals</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">constants</span><span class="p">)</span>
</span><span data-line="1785">
</span><span data-line="1786">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="ow">or</span> <span class="p">():</span>
</span><span data-line="1787">            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">additions</span><span class="p">:</span>
</span><span data-line="1788">                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">member</span>
</span><span data-line="1789">            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">constants</span><span class="p">:</span>
</span><span data-line="1790">                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">member</span>
</span><span data-line="1791">
</span><span data-line="1792">        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">removals</span><span class="p">:</span>
</span><span data-line="1793">            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1794">
</span><span data-line="1795">    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">_KT</span><span class="p">,</span> <span class="n">_VT</span><span class="p">]:</span>
</span><span data-line="1796">        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span><span data-line="1797">
</span><span data-line="1798">    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="1799">        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> objects are unhashable&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span data-line="1800">
</span><span data-line="1801">    <span class="k">if</span> <span class="ow">not</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="1802">        <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span data-line="1803">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1804">                <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span data-line="1805">                <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">func_name</span>
</span><span data-line="1806">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span data-line="1807">                <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
</span><span data-line="1808">            <span class="p">):</span>
</span><span data-line="1809">                <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span data-line="1810">        <span class="k">del</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func</span>
</span><span data-line="1811">
</span><span data-line="1812">
</span><span data-line="1813"><span class="k">class</span><span class="w"> </span><span class="nc">_AssociationSet</span><span class="p">(</span><span class="n">_AssociationSingleItem</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="1814"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic, converting, set-to-set proxy.&quot;&quot;&quot;</span>
</span><span data-line="1815">
</span><span data-line="1816">    <span class="n">col</span><span class="p">:</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span>
</span><span data-line="1817">
</span><span data-line="1818">    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span data-line="1819">        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
</span><span data-line="1820">
</span><span data-line="1821">    <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1822">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
</span><span data-line="1823">            <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="1824">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1825">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="1826">
</span><span data-line="1827">    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__o</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1828">        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
</span><span data-line="1829">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">member</span><span class="p">)</span> <span class="o">==</span> <span class="n">__o</span><span class="p">:</span>
</span><span data-line="1830">                <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="1831">        <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="1832">
</span><span data-line="1833">    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1834"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over proxied values.</span>
</span><span data-line="1835">
</span><span data-line="1836"><span class="sd">        For the actual domain objects, iterate over .col instead or just use</span>
</span><span data-line="1837"><span class="sd">        the underlying collection directly from its property on the parent.</span>
</span><span data-line="1838">
</span><span data-line="1839"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1840">        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
</span><span data-line="1841">            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span data-line="1842">        <span class="k">return</span>
</span><span data-line="1843">
</span><span data-line="1844">    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__element</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1845">        <span class="k">if</span> <span class="n">__element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
</span><span data-line="1846">            <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">__element</span><span class="p">))</span>
</span><span data-line="1847">
</span><span data-line="1848">    <span class="c1"># for discard and remove, choosing a more expensive check strategy rather</span>
</span><span data-line="1849">    <span class="c1"># than call self.creator()</span>
</span><span data-line="1850">    <span class="k">def</span><span class="w"> </span><span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__element</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1851">        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
</span><span data-line="1852">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">member</span><span class="p">)</span> <span class="o">==</span> <span class="n">__element</span><span class="p">:</span>
</span><span data-line="1853">                <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span data-line="1854">                <span class="k">break</span>
</span><span data-line="1855">
</span><span data-line="1856">    <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__element</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1857">        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
</span><span data-line="1858">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">member</span><span class="p">)</span> <span class="o">==</span> <span class="n">__element</span><span class="p">:</span>
</span><span data-line="1859">                <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span data-line="1860">                <span class="k">return</span>
</span><span data-line="1861">        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">__element</span><span class="p">)</span>
</span><span data-line="1862">
</span><span data-line="1863">    <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span data-line="1864">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
</span><span data-line="1865">            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;pop from an empty set&quot;</span><span class="p">)</span>
</span><span data-line="1866">        <span class="n">member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span data-line="1867">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span data-line="1868">
</span><span data-line="1869">    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1870">        <span class="k">for</span> <span class="n">iterable</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
</span><span data-line="1871">            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
</span><span data-line="1872">                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1873">
</span><span data-line="1874">    <span class="k">def</span><span class="w"> </span><span class="nf">_bulk_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assoc_proxy</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1875">        <span class="n">existing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1876">        <span class="n">constants</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">values</span> <span class="ow">or</span> <span class="p">())</span>
</span><span data-line="1877">        <span class="n">additions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">values</span> <span class="ow">or</span> <span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">constants</span><span class="p">)</span>
</span><span data-line="1878">        <span class="n">removals</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">constants</span><span class="p">)</span>
</span><span data-line="1879">
</span><span data-line="1880">        <span class="n">appender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span>
</span><span data-line="1881">        <span class="n">remover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove</span>
</span><span data-line="1882">
</span><span data-line="1883">        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">values</span> <span class="ow">or</span> <span class="p">():</span>
</span><span data-line="1884">            <span class="k">if</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">additions</span><span class="p">:</span>
</span><span data-line="1885">                <span class="n">appender</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span data-line="1886">            <span class="k">elif</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">constants</span><span class="p">:</span>
</span><span data-line="1887">                <span class="n">appender</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span data-line="1888">
</span><span data-line="1889">        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">removals</span><span class="p">:</span>
</span><span data-line="1890">            <span class="n">remover</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span data-line="1891">
</span><span data-line="1892">    <span class="k">def</span><span class="w"> </span><span class="fm">__ior__</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
</span><span data-line="1893">        <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">_S</span><span class="p">]</span>
</span><span data-line="1894">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="n">_S</span><span class="p">]]:</span>
</span><span data-line="1895">        <span class="k">if</span> <span class="ow">not</span> <span class="n">collections</span><span class="o">.</span><span class="n">_set_binops_check_strict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span data-line="1896">            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1897">        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
</span><span data-line="1898">            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1899">        <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="1900">
</span><span data-line="1901">    <span class="k">def</span><span class="w"> </span><span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1902">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</span><span data-line="1903">
</span><span data-line="1904">    <span class="k">def</span><span class="w"> </span><span class="nf">union</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_S</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="n">_S</span><span class="p">]]:</span>
</span><span data-line="1905">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span><span data-line="1906">
</span><span data-line="1907">    <span class="k">def</span><span class="w"> </span><span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__s</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">_S</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="n">_S</span><span class="p">]]:</span>
</span><span data-line="1908">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">__s</span><span class="p">)</span>
</span><span data-line="1909">
</span><span data-line="1910">    <span class="k">def</span><span class="w"> </span><span class="nf">difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1911">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span><span data-line="1912">
</span><span data-line="1913">    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1914">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span data-line="1915">
</span><span data-line="1916">    <span class="k">def</span><span class="w"> </span><span class="nf">difference_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1917">        <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
</span><span data-line="1918">            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
</span><span data-line="1919">                <span class="bp">self</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1920">
</span><span data-line="1921">    <span class="k">def</span><span class="w"> </span><span class="fm">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span data-line="1922">        <span class="k">if</span> <span class="ow">not</span> <span class="n">collections</span><span class="o">.</span><span class="n">_set_binops_check_strict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
</span><span data-line="1923">            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1924">        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
</span><span data-line="1925">            <span class="bp">self</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1926">        <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="1927">
</span><span data-line="1928">    <span class="k">def</span><span class="w"> </span><span class="nf">intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1929">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span><span data-line="1930">
</span><span data-line="1931">    <span class="k">def</span><span class="w"> </span><span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1932">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span data-line="1933">
</span><span data-line="1934">    <span class="k">def</span><span class="w"> </span><span class="nf">intersection_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1935">        <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
</span><span data-line="1936">            <span class="n">want</span><span class="p">,</span> <span class="n">have</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1937">
</span><span data-line="1938">            <span class="n">remove</span><span class="p">,</span> <span class="n">add</span> <span class="o">=</span> <span class="n">have</span> <span class="o">-</span> <span class="n">want</span><span class="p">,</span> <span class="n">want</span> <span class="o">-</span> <span class="n">have</span>
</span><span data-line="1939">
</span><span data-line="1940">            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
</span><span data-line="1941">                <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1942">            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">add</span><span class="p">:</span>
</span><span data-line="1943">                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1944">
</span><span data-line="1945">    <span class="k">def</span><span class="w"> </span><span class="fm">__iand__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span data-line="1946">        <span class="k">if</span> <span class="ow">not</span> <span class="n">collections</span><span class="o">.</span><span class="n">_set_binops_check_strict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
</span><span data-line="1947">            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1948">        <span class="n">want</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span data-line="1949">        <span class="n">have</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1950">
</span><span data-line="1951">        <span class="n">remove</span><span class="p">,</span> <span class="n">add</span> <span class="o">=</span> <span class="n">have</span> <span class="o">-</span> <span class="n">want</span><span class="p">,</span> <span class="n">want</span> <span class="o">-</span> <span class="n">have</span>
</span><span data-line="1952">
</span><span data-line="1953">        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
</span><span data-line="1954">            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1955">        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">add</span><span class="p">:</span>
</span><span data-line="1956">            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1957">        <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="1958">
</span><span data-line="1959">    <span class="k">def</span><span class="w"> </span><span class="nf">symmetric_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1960">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="n">__s</span><span class="p">)</span>
</span><span data-line="1961">
</span><span data-line="1962">    <span class="k">def</span><span class="w"> </span><span class="fm">__xor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">_S</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="n">_S</span><span class="p">]]:</span>
</span><span data-line="1963">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span data-line="1964">
</span><span data-line="1965">    <span class="k">def</span><span class="w"> </span><span class="nf">symmetric_difference_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1966">        <span class="n">want</span><span class="p">,</span> <span class="n">have</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1967">
</span><span data-line="1968">        <span class="n">remove</span><span class="p">,</span> <span class="n">add</span> <span class="o">=</span> <span class="n">have</span> <span class="o">-</span> <span class="n">want</span><span class="p">,</span> <span class="n">want</span> <span class="o">-</span> <span class="n">have</span>
</span><span data-line="1969">
</span><span data-line="1970">        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
</span><span data-line="1971">            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1972">        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">add</span><span class="p">:</span>
</span><span data-line="1973">            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1974">
</span><span data-line="1975">    <span class="k">def</span><span class="w"> </span><span class="fm">__ixor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">_S</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MutableSet</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="n">_S</span><span class="p">]]:</span>  <span class="c1"># type: ignore  # noqa: E501</span>
</span><span data-line="1976">        <span class="k">if</span> <span class="ow">not</span> <span class="n">collections</span><span class="o">.</span><span class="n">_set_binops_check_strict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span data-line="1977">            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1978">
</span><span data-line="1979">        <span class="bp">self</span><span class="o">.</span><span class="n">symmetric_difference_update</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span data-line="1980">        <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="1981">
</span><span data-line="1982">    <span class="k">def</span><span class="w"> </span><span class="nf">issubset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1983">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">__s</span><span class="p">)</span>
</span><span data-line="1984">
</span><span data-line="1985">    <span class="k">def</span><span class="w"> </span><span class="nf">issuperset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1986">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">__s</span><span class="p">)</span>
</span><span data-line="1987">
</span><span data-line="1988">    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1989">        <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span data-line="1990">
</span><span data-line="1991">    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1992">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1993">
</span><span data-line="1994">    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1995">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">other</span>
</span><span data-line="1996">
</span><span data-line="1997">    <span class="k">def</span><span class="w"> </span><span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1998">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="n">other</span>
</span><span data-line="1999">
</span><span data-line="2000">    <span class="k">def</span><span class="w"> </span><span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2001">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">other</span>
</span><span data-line="2002">
</span><span data-line="2003">    <span class="k">def</span><span class="w"> </span><span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2004">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">other</span>
</span><span data-line="2005">
</span><span data-line="2006">    <span class="k">def</span><span class="w"> </span><span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2007">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">other</span>
</span><span data-line="2008">
</span><span data-line="2009">    <span class="k">def</span><span class="w"> </span><span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">AbstractSet</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2010">        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">other</span>
</span><span data-line="2011">
</span><span data-line="2012">    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="2013">        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</span><span data-line="2014">
</span><span data-line="2015">    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="2016">        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> objects are unhashable&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span data-line="2017">
</span><span data-line="2018">    <span class="k">if</span> <span class="ow">not</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="2019">        <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span data-line="2020">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2021">                <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span data-line="2022">                <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">func_name</span>
</span><span data-line="2023">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span data-line="2024">                <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
</span><span data-line="2025">            <span class="p">):</span>
</span><span data-line="2026">                <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span data-line="2027">        <span class="k">del</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func</span>
</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, Alexander Matveev</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials">
<a href="https://github.com/bizoxe/iron-track" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../../_static/shibuya.js?v=c1cf1a6b"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";

const defaultStyle = document.createElement('style');
defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}
`;
document.head.appendChild(defaultStyle);

const fullscreenStyle = document.createElement('style');
fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
document.head.appendChild(fullscreenStyle);

// Detect if page has dark background
const isDarkTheme = () => {
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness < 128;
    }
    return false;
};

const load = async () => {
    await mermaid.run();

    const all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(load, 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(load, 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(load, 200);
        return;
    }

    const darkTheme = isDarkTheme();

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    const modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen"></button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    const modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    let previousScrollOffset = [window.scrollX, window.scrollY];

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    const allButtons = [];

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = '';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        container.appendChild(fullscreenBtn);
        allButtons.push(fullscreenBtn);
    });

    // Update theme classes when theme changes
    const updateTheme = () => {
        const dark = isDarkTheme();
        allButtons.forEach(btn => {
            if (dark) {
                btn.classList.add('dark-theme');
            } else {
                btn.classList.remove('dark-theme');
            }
        });
        if (dark) {
            modal.classList.add('dark-theme');
            modalContent.classList.add('dark-theme');
            closeBtn.classList.add('dark-theme');
        } else {
            modal.classList.remove('dark-theme');
            modalContent.classList.remove('dark-theme');
            closeBtn.classList.remove('dark-theme');
        }
    };

    // Watch for theme changes
    const observer = new MutationObserver(updateTheme);
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style']
    });
};

window.addEventListener("load", load);
</script></body>
</html>