<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>sqlalchemy.orm.attributes - IronTrack Docs</title><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=14737038" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sqlalchemy.orm.attributes"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../../index.html">
      <img class="light-logo" src="../../../_static/logo.svg" alt="irontrack" height="28" loading="lazy" />
      <img class="dark-logo" src="../../../_static/logo.svg" alt="irontrack" height="28" loading="lazy" />
      <strong>irontrack</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"><ul><li class="link"><a href="../../../usage/installation.html">Installation</a></li><li class="link"><a href="../../../api/index.html">API Reference</a></li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials">
  <a href="https://github.com/bizoxe/iron-track" aria-label="GitHub">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </a></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/index.html">Usage Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/development.html">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/cli-guide.html">CLI Guide</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/scripts/index.html">Application Scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/scripts/commands.html">User Management CLI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/scripts/seeder.html">Database Seeding Script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/server/index.html">Core Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/server/core.html">Server Core</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/config/index.html">Application Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/config/base.html">Base Settings Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/config/app_settings.html">SQLAlchemy and Dependency Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/config/constants.html">Application Constants</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/db/index.html">ORM Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/db/base.html">Base Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/db/user.html">User Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/db/role.html">Role Model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/lib/index.html">Core Utilities (lib)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/auth.html">JWT Cookie Security Scheme</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/cache_key_builders.html">Cache Key Builders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/coders.html">Cache Serialization Coders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/deps.html">Module Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/exceptions.html">API Exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/handlers.html">Exception Handlers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/invalidate_cache.html">Cache Invalidation Helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/json_response.html">Custom JSON Response</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/jwt_utils.html">JWT Utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lib/pretty_regex_error_msgs.html">Custom Regex Errors</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utils/index.html">Utilities and Helpers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils/log_utils/index.html">Structured Logging Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils/log_utils/handlers.html">Logging Handlers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils/log_utils/setup.html">Logging Setup and Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils/log_utils/middleware.html">ASGI Logging Middleware</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils/server_cli.html">Server CLI Commands</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/main.html">Entry Point (main.py)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/domain/index.html">Domains Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/domain/users/index.html">Users Domain</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/controllers/access.html">Access Controllers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/controllers/users.html">User CRUD Controllers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/controllers/user_role.html">User Role Management Controllers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/services.html">User and Role Services</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/schemas.html">User Domain Schemas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/auth.html">Authentication Utilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/utils.html">User Utilities and Helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/deps.html">User Domain Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/domain/users/jwt_helpers.html">JWT Token Utilities</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contribution-guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../index.html"><span itemprop="name">irontrack</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">sqlalchemy.orm.attributes</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sqlalchemy.orm.attributes</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="c1"># orm/attributes.py</span>
</span><span data-line="2"><span class="c1"># Copyright (C) 2005-2025 the SQLAlchemy authors and contributors</span>
</span><span data-line="3"><span class="c1"># &lt;see AUTHORS file&gt;</span>
</span><span data-line="4"><span class="c1">#</span>
</span><span data-line="5"><span class="c1"># This module is part of SQLAlchemy and is released under</span>
</span><span data-line="6"><span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
</span><span data-line="7"><span class="c1"># mypy: allow-untyped-defs, allow-untyped-calls</span>
</span><span data-line="8">
</span><span data-line="9"><span class="sd">&quot;&quot;&quot;Defines instrumentation for class attributes and their interaction</span>
</span><span data-line="10"><span class="sd">with instances.</span>
</span><span data-line="11">
</span><span data-line="12"><span class="sd">This module is usually not directly visible to user applications, but</span>
</span><span data-line="13"><span class="sd">defines a large part of the ORM&#39;s interactivity.</span>
</span><span data-line="14">
</span><span data-line="15">
</span><span data-line="16"><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="17">
</span><span data-line="18"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="19">
</span><span data-line="20"><span class="kn">import</span><span class="w"> </span><span class="nn">dataclasses</span>
</span><span data-line="21"><span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
</span><span data-line="22"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span data-line="23"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
</span><span data-line="24"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span>
</span><span data-line="25"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClassVar</span>
</span><span data-line="26"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
</span><span data-line="27"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
</span><span data-line="28"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</span><span data-line="29"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTuple</span>
</span><span data-line="30"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span data-line="31"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">overload</span>
</span><span data-line="32"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
</span><span data-line="33"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span>
</span><span data-line="34"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Type</span>
</span><span data-line="35"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span data-line="36"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeVar</span>
</span><span data-line="37"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span data-line="38">
</span><span data-line="39"><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">collections</span>
</span><span data-line="40"><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">orm_exc</span>
</span><span data-line="41"><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">interfaces</span>
</span><span data-line="42"><span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">insp_is_aliased_class</span>
</span><span data-line="43"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DeclarativeMapped</span>
</span><span data-line="44"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ATTR_EMPTY</span>
</span><span data-line="45"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ATTR_WAS_SET</span>
</span><span data-line="46"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">CALLABLES_OK</span>
</span><span data-line="47"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEFERRED_HISTORY_LOAD</span>
</span><span data-line="48"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">INCLUDE_PENDING_MUTATIONS</span>  <span class="c1"># noqa</span>
</span><span data-line="49"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">INIT_OK</span>
</span><span data-line="50"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">instance_dict</span> <span class="k">as</span> <span class="n">instance_dict</span>
</span><span data-line="51"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">instance_state</span> <span class="k">as</span> <span class="n">instance_state</span>
</span><span data-line="52"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">instance_str</span>
</span><span data-line="53"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">LOAD_AGAINST_COMMITTED</span>
</span><span data-line="54"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoaderCallableStatus</span>
</span><span data-line="55"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">manager_of_class</span> <span class="k">as</span> <span class="n">manager_of_class</span>
</span><span data-line="56"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span> <span class="k">as</span> <span class="n">Mapped</span>  <span class="c1"># noqa</span>
</span><span data-line="57"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NEVER_SET</span>  <span class="c1"># noqa</span>
</span><span data-line="58"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NO_AUTOFLUSH</span>
</span><span data-line="59"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NO_CHANGE</span>  <span class="c1"># noqa</span>
</span><span data-line="60"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NO_KEY</span>
</span><span data-line="61"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NO_RAISE</span>
</span><span data-line="62"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NO_VALUE</span>
</span><span data-line="63"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NON_PERSISTENT_OK</span>  <span class="c1"># noqa</span>
</span><span data-line="64"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">opt_manager_of_class</span> <span class="k">as</span> <span class="n">opt_manager_of_class</span>
</span><span data-line="65"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_CLASS_MISMATCH</span>  <span class="c1"># noqa</span>
</span><span data-line="66"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_NO_FETCH</span>
</span><span data-line="67"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_NO_FETCH_RELATED</span>  <span class="c1"># noqa</span>
</span><span data-line="68"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_NO_INITIALIZE</span>
</span><span data-line="69"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span data-line="70"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_OFF</span>
</span><span data-line="71"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_ONLY_PERSISTENT</span>
</span><span data-line="72"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_RETURN_NO_VALUE</span>
</span><span data-line="73"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PassiveFlag</span>
</span><span data-line="74"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">RELATED_OBJECT_OK</span>  <span class="c1"># noqa</span>
</span><span data-line="75"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQL_OK</span>  <span class="c1"># noqa</span>
</span><span data-line="76"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLORMExpression</span>
</span><span data-line="77"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">state_str</span>
</span><span data-line="78"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">event</span>
</span><span data-line="79"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">exc</span>
</span><span data-line="80"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspection</span>
</span><span data-line="81"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">util</span>
</span><span data-line="82"><span class="kn">from</span><span class="w"> </span><span class="nn">..event</span><span class="w"> </span><span class="kn">import</span> <span class="n">dispatcher</span>
</span><span data-line="83"><span class="kn">from</span><span class="w"> </span><span class="nn">..event</span><span class="w"> </span><span class="kn">import</span> <span class="n">EventTarget</span>
</span><span data-line="84"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">base</span> <span class="k">as</span> <span class="n">sql_base</span>
</span><span data-line="85"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache_key</span>
</span><span data-line="86"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">coercions</span>
</span><span data-line="87"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">roles</span>
</span><span data-line="88"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">visitors</span>
</span><span data-line="89"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.cache_key</span><span class="w"> </span><span class="kn">import</span> <span class="n">HasCacheKey</span>
</span><span data-line="90"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.visitors</span><span class="w"> </span><span class="kn">import</span> <span class="n">_TraverseInternalsType</span>
</span><span data-line="91"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.visitors</span><span class="w"> </span><span class="kn">import</span> <span class="n">InternalTraversal</span>
</span><span data-line="92"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
</span><span data-line="93"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Self</span>
</span><span data-line="94"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeGuard</span>
</span><span data-line="95">
</span><span data-line="96"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="97">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_EntityType</span>
</span><span data-line="98">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_ExternalEntityType</span>
</span><span data-line="99">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_InstanceDict</span>
</span><span data-line="100">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_InternalEntityType</span>
</span><span data-line="101">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_LoaderCallable</span>
</span><span data-line="102">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_O</span>
</span><span data-line="103">    <span class="kn">from</span><span class="w"> </span><span class="nn">.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">_AdaptedCollectionProtocol</span>
</span><span data-line="104">    <span class="kn">from</span><span class="w"> </span><span class="nn">.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">CollectionAdapter</span>
</span><span data-line="105">    <span class="kn">from</span><span class="w"> </span><span class="nn">.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">MapperProperty</span>
</span><span data-line="106">    <span class="kn">from</span><span class="w"> </span><span class="nn">.relationships</span><span class="w"> </span><span class="kn">import</span> <span class="n">RelationshipProperty</span>
</span><span data-line="107">    <span class="kn">from</span><span class="w"> </span><span class="nn">.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">InstanceState</span>
</span><span data-line="108">    <span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">AliasedInsp</span>
</span><span data-line="109">    <span class="kn">from</span><span class="w"> </span><span class="nn">.writeonly</span><span class="w"> </span><span class="kn">import</span> <span class="n">WriteOnlyAttributeImpl</span>
</span><span data-line="110">    <span class="kn">from</span><span class="w"> </span><span class="nn">..event.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">_Dispatch</span>
</span><span data-line="111">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_ColumnExpressionArgument</span>
</span><span data-line="112">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DMLColumnArgument</span>
</span><span data-line="113">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_InfoType</span>
</span><span data-line="114">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_PropagateAttrsType</span>
</span><span data-line="115">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.annotation</span><span class="w"> </span><span class="kn">import</span> <span class="n">_AnnotationDict</span>
</span><span data-line="116">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.elements</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnElement</span>
</span><span data-line="117">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.elements</span><span class="w"> </span><span class="kn">import</span> <span class="n">Label</span>
</span><span data-line="118">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.operators</span><span class="w"> </span><span class="kn">import</span> <span class="n">OperatorType</span>
</span><span data-line="119">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.selectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">FromClause</span>
</span><span data-line="120">
</span><span data-line="121">
</span><span data-line="122"><span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">)</span>
</span><span data-line="123"><span class="n">_T_co</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T_co&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">,</span> <span class="n">covariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="124">
</span><span data-line="125">
</span><span data-line="126"><span class="n">_AllPendingType</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">[</span>
</span><span data-line="127">    <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;InstanceState[Any]&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]]</span>
</span><span data-line="128"><span class="p">]</span>
</span><span data-line="129">
</span><span data-line="130">
</span><span data-line="131"><span class="n">_UNKNOWN_ATTR_KEY</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
</span><span data-line="132">
</span><span data-line="133">
</span><span data-line="134"><span class="nd">@inspection</span><span class="o">.</span><span class="n">_self_inspects</span>
</span><span data-line="135"><span class="k">class</span><span class="w"> </span><span class="nc">QueryableAttribute</span><span class="p">(</span>
</span><span data-line="136">    <span class="n">_DeclarativeMapped</span><span class="p">[</span><span class="n">_T_co</span><span class="p">],</span>
</span><span data-line="137">    <span class="n">SQLORMExpression</span><span class="p">[</span><span class="n">_T_co</span><span class="p">],</span>
</span><span data-line="138">    <span class="n">interfaces</span><span class="o">.</span><span class="n">InspectionAttr</span><span class="p">,</span>
</span><span data-line="139">    <span class="n">interfaces</span><span class="o">.</span><span class="n">PropComparator</span><span class="p">[</span><span class="n">_T_co</span><span class="p">],</span>
</span><span data-line="140">    <span class="n">roles</span><span class="o">.</span><span class="n">JoinTargetRole</span><span class="p">,</span>
</span><span data-line="141">    <span class="n">roles</span><span class="o">.</span><span class="n">OnClauseRole</span><span class="p">,</span>
</span><span data-line="142">    <span class="n">sql_base</span><span class="o">.</span><span class="n">Immutable</span><span class="p">,</span>
</span><span data-line="143">    <span class="n">cache_key</span><span class="o">.</span><span class="n">SlotsMemoizedHasCacheKey</span><span class="p">,</span>
</span><span data-line="144">    <span class="n">util</span><span class="o">.</span><span class="n">MemoizedSlots</span><span class="p">,</span>
</span><span data-line="145">    <span class="n">EventTarget</span><span class="p">,</span>
</span><span data-line="146"><span class="p">):</span>
</span><span data-line="147"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for :term:`descriptor` objects that intercept</span>
</span><span data-line="148"><span class="sd">    attribute events on behalf of a :class:`.MapperProperty`</span>
</span><span data-line="149"><span class="sd">    object.  The actual :class:`.MapperProperty` is accessible</span>
</span><span data-line="150"><span class="sd">    via the :attr:`.QueryableAttribute.property`</span>
</span><span data-line="151"><span class="sd">    attribute.</span>
</span><span data-line="152">
</span><span data-line="153">
</span><span data-line="154"><span class="sd">    .. seealso::</span>
</span><span data-line="155">
</span><span data-line="156"><span class="sd">        :class:`.InstrumentedAttribute`</span>
</span><span data-line="157">
</span><span data-line="158"><span class="sd">        :class:`.MapperProperty`</span>
</span><span data-line="159">
</span><span data-line="160"><span class="sd">        :attr:`_orm.Mapper.all_orm_descriptors`</span>
</span><span data-line="161">
</span><span data-line="162"><span class="sd">        :attr:`_orm.Mapper.attrs`</span>
</span><span data-line="163"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="164">
</span><span data-line="165">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="166">        <span class="s2">&quot;class_&quot;</span><span class="p">,</span>
</span><span data-line="167">        <span class="s2">&quot;key&quot;</span><span class="p">,</span>
</span><span data-line="168">        <span class="s2">&quot;impl&quot;</span><span class="p">,</span>
</span><span data-line="169">        <span class="s2">&quot;comparator&quot;</span><span class="p">,</span>
</span><span data-line="170">        <span class="s2">&quot;property&quot;</span><span class="p">,</span>
</span><span data-line="171">        <span class="s2">&quot;parent&quot;</span><span class="p">,</span>
</span><span data-line="172">        <span class="s2">&quot;expression&quot;</span><span class="p">,</span>
</span><span data-line="173">        <span class="s2">&quot;_of_type&quot;</span><span class="p">,</span>
</span><span data-line="174">        <span class="s2">&quot;_extra_criteria&quot;</span><span class="p">,</span>
</span><span data-line="175">        <span class="s2">&quot;_slots_dispatch&quot;</span><span class="p">,</span>
</span><span data-line="176">        <span class="s2">&quot;_propagate_attrs&quot;</span><span class="p">,</span>
</span><span data-line="177">        <span class="s2">&quot;_doc&quot;</span><span class="p">,</span>
</span><span data-line="178">    <span class="p">)</span>
</span><span data-line="179">
</span><span data-line="180">    <span class="n">is_attribute</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="181">
</span><span data-line="182">    <span class="n">dispatch</span><span class="p">:</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]]</span>
</span><span data-line="183">
</span><span data-line="184">    <span class="n">class_</span><span class="p">:</span> <span class="n">_ExternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="185">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="186">    <span class="n">parententity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="187">    <span class="n">impl</span><span class="p">:</span> <span class="n">AttributeImpl</span>
</span><span data-line="188">    <span class="n">comparator</span><span class="p">:</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">PropComparator</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]</span>
</span><span data-line="189">    <span class="n">_of_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="190">    <span class="n">_extra_criteria</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
</span><span data-line="191">    <span class="n">_doc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span data-line="192">
</span><span data-line="193">    <span class="c1"># PropComparator has a __visit_name__ to participate within</span>
</span><span data-line="194">    <span class="c1"># traversals.   Disambiguate the attribute vs. a comparator.</span>
</span><span data-line="195">    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">&quot;orm_instrumented_attribute&quot;</span>
</span><span data-line="196">
</span><span data-line="197">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="198">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="199">        <span class="n">class_</span><span class="p">:</span> <span class="n">_ExternalEntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="200">        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="201">        <span class="n">parententity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="202">        <span class="n">comparator</span><span class="p">:</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">PropComparator</span><span class="p">[</span><span class="n">_T_co</span><span class="p">],</span>
</span><span data-line="203">        <span class="n">impl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeImpl</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="204">        <span class="n">of_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="205">        <span class="n">extra_criteria</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
</span><span data-line="206">    <span class="p">):</span>
</span><span data-line="207">        <span class="bp">self</span><span class="o">.</span><span class="n">class_</span> <span class="o">=</span> <span class="n">class_</span>
</span><span data-line="208">        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
</span><span data-line="209">
</span><span data-line="210">        <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parententity</span>
</span><span data-line="211">
</span><span data-line="212">        <span class="c1"># this attribute is non-None after mappers are set up, however in the</span>
</span><span data-line="213">        <span class="c1"># interim class manager setup, there&#39;s a check for None to see if it</span>
</span><span data-line="214">        <span class="c1"># needs to be populated, so we assign None here leaving the attribute</span>
</span><span data-line="215">        <span class="c1"># in a temporarily not-type-correct state</span>
</span><span data-line="216">        <span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">=</span> <span class="n">impl</span>  <span class="c1"># type: ignore</span>
</span><span data-line="217">
</span><span data-line="218">        <span class="k">assert</span> <span class="n">comparator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="219">        <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span> <span class="o">=</span> <span class="n">comparator</span>
</span><span data-line="220">        <span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span> <span class="o">=</span> <span class="n">of_type</span>
</span><span data-line="221">        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span> <span class="o">=</span> <span class="n">extra_criteria</span>
</span><span data-line="222">        <span class="bp">self</span><span class="o">.</span><span class="n">_doc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="223">
</span><span data-line="224">        <span class="n">manager</span> <span class="o">=</span> <span class="n">opt_manager_of_class</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
</span><span data-line="225">        <span class="c1"># manager is None in the case of AliasedClass</span>
</span><span data-line="226">        <span class="k">if</span> <span class="n">manager</span><span class="p">:</span>
</span><span data-line="227">            <span class="c1"># propagate existing event listeners from</span>
</span><span data-line="228">            <span class="c1"># immediate superclass</span>
</span><span data-line="229">            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">manager</span><span class="o">.</span><span class="n">_bases</span><span class="p">:</span>
</span><span data-line="230">                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
</span><span data-line="231">                    <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
</span><span data-line="232">                    <span class="k">if</span> <span class="n">base</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span><span class="p">:</span>
</span><span data-line="233">                        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore</span>
</span><span data-line="234">
</span><span data-line="235">    <span class="n">_cache_key_traversal</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="236">        <span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">ExtendedInternalTraversal</span><span class="o">.</span><span class="n">dp_string</span><span class="p">),</span>
</span><span data-line="237">        <span class="p">(</span><span class="s2">&quot;_parententity&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">ExtendedInternalTraversal</span><span class="o">.</span><span class="n">dp_multi</span><span class="p">),</span>
</span><span data-line="238">        <span class="p">(</span><span class="s2">&quot;_of_type&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">ExtendedInternalTraversal</span><span class="o">.</span><span class="n">dp_multi</span><span class="p">),</span>
</span><span data-line="239">        <span class="p">(</span><span class="s2">&quot;_extra_criteria&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">InternalTraversal</span><span class="o">.</span><span class="n">dp_clauseelement_list</span><span class="p">),</span>
</span><span data-line="240">    <span class="p">]</span>
</span><span data-line="241">
</span><span data-line="242">    <span class="k">def</span><span class="w"> </span><span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="243">        <span class="c1"># this method is only used in terms of the</span>
</span><span data-line="244">        <span class="c1"># sqlalchemy.ext.serializer extension</span>
</span><span data-line="245">        <span class="k">return</span> <span class="p">(</span>
</span><span data-line="246">            <span class="n">_queryable_attribute_unreduce</span><span class="p">,</span>
</span><span data-line="247">            <span class="p">(</span>
</span><span data-line="248">                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="249">                <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span data-line="250">                <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span data-line="251">                <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span>
</span><span data-line="252">            <span class="p">),</span>
</span><span data-line="253">        <span class="p">)</span>
</span><span data-line="254">
</span><span data-line="255">    <span class="nd">@property</span>
</span><span data-line="256">    <span class="k">def</span><span class="w"> </span><span class="nf">_impl_uses_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="257">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">uses_objects</span>
</span><span data-line="258">
</span><span data-line="259">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span data-line="260">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span>
</span><span data-line="261">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="262">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get_history</span><span class="p">(</span>
</span><span data-line="263">            <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">passive</span>
</span><span data-line="264">        <span class="p">)</span>
</span><span data-line="265">
</span><span data-line="266">    <span class="nd">@property</span>
</span><span data-line="267">    <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_InfoType</span><span class="p">:</span>
</span><span data-line="268"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the &#39;info&#39; dictionary for the underlying SQL element.</span>
</span><span data-line="269">
</span><span data-line="270"><span class="sd">        The behavior here is as follows:</span>
</span><span data-line="271">
</span><span data-line="272"><span class="sd">        * If the attribute is a column-mapped property, i.e.</span>
</span><span data-line="273"><span class="sd">          :class:`.ColumnProperty`, which is mapped directly</span>
</span><span data-line="274"><span class="sd">          to a schema-level :class:`_schema.Column` object, this attribute</span>
</span><span data-line="275"><span class="sd">          will return the :attr:`.SchemaItem.info` dictionary associated</span>
</span><span data-line="276"><span class="sd">          with the core-level :class:`_schema.Column` object.</span>
</span><span data-line="277">
</span><span data-line="278"><span class="sd">        * If the attribute is a :class:`.ColumnProperty` but is mapped to</span>
</span><span data-line="279"><span class="sd">          any other kind of SQL expression other than a</span>
</span><span data-line="280"><span class="sd">          :class:`_schema.Column`,</span>
</span><span data-line="281"><span class="sd">          the attribute will refer to the :attr:`.MapperProperty.info`</span>
</span><span data-line="282"><span class="sd">          dictionary associated directly with the :class:`.ColumnProperty`,</span>
</span><span data-line="283"><span class="sd">          assuming the SQL expression itself does not have its own ``.info``</span>
</span><span data-line="284"><span class="sd">          attribute (which should be the case, unless a user-defined SQL</span>
</span><span data-line="285"><span class="sd">          construct has defined one).</span>
</span><span data-line="286">
</span><span data-line="287"><span class="sd">        * If the attribute refers to any other kind of</span>
</span><span data-line="288"><span class="sd">          :class:`.MapperProperty`, including :class:`.Relationship`,</span>
</span><span data-line="289"><span class="sd">          the attribute will refer to the :attr:`.MapperProperty.info`</span>
</span><span data-line="290"><span class="sd">          dictionary associated with that :class:`.MapperProperty`.</span>
</span><span data-line="291">
</span><span data-line="292"><span class="sd">        * To access the :attr:`.MapperProperty.info` dictionary of the</span>
</span><span data-line="293"><span class="sd">          :class:`.MapperProperty` unconditionally, including for a</span>
</span><span data-line="294"><span class="sd">          :class:`.ColumnProperty` that&#39;s associated directly with a</span>
</span><span data-line="295"><span class="sd">          :class:`_schema.Column`, the attribute can be referred to using</span>
</span><span data-line="296"><span class="sd">          :attr:`.QueryableAttribute.property` attribute, as</span>
</span><span data-line="297"><span class="sd">          ``MyClass.someattribute.property.info``.</span>
</span><span data-line="298">
</span><span data-line="299"><span class="sd">        .. seealso::</span>
</span><span data-line="300">
</span><span data-line="301"><span class="sd">            :attr:`.SchemaItem.info`</span>
</span><span data-line="302">
</span><span data-line="303"><span class="sd">            :attr:`.MapperProperty.info`</span>
</span><span data-line="304">
</span><span data-line="305"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="306">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">info</span>
</span><span data-line="307">
</span><span data-line="308">    <span class="n">parent</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="309"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return an inspection instance representing the parent.</span>
</span><span data-line="310">
</span><span data-line="311"><span class="sd">    This will be either an instance of :class:`_orm.Mapper`</span>
</span><span data-line="312"><span class="sd">    or :class:`.AliasedInsp`, depending upon the nature</span>
</span><span data-line="313"><span class="sd">    of the parent entity which this attribute is associated</span>
</span><span data-line="314"><span class="sd">    with.</span>
</span><span data-line="315">
</span><span data-line="316"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="317">
</span><span data-line="318">    <span class="n">expression</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]</span>
</span><span data-line="319"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The SQL expression object represented by this</span>
</span><span data-line="320"><span class="sd">    :class:`.QueryableAttribute`.</span>
</span><span data-line="321">
</span><span data-line="322"><span class="sd">    This will typically be an instance of a :class:`_sql.ColumnElement`</span>
</span><span data-line="323"><span class="sd">    subclass representing a column expression.</span>
</span><span data-line="324">
</span><span data-line="325"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="326">
</span><span data-line="327">    <span class="k">def</span><span class="w"> </span><span class="nf">_memoized_attr_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="328">        <span class="n">annotations</span><span class="p">:</span> <span class="n">_AnnotationDict</span>
</span><span data-line="329">
</span><span data-line="330">        <span class="c1"># applies only to Proxy() as used by hybrid.</span>
</span><span data-line="331">        <span class="c1"># currently is an exception to typing rather than feeding through</span>
</span><span data-line="332">        <span class="c1"># non-string keys.</span>
</span><span data-line="333">        <span class="c1"># ideally Proxy() would have a separate set of methods to deal</span>
</span><span data-line="334">        <span class="c1"># with this case.</span>
</span><span data-line="335">        <span class="n">entity_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity_namespace</span>
</span><span data-line="336">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_namespace</span><span class="p">,</span> <span class="n">HasCacheKey</span><span class="p">)</span>
</span><span data-line="337">
</span><span data-line="338">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="n">_UNKNOWN_ATTR_KEY</span><span class="p">:</span>
</span><span data-line="339">            <span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;entity_namespace&quot;</span><span class="p">:</span> <span class="n">entity_namespace</span><span class="p">}</span>
</span><span data-line="340">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="341">            <span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="342">                <span class="s2">&quot;proxy_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="343">                <span class="s2">&quot;proxy_owner&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span data-line="344">                <span class="s2">&quot;entity_namespace&quot;</span><span class="p">:</span> <span class="n">entity_namespace</span><span class="p">,</span>
</span><span data-line="345">            <span class="p">}</span>
</span><span data-line="346">
</span><span data-line="347">        <span class="n">ce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
</span><span data-line="348">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="349">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="350">                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ce</span><span class="p">,</span> <span class="n">ColumnElement</span><span class="p">)</span>
</span><span data-line="351">            <span class="n">anno</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">_annotate</span>
</span><span data-line="352">        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">ae</span><span class="p">:</span>
</span><span data-line="353">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="354">                <span class="s1">&#39;When interpreting attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; as a SQL expression, &#39;</span>
</span><span data-line="355">                <span class="s2">&quot;expected __clause_element__() to return &quot;</span>
</span><span data-line="356">                <span class="s2">&quot;a ClauseElement object, got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ce</span><span class="p">)</span>
</span><span data-line="357">            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ae</span>
</span><span data-line="358">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="359">            <span class="k">return</span> <span class="n">anno</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
</span><span data-line="360">
</span><span data-line="361">    <span class="k">def</span><span class="w"> </span><span class="nf">_memoized_attr__propagate_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_PropagateAttrsType</span><span class="p">:</span>
</span><span data-line="362">        <span class="c1"># this suits the case in coercions where we don&#39;t actually</span>
</span><span data-line="363">        <span class="c1"># call ``__clause_element__()`` but still need to get</span>
</span><span data-line="364">        <span class="c1"># resolved._propagate_attrs.  See #6558.</span>
</span><span data-line="365">        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">(</span>
</span><span data-line="366">            <span class="p">{</span>
</span><span data-line="367">                <span class="s2">&quot;compile_state_plugin&quot;</span><span class="p">:</span> <span class="s2">&quot;orm&quot;</span><span class="p">,</span>
</span><span data-line="368">                <span class="s2">&quot;plugin_subject&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parentmapper</span><span class="p">,</span>
</span><span data-line="369">            <span class="p">}</span>
</span><span data-line="370">        <span class="p">)</span>
</span><span data-line="371">
</span><span data-line="372">    <span class="nd">@property</span>
</span><span data-line="373">    <span class="k">def</span><span class="w"> </span><span class="nf">_entity_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="374">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span>
</span><span data-line="375">
</span><span data-line="376">    <span class="nd">@property</span>
</span><span data-line="377">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AnnotationDict</span><span class="p">:</span>
</span><span data-line="378">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span><span class="o">.</span><span class="n">_annotations</span>
</span><span data-line="379">
</span><span data-line="380">    <span class="k">def</span><span class="w"> </span><span class="nf">__clause_element__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]:</span>
</span><span data-line="381">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span>
</span><span data-line="382">
</span><span data-line="383">    <span class="nd">@property</span>
</span><span data-line="384">    <span class="k">def</span><span class="w"> </span><span class="nf">_from_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]:</span>
</span><span data-line="385">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">_from_objects</span>
</span><span data-line="386">
</span><span data-line="387">    <span class="k">def</span><span class="w"> </span><span class="nf">_bulk_update_tuples</span><span class="p">(</span>
</span><span data-line="388">        <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="389">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_DMLColumnArgument</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="390"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return setter tuples for a bulk UPDATE.&quot;&quot;&quot;</span>
</span><span data-line="391">
</span><span data-line="392">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">_bulk_update_tuples</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="393">
</span><span data-line="394">    <span class="k">def</span><span class="w"> </span><span class="nf">adapt_to_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adapt_to_entity</span><span class="p">:</span> <span class="n">AliasedInsp</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span data-line="395">        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span>
</span><span data-line="396">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
</span><span data-line="397">            <span class="n">adapt_to_entity</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span>
</span><span data-line="398">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="399">            <span class="n">impl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span>
</span><span data-line="400">            <span class="n">comparator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">adapt_to_entity</span><span class="p">(</span><span class="n">adapt_to_entity</span><span class="p">),</span>
</span><span data-line="401">            <span class="n">parententity</span><span class="o">=</span><span class="n">adapt_to_entity</span><span class="p">,</span>
</span><span data-line="402">        <span class="p">)</span>
</span><span data-line="403">
</span><span data-line="404">    <span class="k">def</span><span class="w"> </span><span class="nf">of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">_EntityType</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="405">        <span class="k">return</span> <span class="n">QueryableAttribute</span><span class="p">(</span>
</span><span data-line="406">            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span data-line="407">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="408">            <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span data-line="409">            <span class="n">impl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span>
</span><span data-line="410">            <span class="n">comparator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">entity</span><span class="p">),</span>
</span><span data-line="411">            <span class="n">of_type</span><span class="o">=</span><span class="n">inspection</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">entity</span><span class="p">),</span>
</span><span data-line="412">            <span class="n">extra_criteria</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span><span class="p">,</span>
</span><span data-line="413">        <span class="p">)</span>
</span><span data-line="414">
</span><span data-line="415">    <span class="k">def</span><span class="w"> </span><span class="nf">and_</span><span class="p">(</span>
</span><span data-line="416">        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">clauses</span><span class="p">:</span> <span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
</span><span data-line="417">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="418">        <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="419">            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="o">.</span><span class="n">Comparator</span><span class="p">)</span>
</span><span data-line="420">
</span><span data-line="421">        <span class="n">exprs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span data-line="422">            <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">roles</span><span class="o">.</span><span class="n">WhereHavingRole</span><span class="p">,</span> <span class="n">clause</span><span class="p">)</span>
</span><span data-line="423">            <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">coerce_generator_arg</span><span class="p">(</span><span class="n">clauses</span><span class="p">)</span>
</span><span data-line="424">        <span class="p">)</span>
</span><span data-line="425">
</span><span data-line="426">        <span class="k">return</span> <span class="n">QueryableAttribute</span><span class="p">(</span>
</span><span data-line="427">            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span data-line="428">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="429">            <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span data-line="430">            <span class="n">impl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span>
</span><span data-line="431">            <span class="n">comparator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">exprs</span><span class="p">),</span>
</span><span data-line="432">            <span class="n">of_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span><span class="p">,</span>
</span><span data-line="433">            <span class="n">extra_criteria</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span> <span class="o">+</span> <span class="n">exprs</span><span class="p">,</span>
</span><span data-line="434">        <span class="p">)</span>
</span><span data-line="435">
</span><span data-line="436">    <span class="k">def</span><span class="w"> </span><span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="437">        <span class="k">return</span> <span class="n">QueryableAttribute</span><span class="p">(</span>
</span><span data-line="438">            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span data-line="439">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="440">            <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span data-line="441">            <span class="n">impl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span>
</span><span data-line="442">            <span class="n">comparator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">,</span>
</span><span data-line="443">            <span class="n">of_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span><span class="p">,</span>
</span><span data-line="444">            <span class="n">extra_criteria</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span><span class="p">,</span>
</span><span data-line="445">        <span class="p">)</span>
</span><span data-line="446">
</span><span data-line="447">    <span class="k">def</span><span class="w"> </span><span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Label</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]:</span>
</span><span data-line="448">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="449">
</span><span data-line="450">    <span class="k">def</span><span class="w"> </span><span class="nf">operate</span><span class="p">(</span>
</span><span data-line="451">        <span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">OperatorType</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="452">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="453">        <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[no-any-return]  # noqa: E501</span>
</span><span data-line="454">
</span><span data-line="455">    <span class="k">def</span><span class="w"> </span><span class="nf">reverse_operate</span><span class="p">(</span>
</span><span data-line="456">        <span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">OperatorType</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="457">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="458">        <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[no-any-return]  # noqa: E501</span>
</span><span data-line="459">
</span><span data-line="460">    <span class="k">def</span><span class="w"> </span><span class="nf">hasparent</span><span class="p">(</span>
</span><span data-line="461">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">optimistic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="462">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="463">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">hasparent</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">optimistic</span><span class="o">=</span><span class="n">optimistic</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
</span><span data-line="464">
</span><span data-line="465">    <span class="k">def</span><span class="w"> </span><span class="nf">_column_strategy_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="466">        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">,)</span>
</span><span data-line="467">
</span><span data-line="468">    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="469">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="470">            <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">MemoizedSlots</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="471">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span data-line="472">            <span class="k">pass</span>
</span><span data-line="473">
</span><span data-line="474">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="475">            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="476">        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="477">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
</span><span data-line="478">                <span class="s2">&quot;Neither </span><span class="si">%r</span><span class="s2"> object nor </span><span class="si">%r</span><span class="s2"> object associated with </span><span class="si">%s</span><span class="s2"> &quot;</span>
</span><span data-line="479">                <span class="s2">&quot;has an attribute </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span data-line="480">                <span class="o">%</span> <span class="p">(</span>
</span><span data-line="481">                    <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="482">                    <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="483">                    <span class="bp">self</span><span class="p">,</span>
</span><span data-line="484">                    <span class="n">key</span><span class="p">,</span>
</span><span data-line="485">                <span class="p">)</span>
</span><span data-line="486">            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
</span><span data-line="487">
</span><span data-line="488">    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="489">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="490">
</span><span data-line="491">    <span class="k">def</span><span class="w"> </span><span class="nf">_memoized_attr_property</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MapperProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="492">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">property</span>
</span><span data-line="493">
</span><span data-line="494">
</span><span data-line="495"><span class="k">def</span><span class="w"> </span><span class="nf">_queryable_attribute_unreduce</span><span class="p">(</span>
</span><span data-line="496">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="497">    <span class="n">mapped_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="498">    <span class="n">parententity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="499">    <span class="n">entity</span><span class="p">:</span> <span class="n">_ExternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="500"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="501">    <span class="c1"># this method is only used in terms of the</span>
</span><span data-line="502">    <span class="c1"># sqlalchemy.ext.serializer extension</span>
</span><span data-line="503">    <span class="k">if</span> <span class="n">insp_is_aliased_class</span><span class="p">(</span><span class="n">parententity</span><span class="p">):</span>
</span><span data-line="504">        <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_get_from_serialized</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mapped_class</span><span class="p">,</span> <span class="n">parententity</span><span class="p">)</span>
</span><span data-line="505">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="506">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="507">
</span><span data-line="508">
</span><span data-line="509"><span class="k">class</span><span class="w"> </span><span class="nc">InstrumentedAttribute</span><span class="p">(</span><span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]):</span>
</span><span data-line="510"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class bound instrumented attribute which adds basic</span>
</span><span data-line="511"><span class="sd">    :term:`descriptor` methods.</span>
</span><span data-line="512">
</span><span data-line="513"><span class="sd">    See :class:`.QueryableAttribute` for a description of most features.</span>
</span><span data-line="514">
</span><span data-line="515">
</span><span data-line="516"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="517">
</span><span data-line="518">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
</span><span data-line="519">
</span><span data-line="520">    <span class="n">inherit_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="521"><span class="w">    </span><span class="sd">&quot;&quot;&quot;:meta private:&quot;&quot;&quot;</span>
</span><span data-line="522">
</span><span data-line="523">    <span class="c1"># hack to make __doc__ writeable on instances of</span>
</span><span data-line="524">    <span class="c1"># InstrumentedAttribute, while still keeping classlevel</span>
</span><span data-line="525">    <span class="c1"># __doc__ correct</span>
</span><span data-line="526">
</span><span data-line="527">    <span class="nd">@util</span><span class="o">.</span><span class="n">rw_hybridproperty</span>
</span><span data-line="528">    <span class="k">def</span><span class="w"> </span><span class="nf">__doc__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="529">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_doc</span>
</span><span data-line="530">
</span><span data-line="531">    <span class="nd">@__doc__</span><span class="o">.</span><span class="n">setter</span>  <span class="c1"># type: ignore</span>
</span><span data-line="532">    <span class="k">def</span><span class="w"> </span><span class="nf">__doc__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="533">        <span class="bp">self</span><span class="o">.</span><span class="n">_doc</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="534">
</span><span data-line="535">    <span class="nd">@__doc__</span><span class="o">.</span><span class="n">classlevel</span>  <span class="c1"># type: ignore</span>
</span><span data-line="536">    <span class="k">def</span><span class="w"> </span><span class="nf">__doc__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="537">        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span data-line="538">
</span><span data-line="539">    <span class="k">def</span><span class="w"> </span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="540">        <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span data-line="541">            <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="kc">None</span>
</span><span data-line="542">        <span class="p">)</span>
</span><span data-line="543">
</span><span data-line="544">    <span class="k">def</span><span class="w"> </span><span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="545">        <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
</span><span data-line="546">
</span><span data-line="547">    <span class="nd">@overload</span>
</span><span data-line="548">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span>
</span><span data-line="549">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="550">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="551">
</span><span data-line="552">    <span class="nd">@overload</span>
</span><span data-line="553">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T_co</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="554">
</span><span data-line="555">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span>
</span><span data-line="556">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="557">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T_co</span><span class="p">],</span> <span class="n">_T_co</span><span class="p">]:</span>
</span><span data-line="558">        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="559">            <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="560">
</span><span data-line="561">        <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="562">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">supports_population</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span data-line="563">            <span class="k">return</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># type: ignore[no-any-return]</span>
</span><span data-line="564">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="565">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="566">                <span class="n">state</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="567">            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="568">                <span class="k">raise</span> <span class="n">orm_exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
</span><span data-line="569">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>  <span class="c1"># type: ignore[no-any-return]</span>
</span><span data-line="570">
</span><span data-line="571">
</span><span data-line="572"><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="573"><span class="k">class</span><span class="w"> </span><span class="nc">AdHocHasEntityNamespace</span><span class="p">(</span><span class="n">HasCacheKey</span><span class="p">):</span>
</span><span data-line="574">    <span class="n">_traverse_internals</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">_TraverseInternalsType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="575">        <span class="p">(</span><span class="s2">&quot;_entity_namespace&quot;</span><span class="p">,</span> <span class="n">InternalTraversal</span><span class="o">.</span><span class="n">dp_has_cache_key</span><span class="p">),</span>
</span><span data-line="576">    <span class="p">]</span>
</span><span data-line="577">
</span><span data-line="578">    <span class="c1"># py37 compat, no slots=True on dataclass</span>
</span><span data-line="579">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_entity_namespace&quot;</span><span class="p">,)</span>
</span><span data-line="580">    <span class="n">_entity_namespace</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="581">    <span class="n">is_mapper</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="582">    <span class="n">is_aliased_class</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="583">
</span><span data-line="584">    <span class="nd">@property</span>
</span><span data-line="585">    <span class="k">def</span><span class="w"> </span><span class="nf">entity_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="586">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity_namespace</span><span class="o">.</span><span class="n">entity_namespace</span>
</span><span data-line="587">
</span><span data-line="588">
</span><span data-line="589"><span class="k">def</span><span class="w"> </span><span class="nf">create_proxied_attribute</span><span class="p">(</span>
</span><span data-line="590">    <span class="n">descriptor</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="591"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="592"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an QueryableAttribute / user descriptor hybrid.</span>
</span><span data-line="593">
</span><span data-line="594"><span class="sd">    Returns a new QueryableAttribute type that delegates descriptor</span>
</span><span data-line="595"><span class="sd">    behavior and getattr() to the given descriptor.</span>
</span><span data-line="596"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="597">
</span><span data-line="598">    <span class="c1"># TODO: can move this to descriptor_props if the need for this</span>
</span><span data-line="599">    <span class="c1"># function is removed from ext/hybrid.py</span>
</span><span data-line="600">
</span><span data-line="601">    <span class="k">class</span><span class="w"> </span><span class="nc">Proxy</span><span class="p">(</span><span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]):</span>
</span><span data-line="602"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Presents the :class:`.QueryableAttribute` interface as a</span>
</span><span data-line="603"><span class="sd">        proxy on top of a Python descriptor / :class:`.PropComparator`</span>
</span><span data-line="604"><span class="sd">        combination.</span>
</span><span data-line="605">
</span><span data-line="606"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="607">
</span><span data-line="608">        <span class="n">_extra_criteria</span> <span class="o">=</span> <span class="p">()</span>
</span><span data-line="609">
</span><span data-line="610">        <span class="c1"># the attribute error catches inside of __getattr__ basically create a</span>
</span><span data-line="611">        <span class="c1"># singularity if you try putting slots on this too</span>
</span><span data-line="612">        <span class="c1"># __slots__ = (&quot;descriptor&quot;, &quot;original_property&quot;, &quot;_comparator&quot;)</span>
</span><span data-line="613">
</span><span data-line="614">        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="615">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="616">            <span class="n">class_</span><span class="p">:</span> <span class="n">_ExternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="617">            <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="618">            <span class="n">descriptor</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="619">            <span class="n">comparator</span><span class="p">:</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">PropComparator</span><span class="p">[</span><span class="n">_T_co</span><span class="p">],</span>
</span><span data-line="620">            <span class="n">adapt_to_entity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AliasedInsp</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="621">            <span class="n">doc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="622">            <span class="n">original_property</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="623">        <span class="p">):</span>
</span><span data-line="624">            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span> <span class="o">=</span> <span class="n">class_</span>
</span><span data-line="625">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
</span><span data-line="626">            <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span> <span class="o">=</span> <span class="n">descriptor</span>
</span><span data-line="627">            <span class="bp">self</span><span class="o">.</span><span class="n">original_property</span> <span class="o">=</span> <span class="n">original_property</span>
</span><span data-line="628">            <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span> <span class="o">=</span> <span class="n">comparator</span>
</span><span data-line="629">            <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span> <span class="o">=</span> <span class="n">adapt_to_entity</span>
</span><span data-line="630">            <span class="bp">self</span><span class="o">.</span><span class="n">_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>
</span><span data-line="631">
</span><span data-line="632">        <span class="nd">@property</span>
</span><span data-line="633">        <span class="k">def</span><span class="w"> </span><span class="nf">_parententity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># type: ignore[override]</span>
</span><span data-line="634">            <span class="k">return</span> <span class="n">inspection</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="n">raiseerr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="635">
</span><span data-line="636">        <span class="nd">@property</span>
</span><span data-line="637">        <span class="k">def</span><span class="w"> </span><span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># type: ignore[override]</span>
</span><span data-line="638">            <span class="k">return</span> <span class="n">inspection</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="n">raiseerr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="639">
</span><span data-line="640">        <span class="n">_is_internal_proxy</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="641">
</span><span data-line="642">        <span class="n">_cache_key_traversal</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="643">            <span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">ExtendedInternalTraversal</span><span class="o">.</span><span class="n">dp_string</span><span class="p">),</span>
</span><span data-line="644">            <span class="p">(</span><span class="s2">&quot;_parententity&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">ExtendedInternalTraversal</span><span class="o">.</span><span class="n">dp_multi</span><span class="p">),</span>
</span><span data-line="645">        <span class="p">]</span>
</span><span data-line="646">
</span><span data-line="647">        <span class="k">def</span><span class="w"> </span><span class="nf">_column_strategy_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="648">            <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_property</span>
</span><span data-line="649">            <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="650">                <span class="k">return</span> <span class="p">()</span>
</span><span data-line="651">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="652">                <span class="k">return</span> <span class="n">prop</span><span class="o">.</span><span class="n">_column_strategy_attrs</span><span class="p">()</span>
</span><span data-line="653">
</span><span data-line="654">        <span class="nd">@property</span>
</span><span data-line="655">        <span class="k">def</span><span class="w"> </span><span class="nf">_impl_uses_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="656">            <span class="k">return</span> <span class="p">(</span>
</span><span data-line="657">                <span class="bp">self</span><span class="o">.</span><span class="n">original_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="658">                <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">uses_objects</span>
</span><span data-line="659">            <span class="p">)</span>
</span><span data-line="660">
</span><span data-line="661">        <span class="nd">@property</span>
</span><span data-line="662">        <span class="k">def</span><span class="w"> </span><span class="nf">_entity_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="663">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="p">,</span> <span class="s2">&quot;_parententity&quot;</span><span class="p">):</span>
</span><span data-line="664">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">_parententity</span>
</span><span data-line="665">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="666">                <span class="c1"># used by hybrid attributes which try to remain</span>
</span><span data-line="667">                <span class="c1"># agnostic of any ORM concepts like mappers</span>
</span><span data-line="668">                <span class="k">return</span> <span class="n">AdHocHasEntityNamespace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">)</span>
</span><span data-line="669">
</span><span data-line="670">        <span class="nd">@property</span>
</span><span data-line="671">        <span class="k">def</span><span class="w"> </span><span class="nf">property</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="672">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">property</span>
</span><span data-line="673">
</span><span data-line="674">        <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="675">        <span class="k">def</span><span class="w"> </span><span class="nf">comparator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="676">            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="p">):</span>
</span><span data-line="677">                <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="p">()</span>
</span><span data-line="678">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span><span class="p">:</span>
</span><span data-line="679">                <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">adapt_to_entity</span><span class="p">(</span>
</span><span data-line="680">                    <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span>
</span><span data-line="681">                <span class="p">)</span>
</span><span data-line="682">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span>
</span><span data-line="683">
</span><span data-line="684">        <span class="k">def</span><span class="w"> </span><span class="nf">adapt_to_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adapt_to_entity</span><span class="p">):</span>
</span><span data-line="685">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
</span><span data-line="686">                <span class="n">adapt_to_entity</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span>
</span><span data-line="687">                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="688">                <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="p">,</span>
</span><span data-line="689">                <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="p">,</span>
</span><span data-line="690">                <span class="n">adapt_to_entity</span><span class="p">,</span>
</span><span data-line="691">            <span class="p">)</span>
</span><span data-line="692">
</span><span data-line="693">        <span class="k">def</span><span class="w"> </span><span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span><span data-line="694">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
</span><span data-line="695">                <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span data-line="696">                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="697">                <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="p">,</span>
</span><span data-line="698">                <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="p">,</span>
</span><span data-line="699">                <span class="n">adapt_to_entity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span><span class="p">,</span>
</span><span data-line="700">                <span class="n">original_property</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">original_property</span><span class="p">,</span>
</span><span data-line="701">            <span class="p">)</span>
</span><span data-line="702">
</span><span data-line="703">        <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
</span><span data-line="704">            <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">)</span>
</span><span data-line="705">            <span class="c1"># detect if this is a plain Python @property, which just returns</span>
</span><span data-line="706">            <span class="c1"># itself for class level access.  If so, then return us.</span>
</span><span data-line="707">            <span class="c1"># Otherwise, return the object returned by the descriptor.</span>
</span><span data-line="708">            <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span> <span class="ow">and</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="709">                <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="710">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="711">                <span class="k">return</span> <span class="n">retval</span>
</span><span data-line="712">
</span><span data-line="713">        <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="714">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="715">
</span><span data-line="716">        <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
</span><span data-line="717"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Delegate __getattr__ to the original descriptor and/or</span>
</span><span data-line="718"><span class="sd">            comparator.&quot;&quot;&quot;</span>
</span><span data-line="719">
</span><span data-line="720">            <span class="c1"># this is unfortunately very complicated, and is easily prone</span>
</span><span data-line="721">            <span class="c1"># to recursion overflows when implementations of related</span>
</span><span data-line="722">            <span class="c1"># __getattr__ schemes are changed</span>
</span><span data-line="723">
</span><span data-line="724">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="725">                <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">MemoizedSlots</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
</span><span data-line="726">            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span data-line="727">                <span class="k">pass</span>
</span><span data-line="728">
</span><span data-line="729">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="730">                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
</span><span data-line="731">            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="732">                <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="s2">&quot;comparator&quot;</span><span class="p">:</span>
</span><span data-line="733">                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;comparator&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
</span><span data-line="734">                <span class="k">try</span><span class="p">:</span>
</span><span data-line="735">                    <span class="c1"># comparator itself might be unreachable</span>
</span><span data-line="736">                    <span class="n">comparator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span>
</span><span data-line="737">                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err2</span><span class="p">:</span>
</span><span data-line="738">                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
</span><span data-line="739">                        <span class="s2">&quot;Neither </span><span class="si">%r</span><span class="s2"> object nor unconfigured comparator &quot;</span>
</span><span data-line="740">                        <span class="s2">&quot;object associated with </span><span class="si">%s</span><span class="s2"> has an attribute </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span data-line="741">                        <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
</span><span data-line="742">                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err2</span>
</span><span data-line="743">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="744">                    <span class="k">try</span><span class="p">:</span>
</span><span data-line="745">                        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">comparator</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
</span><span data-line="746">                    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err3</span><span class="p">:</span>
</span><span data-line="747">                        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
</span><span data-line="748">                            <span class="s2">&quot;Neither </span><span class="si">%r</span><span class="s2"> object nor </span><span class="si">%r</span><span class="s2"> object &quot;</span>
</span><span data-line="749">                            <span class="s2">&quot;associated with </span><span class="si">%s</span><span class="s2"> has an attribute </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span data-line="750">                            <span class="o">%</span> <span class="p">(</span>
</span><span data-line="751">                                <span class="nb">type</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="752">                                <span class="nb">type</span><span class="p">(</span><span class="n">comparator</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="753">                                <span class="bp">self</span><span class="p">,</span>
</span><span data-line="754">                                <span class="n">attribute</span><span class="p">,</span>
</span><span data-line="755">                            <span class="p">)</span>
</span><span data-line="756">                        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err3</span>
</span><span data-line="757">
</span><span data-line="758">    <span class="n">Proxy</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;Proxy&quot;</span>
</span><span data-line="759">
</span><span data-line="760">    <span class="n">util</span><span class="o">.</span><span class="n">monkeypatch_proxied_specials</span><span class="p">(</span>
</span><span data-line="761">        <span class="n">Proxy</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">descriptor</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;descriptor&quot;</span><span class="p">,</span> <span class="n">from_instance</span><span class="o">=</span><span class="n">descriptor</span>
</span><span data-line="762">    <span class="p">)</span>
</span><span data-line="763">    <span class="k">return</span> <span class="n">Proxy</span>
</span><span data-line="764">
</span><span data-line="765">
</span><span data-line="766"><span class="n">OP_REMOVE</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;REMOVE&quot;</span><span class="p">)</span>
</span><span data-line="767"><span class="n">OP_APPEND</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;APPEND&quot;</span><span class="p">)</span>
</span><span data-line="768"><span class="n">OP_REPLACE</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;REPLACE&quot;</span><span class="p">)</span>
</span><span data-line="769"><span class="n">OP_BULK_REPLACE</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;BULK_REPLACE&quot;</span><span class="p">)</span>
</span><span data-line="770"><span class="n">OP_MODIFIED</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;MODIFIED&quot;</span><span class="p">)</span>
</span><span data-line="771">
</span><span data-line="772">
</span><span data-line="773"><span class="k">class</span><span class="w"> </span><span class="nc">AttributeEventToken</span><span class="p">:</span>
</span><span data-line="774"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A token propagated throughout the course of a chain of attribute</span>
</span><span data-line="775"><span class="sd">    events.</span>
</span><span data-line="776">
</span><span data-line="777"><span class="sd">    Serves as an indicator of the source of the event and also provides</span>
</span><span data-line="778"><span class="sd">    a means of controlling propagation across a chain of attribute</span>
</span><span data-line="779"><span class="sd">    operations.</span>
</span><span data-line="780">
</span><span data-line="781"><span class="sd">    The :class:`.Event` object is sent as the ``initiator`` argument</span>
</span><span data-line="782"><span class="sd">    when dealing with events such as :meth:`.AttributeEvents.append`,</span>
</span><span data-line="783"><span class="sd">    :meth:`.AttributeEvents.set`,</span>
</span><span data-line="784"><span class="sd">    and :meth:`.AttributeEvents.remove`.</span>
</span><span data-line="785">
</span><span data-line="786"><span class="sd">    The :class:`.Event` object is currently interpreted by the backref</span>
</span><span data-line="787"><span class="sd">    event handlers, and is used to control the propagation of operations</span>
</span><span data-line="788"><span class="sd">    across two mutually-dependent attributes.</span>
</span><span data-line="789">
</span><span data-line="790"><span class="sd">    .. versionchanged:: 2.0  Changed the name from ``AttributeEvent``</span>
</span><span data-line="791"><span class="sd">       to ``AttributeEventToken``.</span>
</span><span data-line="792">
</span><span data-line="793"><span class="sd">    :attribute impl: The :class:`.AttributeImpl` which is the current event</span>
</span><span data-line="794"><span class="sd">     initiator.</span>
</span><span data-line="795">
</span><span data-line="796"><span class="sd">    :attribute op: The symbol :attr:`.OP_APPEND`, :attr:`.OP_REMOVE`,</span>
</span><span data-line="797"><span class="sd">     :attr:`.OP_REPLACE`, or :attr:`.OP_BULK_REPLACE`, indicating the</span>
</span><span data-line="798"><span class="sd">     source operation.</span>
</span><span data-line="799">
</span><span data-line="800"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="801">
</span><span data-line="802">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s2">&quot;impl&quot;</span><span class="p">,</span> <span class="s2">&quot;op&quot;</span><span class="p">,</span> <span class="s2">&quot;parent_token&quot;</span>
</span><span data-line="803">
</span><span data-line="804">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute_impl</span><span class="p">:</span> <span class="n">AttributeImpl</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">):</span>
</span><span data-line="805">        <span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">=</span> <span class="n">attribute_impl</span>
</span><span data-line="806">        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>
</span><span data-line="807">        <span class="bp">self</span><span class="o">.</span><span class="n">parent_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">parent_token</span>
</span><span data-line="808">
</span><span data-line="809">    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span data-line="810">        <span class="k">return</span> <span class="p">(</span>
</span><span data-line="811">            <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">AttributeEventToken</span><span class="p">)</span>
</span><span data-line="812">            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">impl</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span>
</span><span data-line="813">            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span>
</span><span data-line="814">        <span class="p">)</span>
</span><span data-line="815">
</span><span data-line="816">    <span class="nd">@property</span>
</span><span data-line="817">    <span class="k">def</span><span class="w"> </span><span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="818">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="819">
</span><span data-line="820">    <span class="k">def</span><span class="w"> </span><span class="nf">hasparent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span data-line="821">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">hasparent</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="822">
</span><span data-line="823">
</span><span data-line="824"><span class="n">AttributeEvent</span> <span class="o">=</span> <span class="n">AttributeEventToken</span>  <span class="c1"># legacy</span>
</span><span data-line="825"><span class="n">Event</span> <span class="o">=</span> <span class="n">AttributeEventToken</span>  <span class="c1"># legacy</span>
</span><span data-line="826">
</span><span data-line="827">
</span><span data-line="828"><span class="k">class</span><span class="w"> </span><span class="nc">AttributeImpl</span><span class="p">:</span>
</span><span data-line="829"><span class="w">    </span><span class="sd">&quot;&quot;&quot;internal implementation for instrumented attributes.&quot;&quot;&quot;</span>
</span><span data-line="830">
</span><span data-line="831">    <span class="n">collection</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="832">    <span class="n">default_accepts_scalar_loader</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="833">    <span class="n">uses_objects</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="834">    <span class="n">supports_population</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="835">    <span class="n">dynamic</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="836">
</span><span data-line="837">    <span class="n">_is_has_collection_adapter</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="838">
</span><span data-line="839">    <span class="n">_replace_token</span><span class="p">:</span> <span class="n">AttributeEventToken</span>
</span><span data-line="840">    <span class="n">_remove_token</span><span class="p">:</span> <span class="n">AttributeEventToken</span>
</span><span data-line="841">    <span class="n">_append_token</span><span class="p">:</span> <span class="n">AttributeEventToken</span>
</span><span data-line="842">
</span><span data-line="843">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="844">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="845">        <span class="n">class_</span><span class="p">:</span> <span class="n">_ExternalEntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="846">        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="847">        <span class="n">callable_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_LoaderCallable</span><span class="p">],</span>
</span><span data-line="848">        <span class="n">dispatch</span><span class="p">:</span> <span class="n">_Dispatch</span><span class="p">[</span><span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="849">        <span class="n">trackparent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="850">        <span class="n">compare_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="851">        <span class="n">active_history</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="852">        <span class="n">parent_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="853">        <span class="n">load_on_unexpire</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="854">        <span class="n">send_modified_events</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="855">        <span class="n">accepts_scalar_loader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="856">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="857">    <span class="p">):</span>
</span><span data-line="858"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct an AttributeImpl.</span>
</span><span data-line="859">
</span><span data-line="860"><span class="sd">        :param \class_: associated class</span>
</span><span data-line="861">
</span><span data-line="862"><span class="sd">        :param key: string name of the attribute</span>
</span><span data-line="863">
</span><span data-line="864"><span class="sd">        :param \callable_:</span>
</span><span data-line="865"><span class="sd">          optional function which generates a callable based on a parent</span>
</span><span data-line="866"><span class="sd">          instance, which produces the &quot;default&quot; values for a scalar or</span>
</span><span data-line="867"><span class="sd">          collection attribute when it&#39;s first accessed, if not present</span>
</span><span data-line="868"><span class="sd">          already.</span>
</span><span data-line="869">
</span><span data-line="870"><span class="sd">        :param trackparent:</span>
</span><span data-line="871"><span class="sd">          if True, attempt to track if an instance has a parent attached</span>
</span><span data-line="872"><span class="sd">          to it via this attribute.</span>
</span><span data-line="873">
</span><span data-line="874"><span class="sd">        :param compare_function:</span>
</span><span data-line="875"><span class="sd">          a function that compares two values which are normally</span>
</span><span data-line="876"><span class="sd">          assignable to this attribute.</span>
</span><span data-line="877">
</span><span data-line="878"><span class="sd">        :param active_history:</span>
</span><span data-line="879"><span class="sd">          indicates that get_history() should always return the &quot;old&quot; value,</span>
</span><span data-line="880"><span class="sd">          even if it means executing a lazy callable upon attribute change.</span>
</span><span data-line="881">
</span><span data-line="882"><span class="sd">        :param parent_token:</span>
</span><span data-line="883"><span class="sd">          Usually references the MapperProperty, used as a key for</span>
</span><span data-line="884"><span class="sd">          the hasparent() function to identify an &quot;owning&quot; attribute.</span>
</span><span data-line="885"><span class="sd">          Allows multiple AttributeImpls to all match a single</span>
</span><span data-line="886"><span class="sd">          owner attribute.</span>
</span><span data-line="887">
</span><span data-line="888"><span class="sd">        :param load_on_unexpire:</span>
</span><span data-line="889"><span class="sd">          if False, don&#39;t include this attribute in a load-on-expired</span>
</span><span data-line="890"><span class="sd">          operation, i.e. the &quot;expired_attribute_loader&quot; process.</span>
</span><span data-line="891"><span class="sd">          The attribute can still be in the &quot;expired&quot; list and be</span>
</span><span data-line="892"><span class="sd">          considered to be &quot;expired&quot;.   Previously, this flag was called</span>
</span><span data-line="893"><span class="sd">          &quot;expire_missing&quot; and is only used by a deferred column</span>
</span><span data-line="894"><span class="sd">          attribute.</span>
</span><span data-line="895">
</span><span data-line="896"><span class="sd">        :param send_modified_events:</span>
</span><span data-line="897"><span class="sd">          if False, the InstanceState._modified_event method will have no</span>
</span><span data-line="898"><span class="sd">          effect; this means the attribute will never show up as changed in a</span>
</span><span data-line="899"><span class="sd">          history entry.</span>
</span><span data-line="900">
</span><span data-line="901"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="902">        <span class="bp">self</span><span class="o">.</span><span class="n">class_</span> <span class="o">=</span> <span class="n">class_</span>
</span><span data-line="903">        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
</span><span data-line="904">        <span class="bp">self</span><span class="o">.</span><span class="n">callable_</span> <span class="o">=</span> <span class="n">callable_</span>
</span><span data-line="905">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span> <span class="o">=</span> <span class="n">dispatch</span>
</span><span data-line="906">        <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span> <span class="o">=</span> <span class="n">trackparent</span>
</span><span data-line="907">        <span class="bp">self</span><span class="o">.</span><span class="n">parent_token</span> <span class="o">=</span> <span class="n">parent_token</span> <span class="ow">or</span> <span class="bp">self</span>
</span><span data-line="908">        <span class="bp">self</span><span class="o">.</span><span class="n">send_modified_events</span> <span class="o">=</span> <span class="n">send_modified_events</span>
</span><span data-line="909">        <span class="k">if</span> <span class="n">compare_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="910">            <span class="bp">self</span><span class="o">.</span><span class="n">is_equal</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">eq</span>
</span><span data-line="911">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="912">            <span class="bp">self</span><span class="o">.</span><span class="n">is_equal</span> <span class="o">=</span> <span class="n">compare_function</span>
</span><span data-line="913">
</span><span data-line="914">        <span class="k">if</span> <span class="n">accepts_scalar_loader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="915">            <span class="bp">self</span><span class="o">.</span><span class="n">accepts_scalar_loader</span> <span class="o">=</span> <span class="n">accepts_scalar_loader</span>
</span><span data-line="916">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="917">            <span class="bp">self</span><span class="o">.</span><span class="n">accepts_scalar_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_accepts_scalar_loader</span>
</span><span data-line="918">
</span><span data-line="919">        <span class="n">_deferred_history</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_deferred_history&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span data-line="920">        <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_history</span> <span class="o">=</span> <span class="n">_deferred_history</span>
</span><span data-line="921">
</span><span data-line="922">        <span class="k">if</span> <span class="n">active_history</span><span class="p">:</span>
</span><span data-line="923">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="924">
</span><span data-line="925">        <span class="bp">self</span><span class="o">.</span><span class="n">load_on_unexpire</span> <span class="o">=</span> <span class="n">load_on_unexpire</span>
</span><span data-line="926">        <span class="bp">self</span><span class="o">.</span><span class="n">_modified_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_MODIFIED</span><span class="p">)</span>
</span><span data-line="927">
</span><span data-line="928">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="929">        <span class="s2">&quot;class_&quot;</span><span class="p">,</span>
</span><span data-line="930">        <span class="s2">&quot;key&quot;</span><span class="p">,</span>
</span><span data-line="931">        <span class="s2">&quot;callable_&quot;</span><span class="p">,</span>
</span><span data-line="932">        <span class="s2">&quot;dispatch&quot;</span><span class="p">,</span>
</span><span data-line="933">        <span class="s2">&quot;trackparent&quot;</span><span class="p">,</span>
</span><span data-line="934">        <span class="s2">&quot;parent_token&quot;</span><span class="p">,</span>
</span><span data-line="935">        <span class="s2">&quot;send_modified_events&quot;</span><span class="p">,</span>
</span><span data-line="936">        <span class="s2">&quot;is_equal&quot;</span><span class="p">,</span>
</span><span data-line="937">        <span class="s2">&quot;load_on_unexpire&quot;</span><span class="p">,</span>
</span><span data-line="938">        <span class="s2">&quot;_modified_token&quot;</span><span class="p">,</span>
</span><span data-line="939">        <span class="s2">&quot;accepts_scalar_loader&quot;</span><span class="p">,</span>
</span><span data-line="940">        <span class="s2">&quot;_deferred_history&quot;</span><span class="p">,</span>
</span><span data-line="941">    <span class="p">)</span>
</span><span data-line="942">
</span><span data-line="943">    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="944">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="945">
</span><span data-line="946">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_active_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="947"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Backwards compat for impl.active_history&quot;&quot;&quot;</span>
</span><span data-line="948">
</span><span data-line="949">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span>
</span><span data-line="950">
</span><span data-line="951">    <span class="k">def</span><span class="w"> </span><span class="nf">_set_active_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span data-line="952">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="953">
</span><span data-line="954">    <span class="n">active_history</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_active_history</span><span class="p">,</span> <span class="n">_set_active_history</span><span class="p">)</span>
</span><span data-line="955">
</span><span data-line="956">    <span class="k">def</span><span class="w"> </span><span class="nf">hasparent</span><span class="p">(</span>
</span><span data-line="957">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">optimistic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="958">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="959"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the boolean value of a `hasparent` flag attached to</span>
</span><span data-line="960"><span class="sd">        the given state.</span>
</span><span data-line="961">
</span><span data-line="962"><span class="sd">        The `optimistic` flag determines what the default return value</span>
</span><span data-line="963"><span class="sd">        should be if no `hasparent` flag can be located.</span>
</span><span data-line="964">
</span><span data-line="965"><span class="sd">        As this function is used to determine if an instance is an</span>
</span><span data-line="966"><span class="sd">        *orphan*, instances that were loaded from storage should be</span>
</span><span data-line="967"><span class="sd">        assumed to not be orphans, until a True/False value for this</span>
</span><span data-line="968"><span class="sd">        flag is set.</span>
</span><span data-line="969">
</span><span data-line="970"><span class="sd">        An instance attribute that is loaded by a callable function</span>
</span><span data-line="971"><span class="sd">        will also not have a `hasparent` flag.</span>
</span><span data-line="972">
</span><span data-line="973"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="974">        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;This AttributeImpl is not configured to track parents.&quot;</span>
</span><span data-line="975">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span><span class="p">,</span> <span class="n">msg</span>
</span><span data-line="976">
</span><span data-line="977">        <span class="k">return</span> <span class="p">(</span>
</span><span data-line="978">            <span class="n">state</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_token</span><span class="p">),</span> <span class="n">optimistic</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
</span><span data-line="979">        <span class="p">)</span>
</span><span data-line="980">
</span><span data-line="981">    <span class="k">def</span><span class="w"> </span><span class="nf">sethasparent</span><span class="p">(</span>
</span><span data-line="982">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="983">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="984">        <span class="n">parent_state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="985">        <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="986">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="987"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a boolean flag on the given item corresponding to</span>
</span><span data-line="988"><span class="sd">        whether or not it is attached to a parent object via the</span>
</span><span data-line="989"><span class="sd">        attribute represented by this ``InstrumentedAttribute``.</span>
</span><span data-line="990">
</span><span data-line="991"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="992">        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;This AttributeImpl is not configured to track parents.&quot;</span>
</span><span data-line="993">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span><span class="p">,</span> <span class="n">msg</span>
</span><span data-line="994">
</span><span data-line="995">        <span class="n">id_</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_token</span><span class="p">)</span>
</span><span data-line="996">        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
</span><span data-line="997">            <span class="n">state</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_state</span>
</span><span data-line="998">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="999">            <span class="k">if</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
</span><span data-line="1000">                <span class="n">last_parent</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span>
</span><span data-line="1001">
</span><span data-line="1002">                <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1003">                    <span class="n">last_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
</span><span data-line="1004">                    <span class="ow">and</span> <span class="n">last_parent</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">parent_state</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="1005">                <span class="p">):</span>
</span><span data-line="1006">                    <span class="k">if</span> <span class="n">last_parent</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1007">                        <span class="k">raise</span> <span class="n">orm_exc</span><span class="o">.</span><span class="n">StaleDataError</span><span class="p">(</span>
</span><span data-line="1008">                            <span class="s2">&quot;Removing state </span><span class="si">%s</span><span class="s2"> from parent &quot;</span>
</span><span data-line="1009">                            <span class="s2">&quot;state </span><span class="si">%s</span><span class="s2"> along attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span>
</span><span data-line="1010">                            <span class="s2">&quot;but the parent record &quot;</span>
</span><span data-line="1011">                            <span class="s2">&quot;has gone stale, can&#39;t be sure this &quot;</span>
</span><span data-line="1012">                            <span class="s2">&quot;is the most recent parent.&quot;</span>
</span><span data-line="1013">                            <span class="o">%</span> <span class="p">(</span>
</span><span data-line="1014">                                <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
</span><span data-line="1015">                                <span class="n">state_str</span><span class="p">(</span><span class="n">parent_state</span><span class="p">),</span>
</span><span data-line="1016">                                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="1017">                            <span class="p">)</span>
</span><span data-line="1018">                        <span class="p">)</span>
</span><span data-line="1019">
</span><span data-line="1020">                    <span class="k">return</span>
</span><span data-line="1021">
</span><span data-line="1022">            <span class="n">state</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1023">
</span><span data-line="1024">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span data-line="1025">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1026">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1027">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1028">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1029">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="1030">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1031">
</span><span data-line="1032">    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_pending</span><span class="p">(</span>
</span><span data-line="1033">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1034">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1035">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1036">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">,</span>
</span><span data-line="1037">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AllPendingType</span><span class="p">:</span>
</span><span data-line="1038"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of tuples of (state, obj)</span>
</span><span data-line="1039"><span class="sd">        for all objects in this attribute&#39;s current state</span>
</span><span data-line="1040"><span class="sd">        + history.</span>
</span><span data-line="1041">
</span><span data-line="1042"><span class="sd">        Only applies to object-based attributes.</span>
</span><span data-line="1043">
</span><span data-line="1044"><span class="sd">        This is an inlining of existing functionality</span>
</span><span data-line="1045"><span class="sd">        which roughly corresponds to:</span>
</span><span data-line="1046">
</span><span data-line="1047"><span class="sd">            get_state_history(</span>
</span><span data-line="1048"><span class="sd">                        state,</span>
</span><span data-line="1049"><span class="sd">                        key,</span>
</span><span data-line="1050"><span class="sd">                        passive=PASSIVE_NO_INITIALIZE).sum()</span>
</span><span data-line="1051">
</span><span data-line="1052"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1053">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1054">
</span><span data-line="1055">    <span class="k">def</span><span class="w"> </span><span class="nf">_default_value</span><span class="p">(</span>
</span><span data-line="1056">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span>
</span><span data-line="1057">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="1058"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce an empty value for an uninitialized scalar attribute.&quot;&quot;&quot;</span>
</span><span data-line="1059">
</span><span data-line="1060">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">,</span> <span class="p">(</span>
</span><span data-line="1061">            <span class="s2">&quot;_default_value should only be invoked for an &quot;</span>
</span><span data-line="1062">            <span class="s2">&quot;uninitialized or expired attribute&quot;</span>
</span><span data-line="1063">        <span class="p">)</span>
</span><span data-line="1064">
</span><span data-line="1065">        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1066">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">init_scalar</span><span class="p">:</span>
</span><span data-line="1067">            <span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span data-line="1068">            <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ATTR_EMPTY</span><span class="p">:</span>
</span><span data-line="1069">                <span class="n">value</span> <span class="o">=</span> <span class="n">ret</span>
</span><span data-line="1070">
</span><span data-line="1071">        <span class="k">return</span> <span class="n">value</span>
</span><span data-line="1072">
</span><span data-line="1073">    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
</span><span data-line="1074">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1075">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1076">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1077">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1078">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="1079"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a value from the given object.</span>
</span><span data-line="1080"><span class="sd">        If a callable is assembled on this object&#39;s attribute, and</span>
</span><span data-line="1081"><span class="sd">        passive is False, the callable will be executed and the</span>
</span><span data-line="1082"><span class="sd">        resulting value will be set as the new value for this attribute.</span>
</span><span data-line="1083"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1084">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span data-line="1085">            <span class="k">return</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1086">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1087">            <span class="c1"># if history present, don&#39;t load</span>
</span><span data-line="1088">            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="1089">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1090">                <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span>
</span><span data-line="1091">                <span class="ow">or</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="n">NO_VALUE</span>
</span><span data-line="1092">            <span class="p">):</span>
</span><span data-line="1093">                <span class="k">if</span> <span class="ow">not</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">CALLABLES_OK</span><span class="p">:</span>
</span><span data-line="1094">                    <span class="k">return</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span data-line="1095">
</span><span data-line="1096">                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fire_loader_callables</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span data-line="1097">
</span><span data-line="1098">                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span data-line="1099">                    <span class="k">return</span> <span class="n">value</span>
</span><span data-line="1100">                <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">ATTR_WAS_SET</span><span class="p">:</span>
</span><span data-line="1101">                    <span class="k">try</span><span class="p">:</span>
</span><span data-line="1102">                        <span class="k">return</span> <span class="n">dict_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1103">                    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="1104">                        <span class="c1"># TODO: no test coverage here.</span>
</span><span data-line="1105">                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
</span><span data-line="1106">                            <span class="s2">&quot;Deferred loader for attribute &quot;</span>
</span><span data-line="1107">                            <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> failed to populate &quot;</span>
</span><span data-line="1108">                            <span class="s2">&quot;correctly&quot;</span> <span class="o">%</span> <span class="n">key</span>
</span><span data-line="1109">                        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
</span><span data-line="1110">                <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ATTR_EMPTY</span><span class="p">:</span>
</span><span data-line="1111">                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_committed_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="1112">
</span><span data-line="1113">            <span class="k">if</span> <span class="ow">not</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">INIT_OK</span><span class="p">:</span>
</span><span data-line="1114">                <span class="k">return</span> <span class="n">NO_VALUE</span>
</span><span data-line="1115">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1116">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span data-line="1117">
</span><span data-line="1118">    <span class="k">def</span><span class="w"> </span><span class="nf">_fire_loader_callables</span><span class="p">(</span>
</span><span data-line="1119">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span>
</span><span data-line="1120">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="1121">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1122">            <span class="bp">self</span><span class="o">.</span><span class="n">accepts_scalar_loader</span>
</span><span data-line="1123">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_on_unexpire</span>
</span><span data-line="1124">            <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">expired_attributes</span>
</span><span data-line="1125">        <span class="p">):</span>
</span><span data-line="1126">            <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">_load_expired</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span data-line="1127">        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">callables</span><span class="p">:</span>
</span><span data-line="1128">            <span class="n">callable_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">callables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1129">            <span class="k">return</span> <span class="n">callable_</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span data-line="1130">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">callable_</span><span class="p">:</span>
</span><span data-line="1131">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callable_</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span data-line="1132">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1133">            <span class="k">return</span> <span class="n">ATTR_EMPTY</span>
</span><span data-line="1134">
</span><span data-line="1135">    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span>
</span><span data-line="1136">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1137">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1138">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1139">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1140">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1141">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1142">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1143">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span data-line="1144">
</span><span data-line="1145">    <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span>
</span><span data-line="1146">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1147">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1148">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1149">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1150">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1151">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1152">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1153">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span data-line="1154">            <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">,</span> <span class="n">check_old</span><span class="o">=</span><span class="n">value</span>
</span><span data-line="1155">        <span class="p">)</span>
</span><span data-line="1156">
</span><span data-line="1157">    <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span>
</span><span data-line="1158">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1159">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1160">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1161">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1162">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1163">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1164">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1165">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span data-line="1166">            <span class="n">state</span><span class="p">,</span>
</span><span data-line="1167">            <span class="n">dict_</span><span class="p">,</span>
</span><span data-line="1168">            <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1169">            <span class="n">initiator</span><span class="p">,</span>
</span><span data-line="1170">            <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">,</span>
</span><span data-line="1171">            <span class="n">check_old</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
</span><span data-line="1172">            <span class="n">pop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1173">        <span class="p">)</span>
</span><span data-line="1174">
</span><span data-line="1175">    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
</span><span data-line="1176">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1177">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1178">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1179">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1180">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1181">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1182">        <span class="n">check_old</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1183">        <span class="n">pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1184">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1185">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1186">
</span><span data-line="1187">    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1188">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1189">
</span><span data-line="1190">    <span class="k">def</span><span class="w"> </span><span class="nf">get_committed_value</span><span class="p">(</span>
</span><span data-line="1191">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1192">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1193">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1194">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1195">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="1196"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return the unchanged value of this attribute&quot;&quot;&quot;</span>
</span><span data-line="1197">
</span><span data-line="1198">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">:</span>
</span><span data-line="1199">            <span class="n">value</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1200">            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span data-line="1201">                <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="1202">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1203">                <span class="k">return</span> <span class="n">value</span>
</span><span data-line="1204">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1205">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span data-line="1206">
</span><span data-line="1207">    <span class="k">def</span><span class="w"> </span><span class="nf">set_committed_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span data-line="1208"><span class="w">        </span><span class="sd">&quot;&quot;&quot;set an attribute value on the given instance and &#39;commit&#39; it.&quot;&quot;&quot;</span>
</span><span data-line="1209">
</span><span data-line="1210">        <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="1211">        <span class="n">state</span><span class="o">.</span><span class="n">_commit</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">])</span>
</span><span data-line="1212">        <span class="k">return</span> <span class="n">value</span>
</span><span data-line="1213">
</span><span data-line="1214">
</span><span data-line="1215"><span class="k">class</span><span class="w"> </span><span class="nc">ScalarAttributeImpl</span><span class="p">(</span><span class="n">AttributeImpl</span><span class="p">):</span>
</span><span data-line="1216"><span class="w">    </span><span class="sd">&quot;&quot;&quot;represents a scalar value-holding InstrumentedAttribute.&quot;&quot;&quot;</span>
</span><span data-line="1217">
</span><span data-line="1218">    <span class="n">default_accepts_scalar_loader</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1219">    <span class="n">uses_objects</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1220">    <span class="n">supports_population</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1221">    <span class="n">collection</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1222">    <span class="n">dynamic</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1223">
</span><span data-line="1224">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s2">&quot;_replace_token&quot;</span><span class="p">,</span> <span class="s2">&quot;_append_token&quot;</span><span class="p">,</span> <span class="s2">&quot;_remove_token&quot;</span>
</span><span data-line="1225">
</span><span data-line="1226">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span><span data-line="1227">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="1228">        <span class="bp">self</span><span class="o">.</span><span class="n">_replace_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span>
</span><span data-line="1229">            <span class="bp">self</span><span class="p">,</span> <span class="n">OP_REPLACE</span>
</span><span data-line="1230">        <span class="p">)</span>
</span><span data-line="1231">        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_REMOVE</span><span class="p">)</span>
</span><span data-line="1232">
</span><span data-line="1233">    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1234">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span><span class="p">:</span>
</span><span data-line="1235">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">PASSIVE_RETURN_NO_VALUE</span><span class="p">)</span>
</span><span data-line="1236">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1237">            <span class="n">old</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">)</span>
</span><span data-line="1238">
</span><span data-line="1239">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
</span><span data-line="1240">            <span class="bp">self</span><span class="o">.</span><span class="n">fire_remove_event</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span><span class="p">)</span>
</span><span data-line="1241">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>
</span><span data-line="1242">
</span><span data-line="1243">        <span class="n">existing</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">)</span>
</span><span data-line="1244">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1245">            <span class="n">existing</span> <span class="ow">is</span> <span class="n">NO_VALUE</span>
</span><span data-line="1246">            <span class="ow">and</span> <span class="n">old</span> <span class="ow">is</span> <span class="n">NO_VALUE</span>
</span><span data-line="1247">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">expired</span>
</span><span data-line="1248">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">expired_attributes</span>
</span><span data-line="1249">        <span class="p">):</span>
</span><span data-line="1250">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> object does not have a value&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
</span><span data-line="1251">
</span><span data-line="1252">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span data-line="1253">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1254">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1255">        <span class="n">dict_</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="1256">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1257">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="1258">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span data-line="1259">            <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_scalar_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">])</span>
</span><span data-line="1260">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">:</span>
</span><span data-line="1261">            <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_scalar_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">)</span>
</span><span data-line="1262">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1263">            <span class="k">if</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">INIT_OK</span><span class="p">:</span>
</span><span data-line="1264">                <span class="n">passive</span> <span class="o">^=</span> <span class="n">INIT_OK</span>
</span><span data-line="1265">            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span data-line="1266">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span data-line="1267">                <span class="k">return</span> <span class="n">HISTORY_BLANK</span>
</span><span data-line="1268">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1269">                <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_scalar_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
</span><span data-line="1270">
</span><span data-line="1271">    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
</span><span data-line="1272">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1273">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1274">        <span class="n">dict_</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="1275">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1276">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1277">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1278">        <span class="n">check_old</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1279">        <span class="n">pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1280">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1281">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span><span class="p">:</span>
</span><span data-line="1282">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">PASSIVE_RETURN_NO_VALUE</span><span class="p">)</span>
</span><span data-line="1283">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1284">            <span class="n">old</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">)</span>
</span><span data-line="1285">
</span><span data-line="1286">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">set</span><span class="p">:</span>
</span><span data-line="1287">            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fire_replace_event</span><span class="p">(</span>
</span><span data-line="1288">                <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">initiator</span>
</span><span data-line="1289">            <span class="p">)</span>
</span><span data-line="1290">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>
</span><span data-line="1291">        <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="1292">
</span><span data-line="1293">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_replace_event</span><span class="p">(</span>
</span><span data-line="1294">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1295">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1296">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1297">        <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span>
</span><span data-line="1298">        <span class="n">previous</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1299">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1300">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span data-line="1301">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">set</span><span class="p">:</span>
</span><span data-line="1302">            <span class="n">value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span>
</span><span data-line="1303">                <span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">previous</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace_token</span>
</span><span data-line="1304">            <span class="p">)</span>
</span><span data-line="1305">        <span class="k">return</span> <span class="n">value</span>
</span><span data-line="1306">
</span><span data-line="1307">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_remove_event</span><span class="p">(</span>
</span><span data-line="1308">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1309">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1310">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1311">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1312">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1313">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1314">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
</span><span data-line="1315">            <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span><span class="p">)</span>
</span><span data-line="1316">
</span><span data-line="1317">
</span><span data-line="1318"><span class="k">class</span><span class="w"> </span><span class="nc">ScalarObjectAttributeImpl</span><span class="p">(</span><span class="n">ScalarAttributeImpl</span><span class="p">):</span>
</span><span data-line="1319"><span class="w">    </span><span class="sd">&quot;&quot;&quot;represents a scalar-holding InstrumentedAttribute,</span>
</span><span data-line="1320"><span class="sd">    where the target object is also instrumented.</span>
</span><span data-line="1321">
</span><span data-line="1322"><span class="sd">    Adds events to delete/set operations.</span>
</span><span data-line="1323">
</span><span data-line="1324"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1325">
</span><span data-line="1326">    <span class="n">default_accepts_scalar_loader</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1327">    <span class="n">uses_objects</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1328">    <span class="n">supports_population</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1329">    <span class="n">collection</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1330">
</span><span data-line="1331">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
</span><span data-line="1332">
</span><span data-line="1333">    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1334">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span><span class="p">:</span>
</span><span data-line="1335">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="1336">                <span class="n">state</span><span class="p">,</span>
</span><span data-line="1337">                <span class="n">dict_</span><span class="p">,</span>
</span><span data-line="1338">                <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_ONLY_PERSISTENT</span>
</span><span data-line="1339">                <span class="o">|</span> <span class="n">NO_AUTOFLUSH</span>
</span><span data-line="1340">                <span class="o">|</span> <span class="n">LOAD_AGAINST_COMMITTED</span><span class="p">,</span>
</span><span data-line="1341">            <span class="p">)</span>
</span><span data-line="1342">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1343">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="1344">                <span class="n">state</span><span class="p">,</span>
</span><span data-line="1345">                <span class="n">dict_</span><span class="p">,</span>
</span><span data-line="1346">                <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span> <span class="o">^</span> <span class="n">INIT_OK</span>
</span><span data-line="1347">                <span class="o">|</span> <span class="n">LOAD_AGAINST_COMMITTED</span>
</span><span data-line="1348">                <span class="o">|</span> <span class="n">NO_RAISE</span><span class="p">,</span>
</span><span data-line="1349">            <span class="p">)</span>
</span><span data-line="1350">
</span><span data-line="1351">        <span class="bp">self</span><span class="o">.</span><span class="n">fire_remove_event</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span><span class="p">)</span>
</span><span data-line="1352">
</span><span data-line="1353">        <span class="n">existing</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">)</span>
</span><span data-line="1354">
</span><span data-line="1355">        <span class="c1"># if the attribute is expired, we currently have no way to tell</span>
</span><span data-line="1356">        <span class="c1"># that an object-attribute was expired vs. not loaded.   So</span>
</span><span data-line="1357">        <span class="c1"># for this test, we look to see if the object has a DB identity.</span>
</span><span data-line="1358">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1359">            <span class="n">existing</span> <span class="ow">is</span> <span class="n">NO_VALUE</span>
</span><span data-line="1360">            <span class="ow">and</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span data-line="1361">            <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1362">        <span class="p">):</span>
</span><span data-line="1363">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> object does not have a value&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
</span><span data-line="1364">
</span><span data-line="1365">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span data-line="1366">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1367">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1368">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1369">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1370">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="1371">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span data-line="1372">            <span class="n">current</span> <span class="o">=</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1373">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1374">            <span class="k">if</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">INIT_OK</span><span class="p">:</span>
</span><span data-line="1375">                <span class="n">passive</span> <span class="o">^=</span> <span class="n">INIT_OK</span>
</span><span data-line="1376">            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span data-line="1377">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span data-line="1378">                <span class="k">return</span> <span class="n">HISTORY_BLANK</span>
</span><span data-line="1379">
</span><span data-line="1380">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_history</span><span class="p">:</span>
</span><span data-line="1381">            <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_object_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
</span><span data-line="1382">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1383">            <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">_NO_HISTORY</span><span class="p">)</span>
</span><span data-line="1384">            <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span data-line="1385">                <span class="n">loader_passive</span> <span class="o">=</span> <span class="n">passive</span> <span class="o">|</span> <span class="p">(</span>
</span><span data-line="1386">                    <span class="n">PASSIVE_ONLY_PERSISTENT</span>
</span><span data-line="1387">                    <span class="o">|</span> <span class="n">NO_AUTOFLUSH</span>
</span><span data-line="1388">                    <span class="o">|</span> <span class="n">LOAD_AGAINST_COMMITTED</span>
</span><span data-line="1389">                    <span class="o">|</span> <span class="n">NO_RAISE</span>
</span><span data-line="1390">                    <span class="o">|</span> <span class="n">DEFERRED_HISTORY_LOAD</span>
</span><span data-line="1391">                <span class="p">)</span>
</span><span data-line="1392">                <span class="n">original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fire_loader_callables</span><span class="p">(</span>
</span><span data-line="1393">                    <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">loader_passive</span>
</span><span data-line="1394">                <span class="p">)</span>
</span><span data-line="1395">            <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_object_attribute</span><span class="p">(</span>
</span><span data-line="1396">                <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">original</span><span class="o">=</span><span class="n">original</span>
</span><span data-line="1397">            <span class="p">)</span>
</span><span data-line="1398">
</span><span data-line="1399">    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_pending</span><span class="p">(</span>
</span><span data-line="1400">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1401">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1402">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1403">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">,</span>
</span><span data-line="1404">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AllPendingType</span><span class="p">:</span>
</span><span data-line="1405">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span data-line="1406">            <span class="n">current</span> <span class="o">=</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1407">        <span class="k">elif</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">CALLABLES_OK</span><span class="p">:</span>
</span><span data-line="1408">            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span data-line="1409">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1410">            <span class="k">return</span> <span class="p">[]</span>
</span><span data-line="1411">
</span><span data-line="1412">        <span class="n">ret</span><span class="p">:</span> <span class="n">_AllPendingType</span>
</span><span data-line="1413">
</span><span data-line="1414">        <span class="c1"># can&#39;t use __hash__(), can&#39;t use __eq__() here</span>
</span><span data-line="1415">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1416">            <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1417">            <span class="ow">and</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span data-line="1418">            <span class="ow">and</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span>
</span><span data-line="1419">        <span class="p">):</span>
</span><span data-line="1420">            <span class="n">ret</span> <span class="o">=</span> <span class="p">[(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">current</span><span class="p">)]</span>
</span><span data-line="1421">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1422">            <span class="n">ret</span> <span class="o">=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
</span><span data-line="1423">
</span><span data-line="1424">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">:</span>
</span><span data-line="1425">            <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1426">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1427">                <span class="n">original</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1428">                <span class="ow">and</span> <span class="n">original</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span data-line="1429">                <span class="ow">and</span> <span class="n">original</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span>
</span><span data-line="1430">                <span class="ow">and</span> <span class="n">original</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">current</span>
</span><span data-line="1431">            <span class="p">):</span>
</span><span data-line="1432">                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">instance_state</span><span class="p">(</span><span class="n">original</span><span class="p">),</span> <span class="n">original</span><span class="p">))</span>
</span><span data-line="1433">        <span class="k">return</span> <span class="n">ret</span>
</span><span data-line="1434">
</span><span data-line="1435">    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
</span><span data-line="1436">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1437">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1438">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1439">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1440">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1441">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1442">        <span class="n">check_old</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1443">        <span class="n">pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1444">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1445"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a value on the given InstanceState.&quot;&quot;&quot;</span>
</span><span data-line="1446">
</span><span data-line="1447">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span><span class="p">:</span>
</span><span data-line="1448">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="1449">                <span class="n">state</span><span class="p">,</span>
</span><span data-line="1450">                <span class="n">dict_</span><span class="p">,</span>
</span><span data-line="1451">                <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_ONLY_PERSISTENT</span>
</span><span data-line="1452">                <span class="o">|</span> <span class="n">NO_AUTOFLUSH</span>
</span><span data-line="1453">                <span class="o">|</span> <span class="n">LOAD_AGAINST_COMMITTED</span><span class="p">,</span>
</span><span data-line="1454">            <span class="p">)</span>
</span><span data-line="1455">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1456">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="1457">                <span class="n">state</span><span class="p">,</span>
</span><span data-line="1458">                <span class="n">dict_</span><span class="p">,</span>
</span><span data-line="1459">                <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span> <span class="o">^</span> <span class="n">INIT_OK</span>
</span><span data-line="1460">                <span class="o">|</span> <span class="n">LOAD_AGAINST_COMMITTED</span>
</span><span data-line="1461">                <span class="o">|</span> <span class="n">NO_RAISE</span><span class="p">,</span>
</span><span data-line="1462">            <span class="p">)</span>
</span><span data-line="1463">
</span><span data-line="1464">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1465">            <span class="n">check_old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1466">            <span class="ow">and</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span data-line="1467">            <span class="ow">and</span> <span class="n">check_old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">old</span>
</span><span data-line="1468">        <span class="p">):</span>
</span><span data-line="1469">            <span class="k">if</span> <span class="n">pop</span><span class="p">:</span>
</span><span data-line="1470">                <span class="k">return</span>
</span><span data-line="1471">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1472">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span data-line="1473">                    <span class="s2">&quot;Object </span><span class="si">%s</span><span class="s2"> not associated with </span><span class="si">%s</span><span class="s2"> on attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
</span><span data-line="1474">                    <span class="o">%</span> <span class="p">(</span><span class="n">instance_str</span><span class="p">(</span><span class="n">check_old</span><span class="p">),</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="1475">                <span class="p">)</span>
</span><span data-line="1476">
</span><span data-line="1477">        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fire_replace_event</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">initiator</span><span class="p">)</span>
</span><span data-line="1478">        <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="1479">
</span><span data-line="1480">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_remove_event</span><span class="p">(</span>
</span><span data-line="1481">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1482">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1483">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1484">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1485">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1486">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1487">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
</span><span data-line="1488">            <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1489">            <span class="n">PASSIVE_NO_RESULT</span><span class="p">,</span>
</span><span data-line="1490">            <span class="n">NO_VALUE</span><span class="p">,</span>
</span><span data-line="1491">        <span class="p">):</span>
</span><span data-line="1492">            <span class="bp">self</span><span class="o">.</span><span class="n">sethasparent</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span data-line="1493">
</span><span data-line="1494">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
</span><span data-line="1495">            <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span><span class="p">)</span>
</span><span data-line="1496">
</span><span data-line="1497">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="1498">
</span><span data-line="1499">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_replace_event</span><span class="p">(</span>
</span><span data-line="1500">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1501">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1502">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1503">        <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span>
</span><span data-line="1504">        <span class="n">previous</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1505">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1506">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span data-line="1507">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span><span class="p">:</span>
</span><span data-line="1508">            <span class="k">if</span> <span class="n">previous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">previous</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
</span><span data-line="1509">                <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1510">                <span class="n">PASSIVE_NO_RESULT</span><span class="p">,</span>
</span><span data-line="1511">                <span class="n">NO_VALUE</span><span class="p">,</span>
</span><span data-line="1512">            <span class="p">):</span>
</span><span data-line="1513">                <span class="bp">self</span><span class="o">.</span><span class="n">sethasparent</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">previous</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span data-line="1514">
</span><span data-line="1515">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">set</span><span class="p">:</span>
</span><span data-line="1516">            <span class="n">value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span>
</span><span data-line="1517">                <span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">previous</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace_token</span>
</span><span data-line="1518">            <span class="p">)</span>
</span><span data-line="1519">
</span><span data-line="1520">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span data-line="1521">
</span><span data-line="1522">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span><span class="p">:</span>
</span><span data-line="1523">            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1524">                <span class="bp">self</span><span class="o">.</span><span class="n">sethasparent</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="1525">
</span><span data-line="1526">        <span class="k">return</span> <span class="n">value</span>
</span><span data-line="1527">
</span><span data-line="1528">
</span><span data-line="1529"><span class="k">class</span><span class="w"> </span><span class="nc">HasCollectionAdapter</span><span class="p">:</span>
</span><span data-line="1530">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
</span><span data-line="1531">
</span><span data-line="1532">    <span class="n">collection</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="1533">    <span class="n">_is_has_collection_adapter</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1534">
</span><span data-line="1535">    <span class="k">def</span><span class="w"> </span><span class="nf">_dispose_previous_collection</span><span class="p">(</span>
</span><span data-line="1536">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1537">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1538">        <span class="n">collection</span><span class="p">:</span> <span class="n">_AdaptedCollectionProtocol</span><span class="p">,</span>
</span><span data-line="1539">        <span class="n">adapter</span><span class="p">:</span> <span class="n">CollectionAdapter</span><span class="p">,</span>
</span><span data-line="1540">        <span class="n">fire_event</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="1541">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1542">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1543">
</span><span data-line="1544">    <span class="nd">@overload</span>
</span><span data-line="1545">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span data-line="1546">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1547">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1548">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1549">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1550">        <span class="n">passive</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1551">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1552">
</span><span data-line="1553">    <span class="nd">@overload</span>
</span><span data-line="1554">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span data-line="1555">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1556">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1557">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1558">        <span class="n">user_data</span><span class="p">:</span> <span class="n">_AdaptedCollectionProtocol</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1559">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1560">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="1561">
</span><span data-line="1562">    <span class="nd">@overload</span>
</span><span data-line="1563">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span data-line="1564">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1565">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1566">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1567">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AdaptedCollectionProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1568">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1569">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="1570">        <span class="n">Literal</span><span class="p">[</span><span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">],</span> <span class="n">CollectionAdapter</span>
</span><span data-line="1571">    <span class="p">]:</span> <span class="o">...</span>
</span><span data-line="1572">
</span><span data-line="1573">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span data-line="1574">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1575">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1576">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1577">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AdaptedCollectionProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1578">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1579">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="1580">        <span class="n">Literal</span><span class="p">[</span><span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">],</span> <span class="n">CollectionAdapter</span>
</span><span data-line="1581">    <span class="p">]:</span>
</span><span data-line="1582">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1583">
</span><span data-line="1584">    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
</span><span data-line="1585">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1586">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1587">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1588">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1589">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1590">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1591">        <span class="n">check_old</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1592">        <span class="n">pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1593">        <span class="n">_adapt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1594">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1595">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="1596">
</span><span data-line="1597">
</span><span data-line="1598"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="1599">
</span><span data-line="1600">    <span class="k">def</span><span class="w"> </span><span class="nf">_is_collection_attribute_impl</span><span class="p">(</span>
</span><span data-line="1601">        <span class="n">impl</span><span class="p">:</span> <span class="n">AttributeImpl</span><span class="p">,</span>
</span><span data-line="1602">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="n">CollectionAttributeImpl</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="1603">
</span><span data-line="1604"><span class="k">else</span><span class="p">:</span>
</span><span data-line="1605">    <span class="n">_is_collection_attribute_impl</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;collection&quot;</span><span class="p">)</span>
</span><span data-line="1606">
</span><span data-line="1607">
</span><span data-line="1608"><span class="k">class</span><span class="w"> </span><span class="nc">CollectionAttributeImpl</span><span class="p">(</span><span class="n">HasCollectionAdapter</span><span class="p">,</span> <span class="n">AttributeImpl</span><span class="p">):</span>
</span><span data-line="1609"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A collection-holding attribute that instruments changes in membership.</span>
</span><span data-line="1610">
</span><span data-line="1611"><span class="sd">    Only handles collections of instrumented objects.</span>
</span><span data-line="1612">
</span><span data-line="1613"><span class="sd">    InstrumentedCollectionAttribute holds an arbitrary, user-specified</span>
</span><span data-line="1614"><span class="sd">    container object (defaulting to a list) and brokers access to the</span>
</span><span data-line="1615"><span class="sd">    CollectionAdapter, a &quot;view&quot; onto that object that presents consistent bag</span>
</span><span data-line="1616"><span class="sd">    semantics to the orm layer independent of the user data implementation.</span>
</span><span data-line="1617">
</span><span data-line="1618"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1619">
</span><span data-line="1620">    <span class="n">uses_objects</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1621">    <span class="n">collection</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1622">    <span class="n">default_accepts_scalar_loader</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1623">    <span class="n">supports_population</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1624">    <span class="n">dynamic</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1625">
</span><span data-line="1626">    <span class="n">_bulk_replace_token</span><span class="p">:</span> <span class="n">AttributeEventToken</span>
</span><span data-line="1627">
</span><span data-line="1628">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1629">        <span class="s2">&quot;copy&quot;</span><span class="p">,</span>
</span><span data-line="1630">        <span class="s2">&quot;collection_factory&quot;</span><span class="p">,</span>
</span><span data-line="1631">        <span class="s2">&quot;_append_token&quot;</span><span class="p">,</span>
</span><span data-line="1632">        <span class="s2">&quot;_remove_token&quot;</span><span class="p">,</span>
</span><span data-line="1633">        <span class="s2">&quot;_bulk_replace_token&quot;</span><span class="p">,</span>
</span><span data-line="1634">        <span class="s2">&quot;_duck_typed_as&quot;</span><span class="p">,</span>
</span><span data-line="1635">    <span class="p">)</span>
</span><span data-line="1636">
</span><span data-line="1637">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="1638">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1639">        <span class="n">class_</span><span class="p">,</span>
</span><span data-line="1640">        <span class="n">key</span><span class="p">,</span>
</span><span data-line="1641">        <span class="n">callable_</span><span class="p">,</span>
</span><span data-line="1642">        <span class="n">dispatch</span><span class="p">,</span>
</span><span data-line="1643">        <span class="n">typecallable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="1644">        <span class="n">trackparent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1645">        <span class="n">copy_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="1646">        <span class="n">compare_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="1647">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="1648">    <span class="p">):</span>
</span><span data-line="1649">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="1650">            <span class="n">class_</span><span class="p">,</span>
</span><span data-line="1651">            <span class="n">key</span><span class="p">,</span>
</span><span data-line="1652">            <span class="n">callable_</span><span class="p">,</span>
</span><span data-line="1653">            <span class="n">dispatch</span><span class="p">,</span>
</span><span data-line="1654">            <span class="n">trackparent</span><span class="o">=</span><span class="n">trackparent</span><span class="p">,</span>
</span><span data-line="1655">            <span class="n">compare_function</span><span class="o">=</span><span class="n">compare_function</span><span class="p">,</span>
</span><span data-line="1656">            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="1657">        <span class="p">)</span>
</span><span data-line="1658">
</span><span data-line="1659">        <span class="k">if</span> <span class="n">copy_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1660">            <span class="n">copy_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__copy</span>
</span><span data-line="1661">        <span class="bp">self</span><span class="o">.</span><span class="n">copy</span> <span class="o">=</span> <span class="n">copy_function</span>
</span><span data-line="1662">        <span class="bp">self</span><span class="o">.</span><span class="n">collection_factory</span> <span class="o">=</span> <span class="n">typecallable</span>
</span><span data-line="1663">        <span class="bp">self</span><span class="o">.</span><span class="n">_append_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_APPEND</span><span class="p">)</span>
</span><span data-line="1664">        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_REMOVE</span><span class="p">)</span>
</span><span data-line="1665">        <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_replace_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_BULK_REPLACE</span><span class="p">)</span>
</span><span data-line="1666">        <span class="bp">self</span><span class="o">.</span><span class="n">_duck_typed_as</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">duck_type_collection</span><span class="p">(</span>
</span><span data-line="1667">            <span class="bp">self</span><span class="o">.</span><span class="n">collection_factory</span><span class="p">()</span>
</span><span data-line="1668">        <span class="p">)</span>
</span><span data-line="1669">
</span><span data-line="1670">        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_factory</span><span class="p">,</span> <span class="s2">&quot;_sa_linker&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span><span data-line="1671">
</span><span data-line="1672">            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;init_collection&quot;</span><span class="p">)</span>
</span><span data-line="1673">            <span class="k">def</span><span class="w"> </span><span class="nf">link</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">collection_adapter</span><span class="p">):</span>
</span><span data-line="1674">                <span class="n">collection</span><span class="o">.</span><span class="n">_sa_linker</span><span class="p">(</span><span class="n">collection_adapter</span><span class="p">)</span>
</span><span data-line="1675">
</span><span data-line="1676">            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dispose_collection&quot;</span><span class="p">)</span>
</span><span data-line="1677">            <span class="k">def</span><span class="w"> </span><span class="nf">unlink</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">collection_adapter</span><span class="p">):</span>
</span><span data-line="1678">                <span class="n">collection</span><span class="o">.</span><span class="n">_sa_linker</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span data-line="1679">
</span><span data-line="1680">    <span class="k">def</span><span class="w"> </span><span class="nf">__copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span><span data-line="1681">        <span class="k">return</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">collections</span><span class="o">.</span><span class="n">collection_adapter</span><span class="p">(</span><span class="n">item</span><span class="p">)]</span>
</span><span data-line="1682">
</span><span data-line="1683">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span data-line="1684">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1685">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1686">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1687">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1688">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="1689">        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span data-line="1690">
</span><span data-line="1691">        <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span data-line="1692">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1693">                <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">INCLUDE_PENDING_MUTATIONS</span>
</span><span data-line="1694">                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">_pending_mutations</span>
</span><span data-line="1695">            <span class="p">):</span>
</span><span data-line="1696">                <span class="n">pending</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">_pending_mutations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1697">                <span class="k">return</span> <span class="n">pending</span><span class="o">.</span><span class="n">merge_with_history</span><span class="p">(</span><span class="n">HISTORY_BLANK</span><span class="p">)</span>
</span><span data-line="1698">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1699">                <span class="k">return</span> <span class="n">HISTORY_BLANK</span>
</span><span data-line="1700">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1701">            <span class="k">if</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">INCLUDE_PENDING_MUTATIONS</span><span class="p">:</span>
</span><span data-line="1702">                <span class="c1"># this collection is loaded / present.  should not be any</span>
</span><span data-line="1703">                <span class="c1"># pending mutations</span>
</span><span data-line="1704">                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">_pending_mutations</span>
</span><span data-line="1705">
</span><span data-line="1706">            <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
</span><span data-line="1707">
</span><span data-line="1708">    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_pending</span><span class="p">(</span>
</span><span data-line="1709">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1710">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1711">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1712">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">,</span>
</span><span data-line="1713">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AllPendingType</span><span class="p">:</span>
</span><span data-line="1714">        <span class="c1"># NOTE: passive is ignored here at the moment</span>
</span><span data-line="1715">
</span><span data-line="1716">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span data-line="1717">            <span class="k">return</span> <span class="p">[]</span>
</span><span data-line="1718">
</span><span data-line="1719">        <span class="n">current</span> <span class="o">=</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1720">        <span class="n">current</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s2">&quot;_sa_adapter&quot;</span><span class="p">)</span>
</span><span data-line="1721">
</span><span data-line="1722">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">:</span>
</span><span data-line="1723">            <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1724">            <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span data-line="1725">                <span class="n">current_states</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="1726">                    <span class="p">((</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span data-line="1727">                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">current</span>
</span><span data-line="1728">                <span class="p">]</span>
</span><span data-line="1729">                <span class="n">original_states</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="1730">                    <span class="p">((</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span data-line="1731">                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">original</span>
</span><span data-line="1732">                <span class="p">]</span>
</span><span data-line="1733">
</span><span data-line="1734">                <span class="n">current_set</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">current_states</span><span class="p">)</span>
</span><span data-line="1735">                <span class="n">original_set</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">original_states</span><span class="p">)</span>
</span><span data-line="1736">
</span><span data-line="1737">                <span class="k">return</span> <span class="p">(</span>
</span><span data-line="1738">                    <span class="p">[</span>
</span><span data-line="1739">                        <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
</span><span data-line="1740">                        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">current_states</span>
</span><span data-line="1741">                        <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_set</span>
</span><span data-line="1742">                    <span class="p">]</span>
</span><span data-line="1743">                    <span class="o">+</span> <span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">current_states</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">original_set</span><span class="p">]</span>
</span><span data-line="1744">                    <span class="o">+</span> <span class="p">[</span>
</span><span data-line="1745">                        <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
</span><span data-line="1746">                        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">original_states</span>
</span><span data-line="1747">                        <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_set</span>
</span><span data-line="1748">                    <span class="p">]</span>
</span><span data-line="1749">                <span class="p">)</span>
</span><span data-line="1750">
</span><span data-line="1751">        <span class="k">return</span> <span class="p">[(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">current</span><span class="p">]</span>
</span><span data-line="1752">
</span><span data-line="1753">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_append_event</span><span class="p">(</span>
</span><span data-line="1754">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1755">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1756">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1757">        <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span>
</span><span data-line="1758">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1759">        <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1760">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span data-line="1761">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">append</span><span class="p">:</span>
</span><span data-line="1762">            <span class="n">value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="1763">
</span><span data-line="1764">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="1765">
</span><span data-line="1766">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1767">            <span class="bp">self</span><span class="o">.</span><span class="n">sethasparent</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="1768">
</span><span data-line="1769">        <span class="k">return</span> <span class="n">value</span>
</span><span data-line="1770">
</span><span data-line="1771">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_append_wo_mutation_event</span><span class="p">(</span>
</span><span data-line="1772">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1773">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1774">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1775">        <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span>
</span><span data-line="1776">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1777">        <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1778">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span data-line="1779">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">append_wo_mutation</span><span class="p">:</span>
</span><span data-line="1780">            <span class="n">value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="1781">
</span><span data-line="1782">        <span class="k">return</span> <span class="n">value</span>
</span><span data-line="1783">
</span><span data-line="1784">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_pre_remove_event</span><span class="p">(</span>
</span><span data-line="1785">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1786">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1787">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1788">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1789">        <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1790">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1791"><span class="w">        </span><span class="sd">&quot;&quot;&quot;A special event used for pop() operations.</span>
</span><span data-line="1792">
</span><span data-line="1793"><span class="sd">        The &quot;remove&quot; event needs to have the item to be removed passed to</span>
</span><span data-line="1794"><span class="sd">        it, which in the case of pop from a set, we don&#39;t have a way to access</span>
</span><span data-line="1795"><span class="sd">        the item before the operation.   the event is used for all pop()</span>
</span><span data-line="1796"><span class="sd">        operations (even though set.pop is the one where it is really needed).</span>
</span><span data-line="1797">
</span><span data-line="1798"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1799">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="1800">
</span><span data-line="1801">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_remove_event</span><span class="p">(</span>
</span><span data-line="1802">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1803">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1804">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1805">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1806">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1807">        <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1808">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1809">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1810">            <span class="bp">self</span><span class="o">.</span><span class="n">sethasparent</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span data-line="1811">
</span><span data-line="1812">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
</span><span data-line="1813">            <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="1814">
</span><span data-line="1815">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="1816">
</span><span data-line="1817">    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1818">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span data-line="1819">            <span class="k">return</span>
</span><span data-line="1820">
</span><span data-line="1821">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="1822">
</span><span data-line="1823">        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span>
</span><span data-line="1824">        <span class="n">collection</span><span class="o">.</span><span class="n">clear_with_event</span><span class="p">()</span>
</span><span data-line="1825">
</span><span data-line="1826">        <span class="c1"># key is always present because we checked above.  e.g.</span>
</span><span data-line="1827">        <span class="c1"># del is a no-op if collection not present.</span>
</span><span data-line="1828">        <span class="k">del</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1829">
</span><span data-line="1830">    <span class="k">def</span><span class="w"> </span><span class="nf">_default_value</span><span class="p">(</span>
</span><span data-line="1831">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span>
</span><span data-line="1832">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AdaptedCollectionProtocol</span><span class="p">:</span>
</span><span data-line="1833"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce an empty collection for an un-initialized attribute&quot;&quot;&quot;</span>
</span><span data-line="1834">
</span><span data-line="1835">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">,</span> <span class="p">(</span>
</span><span data-line="1836">            <span class="s2">&quot;_default_value should only be invoked for an &quot;</span>
</span><span data-line="1837">            <span class="s2">&quot;uninitialized or expired attribute&quot;</span>
</span><span data-line="1838">        <span class="p">)</span>
</span><span data-line="1839">
</span><span data-line="1840">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">_empty_collections</span><span class="p">:</span>
</span><span data-line="1841">            <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">_empty_collections</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1842">
</span><span data-line="1843">        <span class="n">adapter</span><span class="p">,</span> <span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_collection</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="1844">        <span class="n">adapter</span><span class="o">.</span><span class="n">_set_empty</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
</span><span data-line="1845">        <span class="k">return</span> <span class="n">user_data</span>
</span><span data-line="1846">
</span><span data-line="1847">    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_collection</span><span class="p">(</span>
</span><span data-line="1848">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="1849">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">CollectionAdapter</span><span class="p">,</span> <span class="n">_AdaptedCollectionProtocol</span><span class="p">]:</span>
</span><span data-line="1850">        <span class="n">adapter</span><span class="p">,</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">initialize_collection</span><span class="p">(</span>
</span><span data-line="1851">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_factory</span>
</span><span data-line="1852">        <span class="p">)</span>
</span><span data-line="1853">
</span><span data-line="1854">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">init_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">adapter</span><span class="p">)</span>
</span><span data-line="1855">
</span><span data-line="1856">        <span class="k">return</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">collection</span>
</span><span data-line="1857">
</span><span data-line="1858">    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span>
</span><span data-line="1859">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1860">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1861">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1862">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1863">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1864">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1865">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1866">        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span>
</span><span data-line="1867">            <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span>
</span><span data-line="1868">        <span class="p">)</span>
</span><span data-line="1869">        <span class="k">if</span> <span class="n">collection</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span data-line="1870">            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fire_append_event</span><span class="p">(</span>
</span><span data-line="1871">                <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">NO_KEY</span>
</span><span data-line="1872">            <span class="p">)</span>
</span><span data-line="1873">            <span class="k">assert</span> <span class="p">(</span>
</span><span data-line="1874">                <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span>
</span><span data-line="1875">            <span class="p">),</span> <span class="s2">&quot;Collection was loaded during event handling.&quot;</span>
</span><span data-line="1876">            <span class="n">state</span><span class="o">.</span><span class="n">_get_pending_mutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1877">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1878">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="1879">                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">CollectionAdapter</span><span class="p">)</span>
</span><span data-line="1880">            <span class="n">collection</span><span class="o">.</span><span class="n">append_with_event</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">)</span>
</span><span data-line="1881">
</span><span data-line="1882">    <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span>
</span><span data-line="1883">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1884">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1885">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1886">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1887">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1888">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1889">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1890">        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span>
</span><span data-line="1891">            <span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span>
</span><span data-line="1892">        <span class="p">)</span>
</span><span data-line="1893">        <span class="k">if</span> <span class="n">collection</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span data-line="1894">            <span class="bp">self</span><span class="o">.</span><span class="n">fire_remove_event</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">NO_KEY</span><span class="p">)</span>
</span><span data-line="1895">            <span class="k">assert</span> <span class="p">(</span>
</span><span data-line="1896">                <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span>
</span><span data-line="1897">            <span class="p">),</span> <span class="s2">&quot;Collection was loaded during event handling.&quot;</span>
</span><span data-line="1898">            <span class="n">state</span><span class="o">.</span><span class="n">_get_pending_mutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1899">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1900">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="1901">                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">CollectionAdapter</span><span class="p">)</span>
</span><span data-line="1902">            <span class="n">collection</span><span class="o">.</span><span class="n">remove_with_event</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">)</span>
</span><span data-line="1903">
</span><span data-line="1904">    <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span>
</span><span data-line="1905">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1906">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1907">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1908">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1909">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span data-line="1910">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1911">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1912">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1913">            <span class="c1"># TODO: better solution here would be to add</span>
</span><span data-line="1914">            <span class="c1"># a &quot;popper&quot; role to collections.py to complement</span>
</span><span data-line="1915">            <span class="c1"># &quot;remover&quot;.</span>
</span><span data-line="1916">            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span data-line="1917">        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
</span><span data-line="1918">            <span class="k">pass</span>
</span><span data-line="1919">
</span><span data-line="1920">    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
</span><span data-line="1921">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1922">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1923">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="1924">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1925">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1926">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="1927">        <span class="n">check_old</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1928">        <span class="n">pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1929">        <span class="n">_adapt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1930">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1931">        <span class="n">iterable</span> <span class="o">=</span> <span class="n">orig_iterable</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="1932">        <span class="n">new_keys</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1933">
</span><span data-line="1934">        <span class="c1"># pulling a new collection first so that an adaptation exception does</span>
</span><span data-line="1935">        <span class="c1"># not trigger a lazy load of the old collection.</span>
</span><span data-line="1936">        <span class="n">new_collection</span><span class="p">,</span> <span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_collection</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="1937">        <span class="k">if</span> <span class="n">_adapt</span><span class="p">:</span>
</span><span data-line="1938">            <span class="k">if</span> <span class="n">new_collection</span><span class="o">.</span><span class="n">_converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1939">                <span class="n">iterable</span> <span class="o">=</span> <span class="n">new_collection</span><span class="o">.</span><span class="n">_converter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span><span data-line="1940">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1941">                <span class="n">setting_type</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">duck_type_collection</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span><span data-line="1942">                <span class="n">receiving_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duck_typed_as</span>
</span><span data-line="1943">
</span><span data-line="1944">                <span class="k">if</span> <span class="n">setting_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">receiving_type</span><span class="p">:</span>
</span><span data-line="1945">                    <span class="n">given</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1946">                        <span class="n">iterable</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1947">                        <span class="ow">and</span> <span class="s2">&quot;None&quot;</span>
</span><span data-line="1948">                        <span class="ow">or</span> <span class="n">iterable</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span><span data-line="1949">                    <span class="p">)</span>
</span><span data-line="1950">                    <span class="n">wanted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duck_typed_as</span><span class="o">.</span><span class="vm">__name__</span>
</span><span data-line="1951">                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span data-line="1952">                        <span class="s2">&quot;Incompatible collection type: </span><span class="si">%s</span><span class="s2"> is not </span><span class="si">%s</span><span class="s2">-like&quot;</span>
</span><span data-line="1953">                        <span class="o">%</span> <span class="p">(</span><span class="n">given</span><span class="p">,</span> <span class="n">wanted</span><span class="p">)</span>
</span><span data-line="1954">                    <span class="p">)</span>
</span><span data-line="1955">
</span><span data-line="1956">                <span class="c1"># If the object is an adapted collection, return the (iterable)</span>
</span><span data-line="1957">                <span class="c1"># adapter.</span>
</span><span data-line="1958">                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="s2">&quot;_sa_iterator&quot;</span><span class="p">):</span>
</span><span data-line="1959">                    <span class="n">iterable</span> <span class="o">=</span> <span class="n">iterable</span><span class="o">.</span><span class="n">_sa_iterator</span><span class="p">()</span>
</span><span data-line="1960">                <span class="k">elif</span> <span class="n">setting_type</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span><span data-line="1961">                    <span class="n">new_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span><span data-line="1962">                    <span class="n">iterable</span> <span class="o">=</span> <span class="n">iterable</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span data-line="1963">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1964">                    <span class="n">iterable</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span><span data-line="1965">        <span class="k">elif</span> <span class="n">util</span><span class="o">.</span><span class="n">duck_type_collection</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span><span data-line="1966">            <span class="n">new_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="1967">
</span><span data-line="1968">        <span class="n">new_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span><span data-line="1969">
</span><span data-line="1970">        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_replace_token</span>
</span><span data-line="1971">
</span><span data-line="1972">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">bulk_replace</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">new_values</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">new_keys</span><span class="p">)</span>
</span><span data-line="1973">
</span><span data-line="1974">        <span class="c1"># propagate NO_RAISE in passive through to the get() for the</span>
</span><span data-line="1975">        <span class="c1"># existing object (ticket #8862)</span>
</span><span data-line="1976">        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="1977">            <span class="n">state</span><span class="p">,</span>
</span><span data-line="1978">            <span class="n">dict_</span><span class="p">,</span>
</span><span data-line="1979">            <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_ONLY_PERSISTENT</span> <span class="o">^</span> <span class="p">(</span><span class="n">passive</span> <span class="o">&amp;</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">NO_RAISE</span><span class="p">),</span>
</span><span data-line="1980">        <span class="p">)</span>
</span><span data-line="1981">        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span data-line="1982">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span data-line="1983">        <span class="k">elif</span> <span class="n">old</span> <span class="ow">is</span> <span class="n">orig_iterable</span><span class="p">:</span>
</span><span data-line="1984">            <span class="c1"># ignore re-assignment of the current collection, as happens</span>
</span><span data-line="1985">            <span class="c1"># implicitly with in-place operators (foo.collection |= other)</span>
</span><span data-line="1986">            <span class="k">return</span>
</span><span data-line="1987">
</span><span data-line="1988">        <span class="c1"># place a copy of &quot;old&quot; in state.committed_state</span>
</span><span data-line="1989">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="1990">
</span><span data-line="1991">        <span class="n">old_collection</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">_sa_adapter</span>
</span><span data-line="1992">
</span><span data-line="1993">        <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_data</span>
</span><span data-line="1994">
</span><span data-line="1995">        <span class="n">collections</span><span class="o">.</span><span class="n">bulk_replace</span><span class="p">(</span>
</span><span data-line="1996">            <span class="n">new_values</span><span class="p">,</span> <span class="n">old_collection</span><span class="p">,</span> <span class="n">new_collection</span><span class="p">,</span> <span class="n">initiator</span><span class="o">=</span><span class="n">evt</span>
</span><span data-line="1997">        <span class="p">)</span>
</span><span data-line="1998">
</span><span data-line="1999">        <span class="bp">self</span><span class="o">.</span><span class="n">_dispose_previous_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">old_collection</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="2000">
</span><span data-line="2001">    <span class="k">def</span><span class="w"> </span><span class="nf">_dispose_previous_collection</span><span class="p">(</span>
</span><span data-line="2002">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2003">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="2004">        <span class="n">collection</span><span class="p">:</span> <span class="n">_AdaptedCollectionProtocol</span><span class="p">,</span>
</span><span data-line="2005">        <span class="n">adapter</span><span class="p">:</span> <span class="n">CollectionAdapter</span><span class="p">,</span>
</span><span data-line="2006">        <span class="n">fire_event</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="2007">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2008">        <span class="k">del</span> <span class="n">collection</span><span class="o">.</span><span class="n">_sa_adapter</span>
</span><span data-line="2009">
</span><span data-line="2010">        <span class="c1"># discarding old collection make sure it is not referenced in empty</span>
</span><span data-line="2011">        <span class="c1"># collections.</span>
</span><span data-line="2012">        <span class="n">state</span><span class="o">.</span><span class="n">_empty_collections</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="2013">        <span class="k">if</span> <span class="n">fire_event</span><span class="p">:</span>
</span><span data-line="2014">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">dispose_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">adapter</span><span class="p">)</span>
</span><span data-line="2015">
</span><span data-line="2016">    <span class="k">def</span><span class="w"> </span><span class="nf">_invalidate_collection</span><span class="p">(</span>
</span><span data-line="2017">        <span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="n">_AdaptedCollectionProtocol</span>
</span><span data-line="2018">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2019">        <span class="n">adapter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;_sa_adapter&quot;</span><span class="p">)</span>
</span><span data-line="2020">        <span class="n">adapter</span><span class="o">.</span><span class="n">invalidated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="2021">
</span><span data-line="2022">    <span class="k">def</span><span class="w"> </span><span class="nf">set_committed_value</span><span class="p">(</span>
</span><span data-line="2023">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="2024">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AdaptedCollectionProtocol</span><span class="p">:</span>
</span><span data-line="2025"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set an attribute value on the given instance and &#39;commit&#39; it.&quot;&quot;&quot;</span>
</span><span data-line="2026">
</span><span data-line="2027">        <span class="n">collection</span><span class="p">,</span> <span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_collection</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="2028">
</span><span data-line="2029">        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
</span><span data-line="2030">            <span class="n">collection</span><span class="o">.</span><span class="n">append_multiple_without_event</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span data-line="2031">
</span><span data-line="2032">        <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_data</span>
</span><span data-line="2033">
</span><span data-line="2034">        <span class="n">state</span><span class="o">.</span><span class="n">_commit</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">])</span>
</span><span data-line="2035">
</span><span data-line="2036">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">_pending_mutations</span><span class="p">:</span>
</span><span data-line="2037">            <span class="c1"># pending items exist.  issue a modified event,</span>
</span><span data-line="2038">            <span class="c1"># add/remove new items.</span>
</span><span data-line="2039">            <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="2040">
</span><span data-line="2041">            <span class="n">pending</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">_pending_mutations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="2042">            <span class="n">added</span> <span class="o">=</span> <span class="n">pending</span><span class="o">.</span><span class="n">added_items</span>
</span><span data-line="2043">            <span class="n">removed</span> <span class="o">=</span> <span class="n">pending</span><span class="o">.</span><span class="n">deleted_items</span>
</span><span data-line="2044">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">added</span><span class="p">:</span>
</span><span data-line="2045">                <span class="n">collection</span><span class="o">.</span><span class="n">append_without_event</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span data-line="2046">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">removed</span><span class="p">:</span>
</span><span data-line="2047">                <span class="n">collection</span><span class="o">.</span><span class="n">remove_without_event</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span data-line="2048">
</span><span data-line="2049">        <span class="k">return</span> <span class="n">user_data</span>
</span><span data-line="2050">
</span><span data-line="2051">    <span class="nd">@overload</span>
</span><span data-line="2052">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span data-line="2053">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2054">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="2055">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="2056">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="2057">        <span class="n">passive</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="2058">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="2059">
</span><span data-line="2060">    <span class="nd">@overload</span>
</span><span data-line="2061">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span data-line="2062">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2063">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="2064">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="2065">        <span class="n">user_data</span><span class="p">:</span> <span class="n">_AdaptedCollectionProtocol</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="2066">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="2067">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="2068">
</span><span data-line="2069">    <span class="nd">@overload</span>
</span><span data-line="2070">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span data-line="2071">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2072">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="2073">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="2074">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AdaptedCollectionProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="2075">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="2076">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="2077">        <span class="n">Literal</span><span class="p">[</span><span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">],</span> <span class="n">CollectionAdapter</span>
</span><span data-line="2078">    <span class="p">]:</span> <span class="o">...</span>
</span><span data-line="2079">
</span><span data-line="2080">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span data-line="2081">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2082">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="2083">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="2084">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AdaptedCollectionProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2085">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="2086">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="2087">        <span class="n">Literal</span><span class="p">[</span><span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">],</span> <span class="n">CollectionAdapter</span>
</span><span data-line="2088">    <span class="p">]:</span>
</span><span data-line="2089"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the CollectionAdapter associated with the given state.</span>
</span><span data-line="2090">
</span><span data-line="2091"><span class="sd">        if user_data is None, retrieves it from the state using normal</span>
</span><span data-line="2092"><span class="sd">        &quot;get()&quot; rules, which will fire lazy callables or return the &quot;empty&quot;</span>
</span><span data-line="2093"><span class="sd">        collection value.</span>
</span><span data-line="2094">
</span><span data-line="2095"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2096">        <span class="k">if</span> <span class="n">user_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2097">            <span class="n">fetch_user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span data-line="2098">            <span class="k">if</span> <span class="n">fetch_user_data</span> <span class="ow">is</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span data-line="2099">                <span class="k">return</span> <span class="n">fetch_user_data</span>
</span><span data-line="2100">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2101">                <span class="n">user_data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;_AdaptedCollectionProtocol&quot;</span><span class="p">,</span> <span class="n">fetch_user_data</span><span class="p">)</span>
</span><span data-line="2102">
</span><span data-line="2103">        <span class="k">return</span> <span class="n">user_data</span><span class="o">.</span><span class="n">_sa_adapter</span>
</span><span data-line="2104">
</span><span data-line="2105">
</span><span data-line="2106"><span class="k">def</span><span class="w"> </span><span class="nf">backref_listeners</span><span class="p">(</span>
</span><span data-line="2107">    <span class="n">attribute</span><span class="p">:</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">uselist</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="2108"><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2109"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply listeners to synchronize a two-way relationship.&quot;&quot;&quot;</span>
</span><span data-line="2110">
</span><span data-line="2111">    <span class="c1"># use easily recognizable names for stack traces.</span>
</span><span data-line="2112">
</span><span data-line="2113">    <span class="c1"># in the sections marked &quot;tokens to test for a recursive loop&quot;,</span>
</span><span data-line="2114">    <span class="c1"># this is somewhat brittle and very performance-sensitive logic</span>
</span><span data-line="2115">    <span class="c1"># that is specific to how we might arrive at each event.  a marker</span>
</span><span data-line="2116">    <span class="c1"># that can target us directly to arguments being invoked against</span>
</span><span data-line="2117">    <span class="c1"># the impl might be simpler, but could interfere with other systems.</span>
</span><span data-line="2118">
</span><span data-line="2119">    <span class="n">parent_token</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">parent_token</span>
</span><span data-line="2120">    <span class="n">parent_impl</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">impl</span>
</span><span data-line="2121">
</span><span data-line="2122">    <span class="k">def</span><span class="w"> </span><span class="nf">_acceptable_key_err</span><span class="p">(</span><span class="n">child_state</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">child_impl</span><span class="p">):</span>
</span><span data-line="2123">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span data-line="2124">            <span class="s2">&quot;Bidirectional attribute conflict detected: &quot;</span>
</span><span data-line="2125">            <span class="s1">&#39;Passing object </span><span class="si">%s</span><span class="s1"> to attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; &#39;</span>
</span><span data-line="2126">            <span class="s1">&#39;triggers a modify event on attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; &#39;</span>
</span><span data-line="2127">            <span class="s1">&#39;via the backref &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span>
</span><span data-line="2128">            <span class="o">%</span> <span class="p">(</span>
</span><span data-line="2129">                <span class="n">state_str</span><span class="p">(</span><span class="n">child_state</span><span class="p">),</span>
</span><span data-line="2130">                <span class="n">initiator</span><span class="o">.</span><span class="n">parent_token</span><span class="p">,</span>
</span><span data-line="2131">                <span class="n">child_impl</span><span class="o">.</span><span class="n">parent_token</span><span class="p">,</span>
</span><span data-line="2132">                <span class="n">attribute</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">parent_token</span><span class="p">,</span>
</span><span data-line="2133">            <span class="p">)</span>
</span><span data-line="2134">        <span class="p">)</span>
</span><span data-line="2135">
</span><span data-line="2136">    <span class="k">def</span><span class="w"> </span><span class="nf">emit_backref_from_scalar_set_event</span><span class="p">(</span>
</span><span data-line="2137">        <span class="n">state</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">oldchild</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span data-line="2138">    <span class="p">):</span>
</span><span data-line="2139">        <span class="k">if</span> <span class="n">oldchild</span> <span class="ow">is</span> <span class="n">child</span><span class="p">:</span>
</span><span data-line="2140">            <span class="k">return</span> <span class="n">child</span>
</span><span data-line="2141">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2142">            <span class="n">oldchild</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="2143">            <span class="ow">and</span> <span class="n">oldchild</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span data-line="2144">            <span class="ow">and</span> <span class="n">oldchild</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span>
</span><span data-line="2145">        <span class="p">):</span>
</span><span data-line="2146">            <span class="c1"># With lazy=None, there&#39;s no guarantee that the full collection is</span>
</span><span data-line="2147">            <span class="c1"># present when updating via a backref.</span>
</span><span data-line="2148">            <span class="n">old_state</span><span class="p">,</span> <span class="n">old_dict</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="2149">                <span class="n">instance_state</span><span class="p">(</span><span class="n">oldchild</span><span class="p">),</span>
</span><span data-line="2150">                <span class="n">instance_dict</span><span class="p">(</span><span class="n">oldchild</span><span class="p">),</span>
</span><span data-line="2151">            <span class="p">)</span>
</span><span data-line="2152">            <span class="n">impl</span> <span class="o">=</span> <span class="n">old_state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span data-line="2153">
</span><span data-line="2154">            <span class="c1"># tokens to test for a recursive loop.</span>
</span><span data-line="2155">            <span class="k">if</span> <span class="ow">not</span> <span class="n">impl</span><span class="o">.</span><span class="n">collection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">impl</span><span class="o">.</span><span class="n">dynamic</span><span class="p">:</span>
</span><span data-line="2156">                <span class="n">check_recursive_token</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">_replace_token</span>
</span><span data-line="2157">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2158">                <span class="n">check_recursive_token</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">_remove_token</span>
</span><span data-line="2159">
</span><span data-line="2160">            <span class="k">if</span> <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_recursive_token</span><span class="p">:</span>
</span><span data-line="2161">                <span class="n">impl</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
</span><span data-line="2162">                    <span class="n">old_state</span><span class="p">,</span>
</span><span data-line="2163">                    <span class="n">old_dict</span><span class="p">,</span>
</span><span data-line="2164">                    <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">(),</span>
</span><span data-line="2165">                    <span class="n">parent_impl</span><span class="o">.</span><span class="n">_append_token</span><span class="p">,</span>
</span><span data-line="2166">                    <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span><span class="p">,</span>
</span><span data-line="2167">                <span class="p">)</span>
</span><span data-line="2168">
</span><span data-line="2169">        <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2170">            <span class="n">child_state</span><span class="p">,</span> <span class="n">child_dict</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="2171">                <span class="n">instance_state</span><span class="p">(</span><span class="n">child</span><span class="p">),</span>
</span><span data-line="2172">                <span class="n">instance_dict</span><span class="p">(</span><span class="n">child</span><span class="p">),</span>
</span><span data-line="2173">            <span class="p">)</span>
</span><span data-line="2174">            <span class="n">child_impl</span> <span class="o">=</span> <span class="n">child_state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span data-line="2175">
</span><span data-line="2176">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2177">                <span class="n">initiator</span><span class="o">.</span><span class="n">parent_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">parent_token</span>
</span><span data-line="2178">                <span class="ow">and</span> <span class="n">initiator</span><span class="o">.</span><span class="n">parent_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">parent_token</span>
</span><span data-line="2179">            <span class="p">):</span>
</span><span data-line="2180">                <span class="n">_acceptable_key_err</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">child_impl</span><span class="p">)</span>
</span><span data-line="2181">
</span><span data-line="2182">            <span class="c1"># tokens to test for a recursive loop.</span>
</span><span data-line="2183">            <span class="n">check_append_token</span> <span class="o">=</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">_append_token</span>
</span><span data-line="2184">            <span class="n">check_bulk_replace_token</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="2185">                <span class="n">child_impl</span><span class="o">.</span><span class="n">_bulk_replace_token</span>
</span><span data-line="2186">                <span class="k">if</span> <span class="n">_is_collection_attribute_impl</span><span class="p">(</span><span class="n">child_impl</span><span class="p">)</span>
</span><span data-line="2187">                <span class="k">else</span> <span class="kc">None</span>
</span><span data-line="2188">            <span class="p">)</span>
</span><span data-line="2189">
</span><span data-line="2190">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2191">                <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_append_token</span>
</span><span data-line="2192">                <span class="ow">and</span> <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_bulk_replace_token</span>
</span><span data-line="2193">            <span class="p">):</span>
</span><span data-line="2194">                <span class="n">child_impl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span data-line="2195">                    <span class="n">child_state</span><span class="p">,</span>
</span><span data-line="2196">                    <span class="n">child_dict</span><span class="p">,</span>
</span><span data-line="2197">                    <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">(),</span>
</span><span data-line="2198">                    <span class="n">initiator</span><span class="p">,</span>
</span><span data-line="2199">                    <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span><span class="p">,</span>
</span><span data-line="2200">                <span class="p">)</span>
</span><span data-line="2201">        <span class="k">return</span> <span class="n">child</span>
</span><span data-line="2202">
</span><span data-line="2203">    <span class="k">def</span><span class="w"> </span><span class="nf">emit_backref_from_collection_append_event</span><span class="p">(</span>
</span><span data-line="2204">        <span class="n">state</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span data-line="2205">    <span class="p">):</span>
</span><span data-line="2206">        <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2207">            <span class="k">return</span>
</span><span data-line="2208">
</span><span data-line="2209">        <span class="n">child_state</span><span class="p">,</span> <span class="n">child_dict</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">child</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
</span><span data-line="2210">        <span class="n">child_impl</span> <span class="o">=</span> <span class="n">child_state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span data-line="2211">
</span><span data-line="2212">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2213">            <span class="n">initiator</span><span class="o">.</span><span class="n">parent_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">parent_token</span>
</span><span data-line="2214">            <span class="ow">and</span> <span class="n">initiator</span><span class="o">.</span><span class="n">parent_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">parent_token</span>
</span><span data-line="2215">        <span class="p">):</span>
</span><span data-line="2216">            <span class="n">_acceptable_key_err</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">child_impl</span><span class="p">)</span>
</span><span data-line="2217">
</span><span data-line="2218">        <span class="c1"># tokens to test for a recursive loop.</span>
</span><span data-line="2219">        <span class="n">check_append_token</span> <span class="o">=</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">_append_token</span>
</span><span data-line="2220">        <span class="n">check_bulk_replace_token</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="2221">            <span class="n">child_impl</span><span class="o">.</span><span class="n">_bulk_replace_token</span>
</span><span data-line="2222">            <span class="k">if</span> <span class="n">_is_collection_attribute_impl</span><span class="p">(</span><span class="n">child_impl</span><span class="p">)</span>
</span><span data-line="2223">            <span class="k">else</span> <span class="kc">None</span>
</span><span data-line="2224">        <span class="p">)</span>
</span><span data-line="2225">
</span><span data-line="2226">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2227">            <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_append_token</span>
</span><span data-line="2228">            <span class="ow">and</span> <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_bulk_replace_token</span>
</span><span data-line="2229">        <span class="p">):</span>
</span><span data-line="2230">            <span class="n">child_impl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span data-line="2231">                <span class="n">child_state</span><span class="p">,</span>
</span><span data-line="2232">                <span class="n">child_dict</span><span class="p">,</span>
</span><span data-line="2233">                <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">(),</span>
</span><span data-line="2234">                <span class="n">initiator</span><span class="p">,</span>
</span><span data-line="2235">                <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span><span class="p">,</span>
</span><span data-line="2236">            <span class="p">)</span>
</span><span data-line="2237">        <span class="k">return</span> <span class="n">child</span>
</span><span data-line="2238">
</span><span data-line="2239">    <span class="k">def</span><span class="w"> </span><span class="nf">emit_backref_from_collection_remove_event</span><span class="p">(</span>
</span><span data-line="2240">        <span class="n">state</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span data-line="2241">    <span class="p">):</span>
</span><span data-line="2242">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2243">            <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="2244">            <span class="ow">and</span> <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span data-line="2245">            <span class="ow">and</span> <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span>
</span><span data-line="2246">        <span class="p">):</span>
</span><span data-line="2247">            <span class="n">child_state</span><span class="p">,</span> <span class="n">child_dict</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="2248">                <span class="n">instance_state</span><span class="p">(</span><span class="n">child</span><span class="p">),</span>
</span><span data-line="2249">                <span class="n">instance_dict</span><span class="p">(</span><span class="n">child</span><span class="p">),</span>
</span><span data-line="2250">            <span class="p">)</span>
</span><span data-line="2251">            <span class="n">child_impl</span> <span class="o">=</span> <span class="n">child_state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span data-line="2252">
</span><span data-line="2253">            <span class="n">check_replace_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span>
</span><span data-line="2254">
</span><span data-line="2255">            <span class="c1"># tokens to test for a recursive loop.</span>
</span><span data-line="2256">            <span class="k">if</span> <span class="ow">not</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">collection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">dynamic</span><span class="p">:</span>
</span><span data-line="2257">                <span class="n">check_remove_token</span> <span class="o">=</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">_remove_token</span>
</span><span data-line="2258">                <span class="n">check_replace_token</span> <span class="o">=</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">_replace_token</span>
</span><span data-line="2259">                <span class="n">check_for_dupes_on_remove</span> <span class="o">=</span> <span class="n">uselist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parent_impl</span><span class="o">.</span><span class="n">dynamic</span>
</span><span data-line="2260">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2261">                <span class="n">check_remove_token</span> <span class="o">=</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">_remove_token</span>
</span><span data-line="2262">                <span class="n">check_replace_token</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="2263">                    <span class="n">child_impl</span><span class="o">.</span><span class="n">_bulk_replace_token</span>
</span><span data-line="2264">                    <span class="k">if</span> <span class="n">_is_collection_attribute_impl</span><span class="p">(</span><span class="n">child_impl</span><span class="p">)</span>
</span><span data-line="2265">                    <span class="k">else</span> <span class="kc">None</span>
</span><span data-line="2266">                <span class="p">)</span>
</span><span data-line="2267">                <span class="n">check_for_dupes_on_remove</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="2268">
</span><span data-line="2269">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2270">                <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_remove_token</span>
</span><span data-line="2271">                <span class="ow">and</span> <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_replace_token</span>
</span><span data-line="2272">            <span class="p">):</span>
</span><span data-line="2273">                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_for_dupes_on_remove</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">has_dupes</span><span class="p">(</span>
</span><span data-line="2274">                    <span class="c1"># when this event is called, the item is usually</span>
</span><span data-line="2275">                    <span class="c1"># present in the list, except for a pop() operation.</span>
</span><span data-line="2276">                    <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">parent_impl</span><span class="o">.</span><span class="n">key</span><span class="p">],</span>
</span><span data-line="2277">                    <span class="n">child</span><span class="p">,</span>
</span><span data-line="2278">                <span class="p">):</span>
</span><span data-line="2279">                    <span class="n">child_impl</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
</span><span data-line="2280">                        <span class="n">child_state</span><span class="p">,</span>
</span><span data-line="2281">                        <span class="n">child_dict</span><span class="p">,</span>
</span><span data-line="2282">                        <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">(),</span>
</span><span data-line="2283">                        <span class="n">initiator</span><span class="p">,</span>
</span><span data-line="2284">                        <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span><span class="p">,</span>
</span><span data-line="2285">                    <span class="p">)</span>
</span><span data-line="2286">
</span><span data-line="2287">    <span class="k">if</span> <span class="n">uselist</span><span class="p">:</span>
</span><span data-line="2288">        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
</span><span data-line="2289">            <span class="n">attribute</span><span class="p">,</span>
</span><span data-line="2290">            <span class="s2">&quot;append&quot;</span><span class="p">,</span>
</span><span data-line="2291">            <span class="n">emit_backref_from_collection_append_event</span><span class="p">,</span>
</span><span data-line="2292">            <span class="n">retval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2293">            <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2294">            <span class="n">include_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2295">        <span class="p">)</span>
</span><span data-line="2296">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="2297">        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
</span><span data-line="2298">            <span class="n">attribute</span><span class="p">,</span>
</span><span data-line="2299">            <span class="s2">&quot;set&quot;</span><span class="p">,</span>
</span><span data-line="2300">            <span class="n">emit_backref_from_scalar_set_event</span><span class="p">,</span>
</span><span data-line="2301">            <span class="n">retval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2302">            <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2303">            <span class="n">include_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2304">        <span class="p">)</span>
</span><span data-line="2305">    <span class="c1"># TODO: need coverage in test/orm/ of remove event</span>
</span><span data-line="2306">    <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
</span><span data-line="2307">        <span class="n">attribute</span><span class="p">,</span>
</span><span data-line="2308">        <span class="s2">&quot;remove&quot;</span><span class="p">,</span>
</span><span data-line="2309">        <span class="n">emit_backref_from_collection_remove_event</span><span class="p">,</span>
</span><span data-line="2310">        <span class="n">retval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2311">        <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2312">        <span class="n">include_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2313">    <span class="p">)</span>
</span><span data-line="2314">
</span><span data-line="2315">
</span><span data-line="2316"><span class="n">_NO_HISTORY</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;NO_HISTORY&quot;</span><span class="p">)</span>
</span><span data-line="2317"><span class="n">_NO_STATE_SYMBOLS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="nb">id</span><span class="p">(</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="n">NO_VALUE</span><span class="p">)])</span>
</span><span data-line="2318">
</span><span data-line="2319">
</span><span data-line="2320"><span class="k">class</span><span class="w"> </span><span class="nc">History</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
</span><span data-line="2321"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A 3-tuple of added, unchanged and deleted values,</span>
</span><span data-line="2322"><span class="sd">    representing the changes which have occurred on an instrumented</span>
</span><span data-line="2323"><span class="sd">    attribute.</span>
</span><span data-line="2324">
</span><span data-line="2325"><span class="sd">    The easiest way to get a :class:`.History` object for a particular</span>
</span><span data-line="2326"><span class="sd">    attribute on an object is to use the :func:`_sa.inspect` function::</span>
</span><span data-line="2327">
</span><span data-line="2328"><span class="sd">        from sqlalchemy import inspect</span>
</span><span data-line="2329">
</span><span data-line="2330"><span class="sd">        hist = inspect(myobject).attrs.myattribute.history</span>
</span><span data-line="2331">
</span><span data-line="2332"><span class="sd">    Each tuple member is an iterable sequence:</span>
</span><span data-line="2333">
</span><span data-line="2334"><span class="sd">    * ``added`` - the collection of items added to the attribute (the first</span>
</span><span data-line="2335"><span class="sd">      tuple element).</span>
</span><span data-line="2336">
</span><span data-line="2337"><span class="sd">    * ``unchanged`` - the collection of items that have not changed on the</span>
</span><span data-line="2338"><span class="sd">      attribute (the second tuple element).</span>
</span><span data-line="2339">
</span><span data-line="2340"><span class="sd">    * ``deleted`` - the collection of items that have been removed from the</span>
</span><span data-line="2341"><span class="sd">      attribute (the third tuple element).</span>
</span><span data-line="2342">
</span><span data-line="2343"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2344">
</span><span data-line="2345">    <span class="n">added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="2346">    <span class="n">unchanged</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="2347">    <span class="n">deleted</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="2348">
</span><span data-line="2349">    <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2350">        <span class="k">return</span> <span class="bp">self</span> <span class="o">!=</span> <span class="n">HISTORY_BLANK</span>
</span><span data-line="2351">
</span><span data-line="2352">    <span class="k">def</span><span class="w"> </span><span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2353"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this :class:`.History` has no changes</span>
</span><span data-line="2354"><span class="sd">        and no existing, unchanged state.</span>
</span><span data-line="2355">
</span><span data-line="2356"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2357">
</span><span data-line="2358">        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">added</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleted</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span><span class="p">)</span>
</span><span data-line="2359">
</span><span data-line="2360">    <span class="k">def</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="2361"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a collection of added + unchanged + deleted.&quot;&quot;&quot;</span>
</span><span data-line="2362">
</span><span data-line="2363">        <span class="k">return</span> <span class="p">(</span>
</span><span data-line="2364">            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">added</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deleted</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span data-line="2365">        <span class="p">)</span>
</span><span data-line="2366">
</span><span data-line="2367">    <span class="k">def</span><span class="w"> </span><span class="nf">non_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="2368"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a collection of added + unchanged.&quot;&quot;&quot;</span>
</span><span data-line="2369">
</span><span data-line="2370">        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">added</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span data-line="2371">
</span><span data-line="2372">    <span class="k">def</span><span class="w"> </span><span class="nf">non_added</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="2373"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a collection of unchanged + deleted.&quot;&quot;&quot;</span>
</span><span data-line="2374">
</span><span data-line="2375">        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deleted</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span data-line="2376">
</span><span data-line="2377">    <span class="k">def</span><span class="w"> </span><span class="nf">has_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2378"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this :class:`.History` has changes.&quot;&quot;&quot;</span>
</span><span data-line="2379">
</span><span data-line="2380">        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">added</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleted</span><span class="p">)</span>
</span><span data-line="2381">
</span><span data-line="2382">    <span class="k">def</span><span class="w"> </span><span class="nf">_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">added</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">deleted</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="2383">        <span class="k">return</span> <span class="n">History</span><span class="p">(</span>
</span><span data-line="2384">            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">added</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">added</span><span class="p">),</span>
</span><span data-line="2385">            <span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span><span class="p">,</span>
</span><span data-line="2386">            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deleted</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">deleted</span><span class="p">),</span>
</span><span data-line="2387">        <span class="p">)</span>
</span><span data-line="2388">
</span><span data-line="2389">    <span class="k">def</span><span class="w"> </span><span class="nf">as_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="2390">        <span class="k">return</span> <span class="n">History</span><span class="p">(</span>
</span><span data-line="2391">            <span class="p">[</span>
</span><span data-line="2392">                <span class="p">(</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span data-line="2393">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">added</span>
</span><span data-line="2394">            <span class="p">],</span>
</span><span data-line="2395">            <span class="p">[</span>
</span><span data-line="2396">                <span class="p">(</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span data-line="2397">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span>
</span><span data-line="2398">            <span class="p">],</span>
</span><span data-line="2399">            <span class="p">[</span>
</span><span data-line="2400">                <span class="p">(</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span data-line="2401">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleted</span>
</span><span data-line="2402">            <span class="p">],</span>
</span><span data-line="2403">        <span class="p">)</span>
</span><span data-line="2404">
</span><span data-line="2405">    <span class="nd">@classmethod</span>
</span><span data-line="2406">    <span class="k">def</span><span class="w"> </span><span class="nf">from_scalar_attribute</span><span class="p">(</span>
</span><span data-line="2407">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="2408">        <span class="n">attribute</span><span class="p">:</span> <span class="n">ScalarAttributeImpl</span><span class="p">,</span>
</span><span data-line="2409">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="2410">        <span class="n">current</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2411">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="2412">        <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">_NO_HISTORY</span><span class="p">)</span>
</span><span data-line="2413">
</span><span data-line="2414">        <span class="n">deleted</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="2415">
</span><span data-line="2416">        <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">_NO_HISTORY</span><span class="p">:</span>
</span><span data-line="2417">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span data-line="2418">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">(),</span> <span class="p">())</span>
</span><span data-line="2419">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2420">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">[</span><span class="n">current</span><span class="p">],</span> <span class="p">())</span>
</span><span data-line="2421">        <span class="c1"># don&#39;t let ClauseElement expressions here trip things up</span>
</span><span data-line="2422">        <span class="k">elif</span> <span class="p">(</span>
</span><span data-line="2423">            <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span>
</span><span data-line="2424">            <span class="ow">and</span> <span class="n">attribute</span><span class="o">.</span><span class="n">is_equal</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
</span><span data-line="2425">        <span class="p">):</span>
</span><span data-line="2426">            <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">[</span><span class="n">current</span><span class="p">],</span> <span class="p">())</span>
</span><span data-line="2427">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2428">            <span class="c1"># current convention on native scalars is to not</span>
</span><span data-line="2429">            <span class="c1"># include information</span>
</span><span data-line="2430">            <span class="c1"># about missing previous value in &quot;deleted&quot;, but</span>
</span><span data-line="2431">            <span class="c1"># we do include None, which helps in some primary</span>
</span><span data-line="2432">            <span class="c1"># key situations</span>
</span><span data-line="2433">            <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">original</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_NO_STATE_SYMBOLS</span><span class="p">:</span>
</span><span data-line="2434">                <span class="n">deleted</span> <span class="o">=</span> <span class="p">()</span>
</span><span data-line="2435">                <span class="c1"># indicate a &quot;del&quot; operation occurred when we don&#39;t have</span>
</span><span data-line="2436">                <span class="c1"># the previous value as: ([None], (), ())</span>
</span><span data-line="2437">                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_NO_STATE_SYMBOLS</span><span class="p">:</span>
</span><span data-line="2438">                    <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="2439">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2440">                <span class="n">deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">original</span><span class="p">]</span>
</span><span data-line="2441">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span data-line="2442">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">(),</span> <span class="n">deleted</span><span class="p">)</span>
</span><span data-line="2443">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2444">                <span class="k">return</span> <span class="bp">cls</span><span class="p">([</span><span class="n">current</span><span class="p">],</span> <span class="p">(),</span> <span class="n">deleted</span><span class="p">)</span>
</span><span data-line="2445">
</span><span data-line="2446">    <span class="nd">@classmethod</span>
</span><span data-line="2447">    <span class="k">def</span><span class="w"> </span><span class="nf">from_object_attribute</span><span class="p">(</span>
</span><span data-line="2448">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="2449">        <span class="n">attribute</span><span class="p">:</span> <span class="n">ScalarObjectAttributeImpl</span><span class="p">,</span>
</span><span data-line="2450">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="2451">        <span class="n">current</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2452">        <span class="n">original</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">_NO_HISTORY</span><span class="p">,</span>
</span><span data-line="2453">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="2454">        <span class="n">deleted</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="2455">
</span><span data-line="2456">        <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">_NO_HISTORY</span><span class="p">:</span>
</span><span data-line="2457">            <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">_NO_HISTORY</span><span class="p">)</span>
</span><span data-line="2458">
</span><span data-line="2459">        <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">_NO_HISTORY</span><span class="p">:</span>
</span><span data-line="2460">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span data-line="2461">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">(),</span> <span class="p">())</span>
</span><span data-line="2462">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2463">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">[</span><span class="n">current</span><span class="p">],</span> <span class="p">())</span>
</span><span data-line="2464">        <span class="k">elif</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">original</span> <span class="ow">and</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span data-line="2465">            <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">[</span><span class="n">current</span><span class="p">],</span> <span class="p">())</span>
</span><span data-line="2466">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2467">            <span class="c1"># current convention on related objects is to not</span>
</span><span data-line="2468">            <span class="c1"># include information</span>
</span><span data-line="2469">            <span class="c1"># about missing previous value in &quot;deleted&quot;, and</span>
</span><span data-line="2470">            <span class="c1"># to also not include None - the dependency.py rules</span>
</span><span data-line="2471">            <span class="c1"># ignore the None in any case.</span>
</span><span data-line="2472">            <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">original</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_NO_STATE_SYMBOLS</span> <span class="ow">or</span> <span class="n">original</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2473">                <span class="n">deleted</span> <span class="o">=</span> <span class="p">()</span>
</span><span data-line="2474">                <span class="c1"># indicate a &quot;del&quot; operation occurred when we don&#39;t have</span>
</span><span data-line="2475">                <span class="c1"># the previous value as: ([None], (), ())</span>
</span><span data-line="2476">                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_NO_STATE_SYMBOLS</span><span class="p">:</span>
</span><span data-line="2477">                    <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="2478">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2479">                <span class="n">deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">original</span><span class="p">]</span>
</span><span data-line="2480">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span data-line="2481">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">(),</span> <span class="n">deleted</span><span class="p">)</span>
</span><span data-line="2482">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2483">                <span class="k">return</span> <span class="bp">cls</span><span class="p">([</span><span class="n">current</span><span class="p">],</span> <span class="p">(),</span> <span class="n">deleted</span><span class="p">)</span>
</span><span data-line="2484">
</span><span data-line="2485">    <span class="nd">@classmethod</span>
</span><span data-line="2486">    <span class="k">def</span><span class="w"> </span><span class="nf">from_collection</span><span class="p">(</span>
</span><span data-line="2487">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="2488">        <span class="n">attribute</span><span class="p">:</span> <span class="n">CollectionAttributeImpl</span><span class="p">,</span>
</span><span data-line="2489">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="2490">        <span class="n">current</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2491">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="2492">        <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">_NO_HISTORY</span><span class="p">)</span>
</span><span data-line="2493">        <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span data-line="2494">            <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">(),</span> <span class="p">())</span>
</span><span data-line="2495">
</span><span data-line="2496">        <span class="n">current</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s2">&quot;_sa_adapter&quot;</span><span class="p">)</span>
</span><span data-line="2497">        <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span data-line="2498">            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="p">(),</span> <span class="p">())</span>
</span><span data-line="2499">        <span class="k">elif</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">_NO_HISTORY</span><span class="p">:</span>
</span><span data-line="2500">            <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="nb">list</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="p">())</span>
</span><span data-line="2501">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2502">            <span class="n">current_states</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="2503">                <span class="p">((</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span data-line="2504">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">current</span>
</span><span data-line="2505">            <span class="p">]</span>
</span><span data-line="2506">            <span class="n">original_states</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="2507">                <span class="p">((</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span data-line="2508">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">original</span>
</span><span data-line="2509">            <span class="p">]</span>
</span><span data-line="2510">
</span><span data-line="2511">            <span class="n">current_set</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">current_states</span><span class="p">)</span>
</span><span data-line="2512">            <span class="n">original_set</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">original_states</span><span class="p">)</span>
</span><span data-line="2513">
</span><span data-line="2514">            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
</span><span data-line="2515">                <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">current_states</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_set</span><span class="p">],</span>
</span><span data-line="2516">                <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">current_states</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">original_set</span><span class="p">],</span>
</span><span data-line="2517">                <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">original_states</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_set</span><span class="p">],</span>
</span><span data-line="2518">            <span class="p">)</span>
</span><span data-line="2519">
</span><span data-line="2520">
</span><span data-line="2521"><span class="n">HISTORY_BLANK</span> <span class="o">=</span> <span class="n">History</span><span class="p">((),</span> <span class="p">(),</span> <span class="p">())</span>
</span><span data-line="2522">
</span><span data-line="2523">
</span><span data-line="2524"><span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span data-line="2525">    <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span>
</span><span data-line="2526"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="2527"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a :class:`.History` record for the given object</span>
</span><span data-line="2528"><span class="sd">    and attribute key.</span>
</span><span data-line="2529">
</span><span data-line="2530"><span class="sd">    This is the **pre-flush** history for a given attribute, which is</span>
</span><span data-line="2531"><span class="sd">    reset each time the :class:`.Session` flushes changes to the</span>
</span><span data-line="2532"><span class="sd">    current database transaction.</span>
</span><span data-line="2533">
</span><span data-line="2534"><span class="sd">    .. note::</span>
</span><span data-line="2535">
</span><span data-line="2536"><span class="sd">        Prefer to use the :attr:`.AttributeState.history` and</span>
</span><span data-line="2537"><span class="sd">        :meth:`.AttributeState.load_history` accessors to retrieve the</span>
</span><span data-line="2538"><span class="sd">        :class:`.History` for instance attributes.</span>
</span><span data-line="2539">
</span><span data-line="2540">
</span><span data-line="2541"><span class="sd">    :param obj: an object whose class is instrumented by the</span>
</span><span data-line="2542"><span class="sd">      attributes package.</span>
</span><span data-line="2543">
</span><span data-line="2544"><span class="sd">    :param key: string attribute name.</span>
</span><span data-line="2545">
</span><span data-line="2546"><span class="sd">    :param passive: indicates loading behavior for the attribute</span>
</span><span data-line="2547"><span class="sd">       if the value is not already present.   This is a</span>
</span><span data-line="2548"><span class="sd">       bitflag attribute, which defaults to the symbol</span>
</span><span data-line="2549"><span class="sd">       :attr:`.PASSIVE_OFF` indicating all necessary SQL</span>
</span><span data-line="2550"><span class="sd">       should be emitted.</span>
</span><span data-line="2551">
</span><span data-line="2552"><span class="sd">    .. seealso::</span>
</span><span data-line="2553">
</span><span data-line="2554"><span class="sd">        :attr:`.AttributeState.history`</span>
</span><span data-line="2555">
</span><span data-line="2556"><span class="sd">        :meth:`.AttributeState.load_history` - retrieve history</span>
</span><span data-line="2557"><span class="sd">        using loader callables if the value is not locally present.</span>
</span><span data-line="2558">
</span><span data-line="2559"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2560">
</span><span data-line="2561">    <span class="k">return</span> <span class="n">get_state_history</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span data-line="2562">
</span><span data-line="2563">
</span><span data-line="2564"><span class="k">def</span><span class="w"> </span><span class="nf">get_state_history</span><span class="p">(</span>
</span><span data-line="2565">    <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span>
</span><span data-line="2566"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span data-line="2567">    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">get_history</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span data-line="2568">
</span><span data-line="2569">
</span><span data-line="2570"><span class="k">def</span><span class="w"> </span><span class="nf">has_parent</span><span class="p">(</span>
</span><span data-line="2571">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">obj</span><span class="p">:</span> <span class="n">_O</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">optimistic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="2572"><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2573"><span class="w">    </span><span class="sd">&quot;&quot;&quot;TODO&quot;&quot;&quot;</span>
</span><span data-line="2574">    <span class="n">manager</span> <span class="o">=</span> <span class="n">manager_of_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="2575">    <span class="n">state</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span data-line="2576">    <span class="k">return</span> <span class="n">manager</span><span class="o">.</span><span class="n">has_parent</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">optimistic</span><span class="p">)</span>
</span><span data-line="2577">
</span><span data-line="2578">
</span><span data-line="2579"><span class="k">def</span><span class="w"> </span><span class="nf">register_attribute</span><span class="p">(</span>
</span><span data-line="2580">    <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="2581">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="2582">    <span class="o">*</span><span class="p">,</span>
</span><span data-line="2583">    <span class="n">comparator</span><span class="p">:</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">PropComparator</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="2584">    <span class="n">parententity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="2585">    <span class="n">doc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2586">    <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2587"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="2588">    <span class="n">desc</span> <span class="o">=</span> <span class="n">register_descriptor</span><span class="p">(</span>
</span><span data-line="2589">        <span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">comparator</span><span class="o">=</span><span class="n">comparator</span><span class="p">,</span> <span class="n">parententity</span><span class="o">=</span><span class="n">parententity</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span>
</span><span data-line="2590">    <span class="p">)</span>
</span><span data-line="2591">    <span class="n">register_attribute_impl</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="2592">    <span class="k">return</span> <span class="n">desc</span>
</span><span data-line="2593">
</span><span data-line="2594">
</span><span data-line="2595"><span class="k">def</span><span class="w"> </span><span class="nf">register_attribute_impl</span><span class="p">(</span>
</span><span data-line="2596">    <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="2597">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="2598">    <span class="n">uselist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2599">    <span class="n">callable_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_LoaderCallable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2600">    <span class="n">useobject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2601">    <span class="n">impl_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">AttributeImpl</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2602">    <span class="n">backref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2603">    <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2604"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="2605">    <span class="n">manager</span> <span class="o">=</span> <span class="n">manager_of_class</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
</span><span data-line="2606">    <span class="k">if</span> <span class="n">uselist</span><span class="p">:</span>
</span><span data-line="2607">        <span class="n">factory</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;typecallable&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="2608">        <span class="n">typecallable</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">instrument_collection_class</span><span class="p">(</span>
</span><span data-line="2609">            <span class="n">key</span><span class="p">,</span> <span class="n">factory</span> <span class="ow">or</span> <span class="nb">list</span>
</span><span data-line="2610">        <span class="p">)</span>
</span><span data-line="2611">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="2612">        <span class="n">typecallable</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;typecallable&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="2613">
</span><span data-line="2614">    <span class="n">dispatch</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="2615">        <span class="s2">&quot;_Dispatch[QueryableAttribute[Any]]&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dispatch</span>
</span><span data-line="2616">    <span class="p">)</span>  <span class="c1"># noqa: E501</span>
</span><span data-line="2617">
</span><span data-line="2618">    <span class="n">impl</span><span class="p">:</span> <span class="n">AttributeImpl</span>
</span><span data-line="2619">
</span><span data-line="2620">    <span class="k">if</span> <span class="n">impl_class</span><span class="p">:</span>
</span><span data-line="2621">        <span class="c1"># TODO: this appears to be the WriteOnlyAttributeImpl /</span>
</span><span data-line="2622">        <span class="c1"># DynamicAttributeImpl constructor which is hardcoded</span>
</span><span data-line="2623">        <span class="n">impl</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Type[WriteOnlyAttributeImpl]&quot;</span><span class="p">,</span> <span class="n">impl_class</span><span class="p">)(</span>
</span><span data-line="2624">            <span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span data-line="2625">        <span class="p">)</span>
</span><span data-line="2626">    <span class="k">elif</span> <span class="n">uselist</span><span class="p">:</span>
</span><span data-line="2627">        <span class="n">impl</span> <span class="o">=</span> <span class="n">CollectionAttributeImpl</span><span class="p">(</span>
</span><span data-line="2628">            <span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">callable_</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">,</span> <span class="n">typecallable</span><span class="o">=</span><span class="n">typecallable</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span data-line="2629">        <span class="p">)</span>
</span><span data-line="2630">    <span class="k">elif</span> <span class="n">useobject</span><span class="p">:</span>
</span><span data-line="2631">        <span class="n">impl</span> <span class="o">=</span> <span class="n">ScalarObjectAttributeImpl</span><span class="p">(</span>
</span><span data-line="2632">            <span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">callable_</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span data-line="2633">        <span class="p">)</span>
</span><span data-line="2634">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="2635">        <span class="n">impl</span> <span class="o">=</span> <span class="n">ScalarAttributeImpl</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">callable_</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="2636">
</span><span data-line="2637">    <span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span> <span class="o">=</span> <span class="n">impl</span>
</span><span data-line="2638">
</span><span data-line="2639">    <span class="k">if</span> <span class="n">backref</span><span class="p">:</span>
</span><span data-line="2640">        <span class="n">backref_listeners</span><span class="p">(</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">backref</span><span class="p">,</span> <span class="n">uselist</span><span class="p">)</span>
</span><span data-line="2641">
</span><span data-line="2642">    <span class="n">manager</span><span class="o">.</span><span class="n">post_configure_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="2643">    <span class="k">return</span> <span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="2644">
</span><span data-line="2645">
</span><span data-line="2646"><span class="k">def</span><span class="w"> </span><span class="nf">register_descriptor</span><span class="p">(</span>
</span><span data-line="2647">    <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="2648">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="2649">    <span class="o">*</span><span class="p">,</span>
</span><span data-line="2650">    <span class="n">comparator</span><span class="p">:</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">PropComparator</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="2651">    <span class="n">parententity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="2652">    <span class="n">doc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2653"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="2654">    <span class="n">manager</span> <span class="o">=</span> <span class="n">manager_of_class</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
</span><span data-line="2655">
</span><span data-line="2656">    <span class="n">descriptor</span> <span class="o">=</span> <span class="n">InstrumentedAttribute</span><span class="p">(</span>
</span><span data-line="2657">        <span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">comparator</span><span class="o">=</span><span class="n">comparator</span><span class="p">,</span> <span class="n">parententity</span><span class="o">=</span><span class="n">parententity</span>
</span><span data-line="2658">    <span class="p">)</span>
</span><span data-line="2659">
</span><span data-line="2660">    <span class="n">descriptor</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>  <span class="c1"># type: ignore</span>
</span><span data-line="2661">
</span><span data-line="2662">    <span class="n">manager</span><span class="o">.</span><span class="n">instrument_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">)</span>
</span><span data-line="2663">    <span class="k">return</span> <span class="n">descriptor</span>
</span><span data-line="2664">
</span><span data-line="2665">
</span><span data-line="2666"><span class="k">def</span><span class="w"> </span><span class="nf">unregister_attribute</span><span class="p">(</span><span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2667">    <span class="n">manager_of_class</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span><span class="o">.</span><span class="n">uninstrument_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="2668">
</span><span data-line="2669">
</span><span data-line="2670"><span class="k">def</span><span class="w"> </span><span class="nf">init_collection</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span>
</span><span data-line="2671"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a collection attribute and return the collection adapter.</span>
</span><span data-line="2672">
</span><span data-line="2673"><span class="sd">    This function is used to provide direct access to collection internals</span>
</span><span data-line="2674"><span class="sd">    for a previously unloaded attribute.  e.g.::</span>
</span><span data-line="2675">
</span><span data-line="2676"><span class="sd">        collection_adapter = init_collection(someobject, &quot;elements&quot;)</span>
</span><span data-line="2677"><span class="sd">        for elem in values:</span>
</span><span data-line="2678"><span class="sd">            collection_adapter.append_without_event(elem)</span>
</span><span data-line="2679">
</span><span data-line="2680"><span class="sd">    For an easier way to do the above, see</span>
</span><span data-line="2681"><span class="sd">    :func:`~sqlalchemy.orm.attributes.set_committed_value`.</span>
</span><span data-line="2682">
</span><span data-line="2683"><span class="sd">    :param obj: a mapped object</span>
</span><span data-line="2684">
</span><span data-line="2685"><span class="sd">    :param key: string attribute name where the collection is located.</span>
</span><span data-line="2686">
</span><span data-line="2687"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2688">    <span class="n">state</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span data-line="2689">    <span class="n">dict_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span>
</span><span data-line="2690">    <span class="k">return</span> <span class="n">init_state_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="2691">
</span><span data-line="2692">
</span><span data-line="2693"><span class="k">def</span><span class="w"> </span><span class="nf">init_state_collection</span><span class="p">(</span>
</span><span data-line="2694">    <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="2695"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span>
</span><span data-line="2696"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a collection attribute and return the collection adapter.</span>
</span><span data-line="2697">
</span><span data-line="2698"><span class="sd">    Discards any existing collection which may be there.</span>
</span><span data-line="2699">
</span><span data-line="2700"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2701">    <span class="n">attr</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span data-line="2702">
</span><span data-line="2703">    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="2704">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">HasCollectionAdapter</span><span class="p">)</span>
</span><span data-line="2705">
</span><span data-line="2706">    <span class="n">old</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># discard old collection</span>
</span><span data-line="2707">    <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2708">        <span class="n">old_collection</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">_sa_adapter</span>
</span><span data-line="2709">        <span class="n">attr</span><span class="o">.</span><span class="n">_dispose_previous_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">old_collection</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span data-line="2710">
</span><span data-line="2711">    <span class="n">user_data</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">_default_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span data-line="2712">    <span class="n">adapter</span><span class="p">:</span> <span class="n">CollectionAdapter</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span>
</span><span data-line="2713">        <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_NO_FETCH</span>
</span><span data-line="2714">    <span class="p">)</span>
</span><span data-line="2715">    <span class="n">adapter</span><span class="o">.</span><span class="n">_reset_empty</span><span class="p">()</span>
</span><span data-line="2716">
</span><span data-line="2717">    <span class="k">return</span> <span class="n">adapter</span>
</span><span data-line="2718">
</span><span data-line="2719">
</span><span data-line="2720"><span class="k">def</span><span class="w"> </span><span class="nf">set_committed_value</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2721"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the value of an attribute with no history events.</span>
</span><span data-line="2722">
</span><span data-line="2723"><span class="sd">    Cancels any previous history present.  The value should be</span>
</span><span data-line="2724"><span class="sd">    a scalar value for scalar-holding attributes, or</span>
</span><span data-line="2725"><span class="sd">    an iterable for any collection-holding attribute.</span>
</span><span data-line="2726">
</span><span data-line="2727"><span class="sd">    This is the same underlying method used when a lazy loader</span>
</span><span data-line="2728"><span class="sd">    fires off and loads additional data from the database.</span>
</span><span data-line="2729"><span class="sd">    In particular, this method can be used by application code</span>
</span><span data-line="2730"><span class="sd">    which has loaded additional attributes or collections through</span>
</span><span data-line="2731"><span class="sd">    separate queries, which can then be attached to an instance</span>
</span><span data-line="2732"><span class="sd">    as though it were part of its original loaded state.</span>
</span><span data-line="2733">
</span><span data-line="2734"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2735">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="2736">    <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">set_committed_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="2737">
</span><span data-line="2738">
</span><span data-line="2739"><span class="k">def</span><span class="w"> </span><span class="nf">set_attribute</span><span class="p">(</span>
</span><span data-line="2740">    <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
</span><span data-line="2741">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="2742">    <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2743">    <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2744"><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2745"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the value of an attribute, firing history events.</span>
</span><span data-line="2746">
</span><span data-line="2747"><span class="sd">    This function may be used regardless of instrumentation</span>
</span><span data-line="2748"><span class="sd">    applied directly to the class, i.e. no descriptors are required.</span>
</span><span data-line="2749"><span class="sd">    Custom attribute management schemes will need to make usage</span>
</span><span data-line="2750"><span class="sd">    of this method to establish attribute state as understood</span>
</span><span data-line="2751"><span class="sd">    by SQLAlchemy.</span>
</span><span data-line="2752">
</span><span data-line="2753"><span class="sd">    :param instance: the object that will be modified</span>
</span><span data-line="2754">
</span><span data-line="2755"><span class="sd">    :param key: string name of the attribute</span>
</span><span data-line="2756">
</span><span data-line="2757"><span class="sd">    :param value: value to assign</span>
</span><span data-line="2758">
</span><span data-line="2759"><span class="sd">    :param initiator: an instance of :class:`.Event` that would have</span>
</span><span data-line="2760"><span class="sd">     been propagated from a previous event listener.  This argument</span>
</span><span data-line="2761"><span class="sd">     is used when the :func:`.set_attribute` function is being used within</span>
</span><span data-line="2762"><span class="sd">     an existing event listening function where an :class:`.Event` object</span>
</span><span data-line="2763"><span class="sd">     is being supplied; the object may be used to track the origin of the</span>
</span><span data-line="2764"><span class="sd">     chain of events.</span>
</span><span data-line="2765">
</span><span data-line="2766"><span class="sd">     .. versionadded:: 1.2.3</span>
</span><span data-line="2767">
</span><span data-line="2768"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2769">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="2770">    <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">)</span>
</span><span data-line="2771">
</span><span data-line="2772">
</span><span data-line="2773"><span class="k">def</span><span class="w"> </span><span class="nf">get_attribute</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="2774"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the value of an attribute, firing any callables required.</span>
</span><span data-line="2775">
</span><span data-line="2776"><span class="sd">    This function may be used regardless of instrumentation</span>
</span><span data-line="2777"><span class="sd">    applied directly to the class, i.e. no descriptors are required.</span>
</span><span data-line="2778"><span class="sd">    Custom attribute management schemes will need to make usage</span>
</span><span data-line="2779"><span class="sd">    of this method to make usage of attribute state as understood</span>
</span><span data-line="2780"><span class="sd">    by SQLAlchemy.</span>
</span><span data-line="2781">
</span><span data-line="2782"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2783">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="2784">    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span data-line="2785">
</span><span data-line="2786">
</span><span data-line="2787"><span class="k">def</span><span class="w"> </span><span class="nf">del_attribute</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2788"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete the value of an attribute, firing history events.</span>
</span><span data-line="2789">
</span><span data-line="2790"><span class="sd">    This function may be used regardless of instrumentation</span>
</span><span data-line="2791"><span class="sd">    applied directly to the class, i.e. no descriptors are required.</span>
</span><span data-line="2792"><span class="sd">    Custom attribute management schemes will need to make usage</span>
</span><span data-line="2793"><span class="sd">    of this method to establish attribute state as understood</span>
</span><span data-line="2794"><span class="sd">    by SQLAlchemy.</span>
</span><span data-line="2795">
</span><span data-line="2796"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2797">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="2798">    <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span data-line="2799">
</span><span data-line="2800">
</span><span data-line="2801"><span class="k">def</span><span class="w"> </span><span class="nf">flag_modified</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2802"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mark an attribute on an instance as &#39;modified&#39;.</span>
</span><span data-line="2803">
</span><span data-line="2804"><span class="sd">    This sets the &#39;modified&#39; flag on the instance and</span>
</span><span data-line="2805"><span class="sd">    establishes an unconditional change event for the given attribute.</span>
</span><span data-line="2806"><span class="sd">    The attribute must have a value present, else an</span>
</span><span data-line="2807"><span class="sd">    :class:`.InvalidRequestError` is raised.</span>
</span><span data-line="2808">
</span><span data-line="2809"><span class="sd">    To mark an object &quot;dirty&quot; without referring to any specific attribute</span>
</span><span data-line="2810"><span class="sd">    so that it is considered within a flush, use the</span>
</span><span data-line="2811"><span class="sd">    :func:`.attributes.flag_dirty` call.</span>
</span><span data-line="2812">
</span><span data-line="2813"><span class="sd">    .. seealso::</span>
</span><span data-line="2814">
</span><span data-line="2815"><span class="sd">        :func:`.attributes.flag_dirty`</span>
</span><span data-line="2816">
</span><span data-line="2817"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2818">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="2819">    <span class="n">impl</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span data-line="2820">    <span class="n">impl</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">impl</span><span class="o">.</span><span class="n">_modified_token</span><span class="p">)</span>
</span><span data-line="2821">    <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">impl</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="n">is_userland</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="2822">
</span><span data-line="2823">
</span><span data-line="2824"><span class="k">def</span><span class="w"> </span><span class="nf">flag_dirty</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2825"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mark an instance as &#39;dirty&#39; without any specific attribute mentioned.</span>
</span><span data-line="2826">
</span><span data-line="2827"><span class="sd">    This is a special operation that will allow the object to travel through</span>
</span><span data-line="2828"><span class="sd">    the flush process for interception by events such as</span>
</span><span data-line="2829"><span class="sd">    :meth:`.SessionEvents.before_flush`.   Note that no SQL will be emitted in</span>
</span><span data-line="2830"><span class="sd">    the flush process for an object that has no changes, even if marked dirty</span>
</span><span data-line="2831"><span class="sd">    via this method.  However, a :meth:`.SessionEvents.before_flush` handler</span>
</span><span data-line="2832"><span class="sd">    will be able to see the object in the :attr:`.Session.dirty` collection and</span>
</span><span data-line="2833"><span class="sd">    may establish changes on it, which will then be included in the SQL</span>
</span><span data-line="2834"><span class="sd">    emitted.</span>
</span><span data-line="2835">
</span><span data-line="2836"><span class="sd">    .. versionadded:: 1.2</span>
</span><span data-line="2837">
</span><span data-line="2838"><span class="sd">    .. seealso::</span>
</span><span data-line="2839">
</span><span data-line="2840"><span class="sd">        :func:`.attributes.flag_modified`</span>
</span><span data-line="2841">
</span><span data-line="2842"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2843">
</span><span data-line="2844">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="2845">    <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="n">is_userland</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, Alexander Matveev</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials">
<a href="https://github.com/bizoxe/iron-track" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../../_static/shibuya.js?v=c1cf1a6b"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";

const defaultStyle = document.createElement('style');
defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}
`;
document.head.appendChild(defaultStyle);

const fullscreenStyle = document.createElement('style');
fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
document.head.appendChild(fullscreenStyle);

// Detect if page has dark background
const isDarkTheme = () => {
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness < 128;
    }
    return false;
};

const load = async () => {
    await mermaid.run();

    const all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(load, 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(load, 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(load, 200);
        return;
    }

    const darkTheme = isDarkTheme();

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    const modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen"></button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    const modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    let previousScrollOffset = [window.scrollX, window.scrollY];

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    const allButtons = [];

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = '';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        container.appendChild(fullscreenBtn);
        allButtons.push(fullscreenBtn);
    });

    // Update theme classes when theme changes
    const updateTheme = () => {
        const dark = isDarkTheme();
        allButtons.forEach(btn => {
            if (dark) {
                btn.classList.add('dark-theme');
            } else {
                btn.classList.remove('dark-theme');
            }
        });
        if (dark) {
            modal.classList.add('dark-theme');
            modalContent.classList.add('dark-theme');
            closeBtn.classList.add('dark-theme');
        } else {
            modal.classList.remove('dark-theme');
            modalContent.classList.remove('dark-theme');
            closeBtn.classList.remove('dark-theme');
        }
    };

    // Watch for theme changes
    const observer = new MutationObserver(updateTheme);
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style']
    });
};

window.addEventListener("load", load);
</script></body>
</html>